

{% load static%}
{% block content %}

<!DOCTYPE html>
<html lang="zh-Hant" >
    <head>
        <meta name="viewport" maximum-scale=1.0, user-scalable=0 content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    
        <!-- CSS only -->
        <link rel="stylesheet" href="{% static 'css_js/bootstrap.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/font-awesome.min.css' %}">
    
    
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap.css' %}">
    
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-grid.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-grid.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-grid.rtl.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-grid.rtl.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-reboot.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-reboot.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-reboot.rtl.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-reboot.rtl.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-utilities.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-utilities.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-utilities.rtl.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.1.3-dist/css/bootstrap-utilities.rtl.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/loaders.css-master/loaders.css' %}">
        <!-- JS, Popper.js, and jQuery -->
        <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="{% static 'css_js/jquery-3.6.0.min.js' %}"></script>
        <script src="{% static 'css_js/popper.min.js' %}"></script>
        <script src="{% static 'css_js/bootstrap-5.1.3-dist/js/bootstrap.min.js' %}"></script>

        <script src="{% static 'css_js/key_forbidden.js' %}"></script>
        <script src="{% static 'css_js/popper.min.js' %}"></script>
        <script src="{% static 'css_js/loaders.css-master/loaders.css.js' %}"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.15.1/powerbi.min.js" integrity="sha512-OWIl8Xrlo8yQjWN5LcMz5SIgNnzcJqeelChqPMIeQGnEFJ4m1fWWn668AEXBrKlsuVbvDebTUJGLRCtRCCiFkg==" crossorigin="anonymous"></script>
        
        <link href="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.css" rel="stylesheet">

        <script src="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.js"></script>
        <title>PowerBI</title>
        </head>

<style>
    @import url(https://fonts.googleapis.com/earlyaccess/notosanstc.css);
    ::-webkit-scrollbar {
        width: 10px;
        height:10px
      }
      
      /* Track */
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px 10px 10px 10px;
      }
  
      /* Handle */
      ::-webkit-scrollbar-thumb {
        background: #141D66;
        border-radius: 0;
      }
  
      /* Handle on hover */
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    
    html { overflow: hidden; }
    #report-container{position:absolute;top:50px;left:0px;height:calc(100% - 58px);padding:0px;margin:0px}
    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #FFFFFF; --border-radius: 10px; --formwidth: 400px; --form-mob-width: 500px; }
    
    #mycheckbox { position: absolute; left: -9999px; }
    .feedback-label,.form { position: fixed; top: 55px; left: 0; height:calc(100% - 55px)}
    .feedback-label { transform-origin: top right; transform:  translate(0%, 0%); z-index: 10; }
    .form {padding:10px;background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--formwidth); transform: translate(-100%, 0%); overflow: auto;overflow-x:auto; background-color: var(--form); z-index: 10; }
    .feedback-label { border-radius: var(--border-radius); }
    .feedback-label { padding: 5px 10px; border-radius:0 var(--border-radius)    var(--border-radius) 0; }
    .feedback-label { writing-mode: vertical-rl;background: #e78632; color: white; }
    .feedback-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #mycheckbox:checked + .feedback-label { background: #e78632; transform:  translate(calc((var(--formwidth) ) * 1),0%)}
    #mycheckbox:checked ~ .form { transform: translate(0, 0%);z-index: 10;}
    .feedback-label, .form { transition: all 0.35s ease-in-out; }
    .form{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    .list-group-item_custom{border:0px;font-weight:bold;font-size:14pt ;font-family: 'Noto Sans TC', sans-serif;background:None;padding-right:0px;padding-bottom:5px}
    .list-group_custom{background:None;list-style-type: None}
    .list-group-item-action:hover{opacity: 0.5;color:red;cursor: pointer; }
    .title{display: list-item;width:100%}
    #powerbi_area{position:fixed;top:0px;width:calc(100% - 60px);height:calc(100% + 80px);margin-top:-35px;left:60px}
    .tableWrap{position:absolute;top:105px;margin:50px;width:calc(100% - 100px);overflow-y: auto;height:calc(100% - 255px);}
    tbody{overflow-y:auto;}
    .add{position:absolute;height:50px;top:95px;margin-left:50px;margin-right:50px;width:calc(100% - 100px)}
    .modal-backdrop.show{opacity: 0}
    .modalItem{width:100%}
    .modalSmallItem{margin-right:10px;-webkit-user-select:none;-moz-user-select:none;-o-user-select:none;user-select:none;}
    #tableWrap{z-index:10}
    .ul-list-style_1{list-style-type:circle}
    .ul-list-style_2{list-style-type:disc}
    .ul-list-style_3{list-style-type:square}
</style>
<script>

$(document).ready(function (e) {
    get_powerBI_list()
})

function powerBI(workspaceID,reportID){
    $("#powerbi_area").empty()
    $("#powerbi_area").append(`
        <section id="report-container"  class="embed-container" style="width:100%;">
        </section>
        <section class="error-container m-5">
        </section>
    `)

    var reportContainer = $("#report-container").get(0);

    // Initialize iframe for embedding report
    powerbi.bootstrap(reportContainer, { type: "report" });

    var models = window["powerbi-client"].models;
    var reportLoadConfig = {
        type: "report",
        tokenType: models.TokenType.Embed,

        // Enable this setting to remove gray shoulders from embedded report
        // settings: {
        //     background: models.BackgroundType.Transparent
        // }
    };
    $.ajax({
        type: "POST",
        url: '{% url "PowerBI:get_embed_info" %}',
        data:{
            'workspaceID':workspaceID,
            'reportID':reportID,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        dataType: "json",
        success: function (response) {
            embedData = $.parseJSON(response.data);
            reportLoadConfig.accessToken = embedData.accessToken;
            // You can embed different reports as per your need
            reportLoadConfig.embedUrl = embedData.reportConfig[0].embedUrl;

            // Use the token expiry to regenerate Embed token for seamless end user experience
            // Refer https://aka.ms/RefreshEmbedToken
            tokenExpiry = embedData.tokenExpiry;

            // Embed Power BI report when Access token and Embed URL are available
            var report = powerbi.embed(reportContainer, reportLoadConfig);

            // Triggers when a report schema is successfully loaded
            report.on("loaded", function () {
                console.log("Report load successful")
            });

            // Triggers when a report is successfully embedded in UI
            report.on("rendered", function () {
                console.log("Report render successful")
            });

            // Clear any other error handler event
            report.off("error");

            // Below patch of code is for handling errors that occur during embedding
            report.on("error", function (event) {
                var errorMsg = event.detail;

                // Use errorMsg variable to log error in any destination of choice
                console.error(errorMsg);
                return;
            });
        },
        error: function (err) {
            Swal.fire({
                title: '',
                html: '載入失敗，請聯繫工作人員',
                icon: 'error',
                showConfirmButton: true,
            })
        }
    });
}

function get_dashboard(){
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:get_dashboard" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#dashboard_menu').empty()
            for(let i=0; i<response.workspaceID.length; i++){
                $('#dashboard_menu').append(`<option data-workspaceID=${response.workspaceID[i]} data-reportID=${response.reportID[i]} >${response.dashboard_name[i]}</option>`)
            }
            powerBI()
        }
    })
}

function get_powerBI_list(){
    let username = '{{user.username}}'
    
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:getlist" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#bi_list').empty()
            $('#bi_list').append(response.listObject)
        }
    })
}

function getBI(){
    let workspaceID = $(event.target).attr('data-workspaceID')
    let reportID = $(event.target).attr('data-reportID')
    $('#mycheckbox').prop('checked',false)
    powerBI(workspaceID,reportID)
}

function getPowerbiPermissions(){
    $('#powerbi_area').empty()
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:getPowerbiPermissions" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#powerbi_area').append('<button type="button" class="btn btn-primary add" data-bs-toggle="modal" data-bs-target="#addModal" onclick="addModalContent()">新增</button>')
            var permissionsObject = `<div class="tableWrap"><table class="table table-striped" >
                <thead class="table-success">
                    <tr>
                        <th>編輯</th>
                        <th data-sortable="true" data-sorter="alphanum">名稱</th>
                        <th>啟用</th>
                    </tr>
                </thead><tbody>`
            for(let i=0;i<response.name.length;i++){
                permissionsObject += `<tr><td>${response.permissionGroup[i]}</td><td>${response.name[i]}</td><td>${response.status[i]}</td></tr>`
            }
            permissionsObject += '</tbody></table></div>'
            $('#powerbi_area').append(permissionsObject)
        }
    })
}

function addModalContent(){
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:getPowerbiPermissions" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            let addPermissionGroupNameParentObject=''
            for(let i=0;i<response.name.length;i++){
                addPermissionGroupNameParentObject += `<option value="${response.permissionGroup[i]}">${response.name[i]}</option>`
            }
            $('#permissionsPanel').empty()
            $('#permissionsPanel').append(`
            <label class="modalItem">群組名稱:</label><input type="text" id='addPermissionGroupName' class="form-control">
            <label class="modalItem">群組隸屬:</label><select id='addPermissionGroupNameParent' class="form-select">${addPermissionGroupNameParentObject}</select>
            <label class="modalItem">狀態: </label><select id='addStauts' class="form-select"><option value=1>啟用</option><option value=0>不啟用</option></select>
            `)
            $('#exampleModalLabel').html('群組權限編輯')
            $('#submit').attr('onclick','addPowerbiPermissions()')
        }
    })
}

function addPowerbiPermissions(){
    let name = $('#addPermissionGroupName').val()
    let addPermissionGroupNameParent = $('#addPermissionGroupNameParent').val()
    let status = $('#addStauts').val()
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:addPowerbiPermissions" %}', // this is the mapping between the url and view
        data:{
            'name':name,
            'status':status,
            'addPermissionGroupNameParent':addPermissionGroupNameParent,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            powerbiPermissions()
        }
    })
}

function getpowerbiAccountPermissions(){
    $('#powerbi_area').empty()
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:getpowerbiAccountPermissions" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            let tableFrame=`
            <div class="tableWrap">
                <table id='sortTable' class="table table-striped" data-toggle="table"  data-pagination="true" data-search="true">
                </table>
            </div>
            `
            $('#powerbi_area').append(tableFrame)
            let data = []
            for(let i=0;i<response.username.length;i++){
                data.push({
                    id:`<button type=\'button\' class=\'btn btn-primary\' data-bs-toggle=\'modal\'' data-bs-target=\'#addModal\' id=\'editButton${i}\'
                    onclick="editAccountPermissionContent('${response.username[i]}','${response.permissionsGroup[i]}')
                    ">編輯</button>`,
                    column_username:`${response.username[i]}`,
                    column_permissionGroup:`${response.permissionsGroupName[i]}`,
                })
            }
            $('#sortTable').bootstrapTable({
                columns: [{
                    field: 'state',
                    checkbox: true,
                    align: 'center',
                    valign: 'middle'
                },{
                    field: 'id',
                    title: '編輯',
                    
                }, {
                    field: 'column_username',
                    title: '使用者名稱',
                    sortable:true,
                }, {
                    field: 'column_permissionGroup',
                    title: '權限群組',
                    sortable:true,
                }],
                data:data
            })
        }
    })
}
function getIdSelections() {
    return $.map($('#sortTable').bootstrapTable('getSelections'), function (row) {
      return row.column_username
    })
}

function editAccountPermissionContent(username,permissionsGroup){
    $('#permissionsPanel').empty()
    if($('[name="btSelectItem"]:checked').length!=0){
        username = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').next('td').html()}).get()
    }

    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:getPowerbiPermissions" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            var permissionsObject = ''
            for(let i=0;i<response.name.length;i++){
                permissionsObject += `<option value="${response.permissionGroup[i]}">${response.name[i]}</option>`
            }
            $('#permissionsPanel').append(`
                <label class="modalItem">使用者名稱:</label><input type="text" id='editUsername' class="form-control" disabled value=${username}>
                <label class="modalItem">權限群組: </label><select id='editPermission' class="form-select">${permissionsObject}</select>
            `)
            if(permissionsGroup !='null'){
                $('#editPermission').val(permissionsGroup)
            }
        }
    })
    $('#exampleModalLabel').html('帳號權限')
    $('#submit').attr('onclick','editAccountPermission()')
}

function editAccountPermission(){
    let editUsername = $('#editUsername').val().split(',')
    let editPermission = $('#editPermission').val()
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:editAccountPermission" %}', // this is the mapping between the url and view
        data:{
            'editUsername':editUsername,
            'editPermission':editPermission,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            getpowerbiAccountPermissions()
        }
    })
}


function getPowerbiReportPermission(){
    $('#powerbi_area').empty()
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:getPowerbiReportPermission" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#powerbi_area').append('<button type="button" class="btn btn-primary add" data-bs-toggle="modal" data-bs-target="#addModal" onclick="addBIReportContent()">新增</button>')
            let tableFrame=`
            <div class="tableWrap">
                <table id='sortTable' class="table table-striped" data-toggle="table"  data-pagination="true" data-search="true">
                </table>
            </div>
            `
            $('#powerbi_area').append(tableFrame)
            let data = []
            for(let i=0;i<response.code.length;i++){
                data.push({
                    id:`<button type=\'button\' class=\'btn btn-primary\' data-bs-toggle=\'modal\'' data-bs-target=\'#addModal\' id=\'editButton${i}\' onclick="editBIReport('${response.code[i]}','${response.BI_name[i]}','${response.workspaceID[i]}','${response.reportID[i]}','${response.status[i]}','${response.parent_node[i]}','${response.sort[i]}')"
                     data-code=\'${response.code[i]}\' data-BI_name='${response.BI_name[i]}' data-workspaceID='${response.workspaceID[i]}' data-reportID='${response.reportID[i]}' data-status='${response.status[i]}' data-parent_node='${response.parent_node[i]}' data-sort='${response.sort[i]}'
                    >編輯</button>
                    <button type=\'button\' class=\'btn btn-primary\' data-bs-toggle=\'modal\'' data-bs-target=\'#addModal\' id=\'deleteButton${i}\' onclick="deleteBIReportContent('${response.code[i]}','${response.BI_name[i]}','${response.workspaceID[i]}','${response.reportID[i]}','${response.status[i]}','${response.parent_node[i]}','${response.sort[i]}')"
                     data-code='${response.code[i]}' data-BI_name='${response.BI_name[i]}' data-workspaceID='${response.workspaceID[i]}' data-reportID='${response.reportID[i]}' data-status='${response.status[i]}' data-parent_node='${response.parent_node[i]}' data-sort='${response.sort[i]}'
                    >刪除</button>
                    `,
                    column_code:`${response.code[i]}`,
                    column_name:`${response.BI_name[i]}`,
                    column_status:`${response.status[i]}`,
                })
            }
            $('#sortTable').bootstrapTable({
                columns: [{
                    field: 'state',
                    checkbox: true,
                    align: 'center',
                    valign: 'middle'
                },{
                    field: 'id',
                    title: '編輯',
                }, {
                    field: 'column_code',
                    title: '選單代碼',
                    sortable:true,
                }, {
                    field: 'column_name',
                    title: '選單名稱',
                    sortable:true,
                }, {
                    field: 'column_status',
                    title: '狀態',
                    sortable:true,
                }],
                data:data
            })
        }
    })
}

function BIReportContent(func){
    $('#permissionsPanel').empty()
    $('#permissionsPanel').append(`
        <label class="modalItem">選單代碼:<input type="text" id='editBIReport_code' class="form-control"></label>
        <label class="modalItem">選單名稱:<input type="text" id='editBIReport_BIName' class="form-control"></label>
        <label class="modalItem">工作區ID:<input type="text" id='editBIReport_workspaceID' class="form-control"></label>
        <label class="modalItem">報表ID:<input type="text" id='editBIReport_reportID' class="form-control"></label>
        <label class="modalItem">狀態: <select id='editBIReport_status' class="form-select"><option value=1>啟用</option><option value=0>不啟用</option></select></label>
        <label class="modalItem">父節點:<input type="text" id='editBIReport_parent_node' class="form-control"></label>
        <label class="modalItem">排序:<input type="text" id='editBIReport_sort' class="form-control"></label>
        <label class="modalItem">權限群組:</label><div id='permissionsGroup'></div>
    `)
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:getPowerbiPermissions" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            for(let i=0;i<response.name.length;i++){
                permissionsObject = `<label class="modalSmallItem">${response.name[i]}<input type='checkbox' class='addPowerBI_PermissionGroup' id='${response.name[i]}' value='${response.permissionGroup[i]}'></label>`
                $('#permissionsGroup').append(permissionsObject)
            }
            
        },complete:function(){
            eval(func)
        }
    })
}

function deleteBIReportContent(code,BIName,workspaceID,reportID,status,parent_node,sort){
    if($('[name="btSelectItem"]:checked').length!=0){
        code = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-code')}).get()
        BIName = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-BI_name')}).get()
        workspaceID = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-workspaceID')}).get()
        reportID = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-reportID')}).get()
        status = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-status')}).get()
        parent_node = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-parent_node')}).get()
        sort = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-sort')}).get()
    }

    $('#exampleModalLabel').html('確定刪除?')
    let func = `editBIReport_searchPermissions("${code}");
                $('.addPowerBI_PermissionGroup').attr('disabled',true)
    `
    console.log(func)
    BIReportContent(func) 
    $('#exampleModalLabel').html('刪除報表')
    $('#editBIReport_code').attr('data-code',code)
    $('#editBIReport_code').val(code)
    $('#editBIReport_BIName').val(BIName)
    if(workspaceID!='null'){$('#editBIReport_workspaceID').val(workspaceID)}
    if(reportID!='null'){$('#editBIReport_reportID').val(reportID)}
    if(status=='true'){$('#editBIReport_status').val(1)}else{$('#editBIReport_status').val(0)}
    if(parent_node!='null'){$('#editBIReport_parent_node').val(parent_node)}
    $('#editBIReport_sort').val(sort)

    $('#editBIReport_code').prop('disabled', true)
    $('#editBIReport_BIName').prop('disabled', true)
    $('#editBIReport_workspaceID').prop('disabled', true)
    $('#editBIReport_reportID').prop('disabled', true)
    $('#editBIReport_status').prop('disabled', true)
    $('#editBIReport_parent_node').prop('disabled', true)
    $('#editBIReport_sort').prop('disabled', true)
    

    $('#submit').attr('onclick',`deleteBIReport()`)
}

function addBIReportContent(){
    let func = "$('.addPowerBI_PermissionGroup').eq(0).prop('checked',true)"
    BIReportContent(func) 
    $('#exampleModalLabel').html('新增報表')
    $('#submit').attr('onclick','insertEditedBIReport()')
}

function editBIReport(code,BIName,workspaceID,reportID,status,parent_node,sort){
    if($('[name="btSelectItem"]:checked').length!=0){
        code = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-code')}).get()
        BIName = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-BI_name')}).get()
        workspaceID = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-workspaceID')}).get()
        reportID = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-reportID')}).get()
        status = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-status')}).get()
        parent_node = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-parent_node')}).get()
        sort = $('[name="btSelectItem"]:checked').map(function(){return $(this).parents('.bs-checkbox').next('td').children('button').attr('data-sort')}).get()
    }

    let editButtonID = $(event.target).attr('id')
    let func = `editBIReport_searchPermissions("${code}");`
    console.log(func)
    BIReportContent(func) 
    $('#exampleModalLabel').html('編輯報表')
    $('#editBIReport_code').attr('data-code',code)
    $('#editBIReport_code').val(code)
    $('#editBIReport_BIName').val(BIName)
    if(workspaceID!='null'){$('#editBIReport_workspaceID').val(workspaceID)}
    if(reportID!='null'){$('#editBIReport_reportID').val(reportID)}
    if(status=='true'){$('#editBIReport_status').val(1)}else{$('#editBIReport_status').val(0)}
    if(parent_node!='null'){$('#editBIReport_parent_node').val(parent_node)}
    $('#editBIReport_sort').val(sort)
    $('#submit').attr('onclick',`updateEditedBIReport("${editButtonID}")`)
}

function editBIReport_searchPermissions(code){
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:editBIReport_searchPermissions" %}', // this is the mapping between the url and view
        data:{
            'code':code,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            for(let i=0;i<response.permissionsGroupName.length;i++){
                $(`#${response.permissionsGroupName[i]}`).prop('checked',true)
            }
        }
    })
}

function updateEditedBIReport(editButtonID){
    let originBIReport_code = $('#editBIReport_code').attr('data-code').split(',')
    let editBIReport_code = $('#editBIReport_code').val().split(',')
    let editBIReport_BIName = $('#editBIReport_BIName').val().split(',')
    let editBIReport_workspaceID = $('#editBIReport_workspaceID').val().split(',')
    let editBIReport_reportID = $('#editBIReport_reportID').val().split(',')
    let editBIReport_status = $('#editBIReport_status').val().split(',')
    let editBIReport_parent_node = $('#editBIReport_parent_node').val().split(',')
    let editBIReport_sort = $('#editBIReport_sort').val().split(',')
    let addPowerBI_PermissionGroup = $('.addPowerBI_PermissionGroup:checked').map(function(){return $(this).val()}).get()
    //console.log(originBIReport_code,editBIReport_code,editBIReport_BIName,editBIReport_workspaceID,editBIReport_reportID,editBIReport_status,editBIReport_parent_node,editBIReport_sort,addPowerBI_PermissionGroup)
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:updateEditedBIReport" %}', // this is the mapping between the url and view
        data:{
            'originBIReport_code':originBIReport_code,
            'editBIReport_code':editBIReport_code,
            'editBIReport_BIName':editBIReport_BIName,
            'editBIReport_workspaceID':editBIReport_workspaceID,
            'editBIReport_reportID':editBIReport_reportID,
            'editBIReport_status':editBIReport_status,
            'editBIReport_parent_node':editBIReport_parent_node,
            'editBIReport_sort':editBIReport_sort,
            'addPowerBI_PermissionGroup':addPowerBI_PermissionGroup,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            for(let i=0;i<$('[name="btSelectItem"]:checked').length;i++){
                $('[name="btSelectItem"]:checked').parents('.bs-checkbox').next('td').children('button').eq(0).attr('onclick',`editBIReport('${editBIReport_code[i]}','${editBIReport_BIName[i]}','${editBIReport_workspaceID[i]}','${editBIReport_reportID[i]}','${editBIReport_status[i]}','${editBIReport_parent_node[i]}','${editBIReport_sort[i]}')`)
                $('[name="btSelectItem"]:checked').parents('.bs-checkbox').next('td').children('button').eq(1).attr('onclick',`deleteBIReportContent('${editBIReport_code[i]}','${editBIReport_BIName[i]}','${editBIReport_workspaceID[i]}','${editBIReport_reportID[i]}','${editBIReport_status[i]}','${editBIReport_parent_node[i]}','${editBIReport_sort[i]}')`)
            }
            getPowerbiReportPermission()
            get_powerBI_list()
        }
    })
    
}

function insertEditedBIReport(){
    let editBIReport_code = $('#editBIReport_code').val()
    let editBIReport_BIName = $('#editBIReport_BIName').val()
    let editBIReport_workspaceID = $('#editBIReport_workspaceID').val()
    let editBIReport_reportID = $('#editBIReport_reportID').val()
    let editBIReport_status = $('#editBIReport_status').val()
    let editBIReport_parent_node = $('#editBIReport_parent_node').val()
    let editBIReport_sort = $('#editBIReport_sort').val()
    let addPowerBI_PermissionGroup = $('.addPowerBI_PermissionGroup:checked').map(function(){return $(this).val()}).get()
    //console.log(originBIReport_code,editBIReport_code,editBIReport_BIName,editBIReport_workspaceID,editBIReport_reportID,editBIReport_status,editBIReport_parent_node,editBIReport_sort,addPowerBI_PermissionGroup)
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:insertEditedBIReport" %}', // this is the mapping between the url and view
        data:{
            'editBIReport_code':editBIReport_code,
            'editBIReport_BIName':editBIReport_BIName,
            'editBIReport_workspaceID':editBIReport_workspaceID,
            'editBIReport_reportID':editBIReport_reportID,
            'editBIReport_status':editBIReport_status,
            'editBIReport_parent_node':editBIReport_parent_node,
            'editBIReport_sort':editBIReport_sort,
            'addPowerBI_PermissionGroup':addPowerBI_PermissionGroup,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            getPowerbiReportPermission()
            get_powerBI_list()
        }
    })
}

function deleteBIReport(){
    let editBIReport_code = $('#editBIReport_code').val()

    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:deleteBIReport" %}', // this is the mapping between the url and view
        data:{
            'editBIReport_code':editBIReport_code,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            getPowerbiReportPermission()
            get_powerBI_list()
        }
    })
}

</script>




<body >
    {% include 'navBar.html' %}
    {{ user.username|json_script:"user_username" }}
    {{ user.last_name|json_script:"hospital" }}
    <div id="slideout">
        <input type="checkbox" id="mycheckbox">
        <label for="mycheckbox" class="feedback-label">儀表板選單</label>
        <form class="form sc2" id='bi_list'>
        </form>
    </div>
</body>
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">群組權限編輯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="permissionsPanel" class="modal-body">
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="submit">提交</button>
            </div>
            </div>
        </div>
    </div>

    <main class="row" id='powerbi_area'>


        <section id="report-container"  class="embed-container" style="width:100%;">
        </section>
        <!-- Used to display report embed error messages -->
        <section class="error-container m-5">
        </section>
    </main>

</html>
{% endblock %}
