

{% load static%}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight-within-textarea@2.0.5/jquery.highlight-within-textarea.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/highlight-within-textarea@2.0.5/jquery.highlight-within-textarea.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.css">
<script src="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
<link href="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.css" rel="stylesheet">
<link href="https://unpkg.com/bootstrap-table@1.21.3/dist/extensions/sticky-header/bootstrap-table-sticky-header.css" rel="stylesheet">

<script src="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.3/dist/extensions/sticky-header/bootstrap-table-sticky-header.min.js"></script>

<link href="https://unpkg.com/perfect-scrollbar@1.4.0/css/perfect-scrollbar.css" rel="stylesheet">
<link href="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.css" rel="stylesheet">

<script src="https://unpkg.com/perfect-scrollbar@1.4.0/dist/perfect-scrollbar.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.3/dist/bootstrap-table.min.js"></script>

<!-- Styles -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<!-- Or for RTL support -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css" />

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function (e) {

    //初始化
    init();
    //搜尋按鈕
    $("#searchbtn").click(function(){
        //console.log("clicked");
        var string = document.getElementById("inputkeywords").value;
        var word = document.getElementById("wordsOption").value;
        if (word === "1"){
            var response = getStasticTable(string);
        }
        else{
            var response = getStasticTable2(string);
        }
        
    });

    
    //查看報告
    $("#collapseButton").click(function(){
        collapseButtonClick();
    });

    //執行按鈕
    $("#executebtn").click(function(){
        Highlight_Extract();
    });


    //確認名稱
    $("#check").click(function(){
        //////console.log("check clicked");
        Name = [];
        Name.push(document.getElementById("regexName").value);
        //////console.log(name);
        
        //不為空檢查，否則顯示不可為空
        if (Name[0] != ""){
            tokenTYPE = checkName(Name);
        }
        else{
            Swal.fire({
                title: '請輸入token',
                icon: 'error',
                confirmButtonText: 'ok',
            })
        }
    }); 

    //查詢文章
    $("#searchArticle").click(function(){
        searchArticleClick();
    }); 

    //新增按鈕
    $("#insertDef").click(function(){
        insertDefButton();
        
    }); 

    //儲存按鈕
    $("#storebtn").click(function(){
        storebtnClick();
    });
})



    //初始化
    function init(){
        var wordsOption = document.getElementById("wordsOption");
        wordsOption.addEventListener("change", onWordsOptionChange);
        var inputText = document.getElementById("inputkeywords");
        inputText.value = "( [Number] )";
        inputText.innerHTML = "( [Number] )";

        $('#loader').css('display','none');
        $('#frame').css('visibility','visible');

        //console.log("responseItem : ", responseItem);
        
        getitemTable();
        // $('#itemDefinition tbody').empty()
        // let element = '';
        // for(let i=0;i<responseItem.itemID.length;i++){
        //     element += `<tr>
        //         <td>${responseItem.itemID[i]}</td>
        //         <td>${responseItem.rootID[i]}</td>
        //         <td>${responseItem.itemName[i]}</td>
        //         <td>${responseItem.engName[i]}</td>
        //         <td>${responseItem.chtName[i]}</td>
        //         <td>${responseItem.itemType[i]}</td>
        //         </tr>`;
        // }
        // $('#itemDefinition tbody').append(element);
        getEToken();
    }

    
    function getEToken(){
        $.ajax({
            type: 'POST',
            url: '{% url "mark:getEToken" %}',
            success:function (response){
                for(let i=0;i<response.token.length;i++){
                    element = `<option value=${response.token[i]} id="` + response.tokenID[i] + `">${response.token[i]}</option>`;
                    $('#regexName').append(element);
                }
            },
        });
    }
    
    //儲存按鈕
    function storebtnClick(){
        var autoSelect = document.getElementById("storebtn").autoSelect;
        var tokenName = document.getElementById("regexName").value;
        //console.log("tokenName : ", tokenName);
        if (tokenName === ""){ 
            Swal.fire({
                title: '請輸入tokenName',
                icon: 'error',
                confirmButtonText: 'ok',
            })
            return;
        }
        
        var regex = document.getElementById("regexText").value;
        //console.log("regex : ", regex);
        if (regex === ""){ 
            Swal.fire({
                title: '請輸入RE',
                icon: 'error',
                confirmButtonText: 'ok',
            })
            return;
        }

        var extractedArray = [];
        var keyArray = [];
        var valueArray = [];
        Swal.fire({
            title: '進入下一步確認各項參數?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        })
        .then((result) => {
            if (result.isConfirmed) {
                try{
                    storebtnClickCheck(extractedArray, keyArray, valueArray);
                    showModal(keyArray, valueArray);
                } catch (error) {
                    if (error instanceof Error) {
                        Swal.fire({
                            title: 'Error',
                            text: error,
                            icon: 'error',
                            confirmButtonText: 'Ok',
                        })
                        return;
                    }
                }
                
            } else{
                Swal.fire({
                    title: 'Request Canceled',
                    icon: 'info',
                })
            }
        });
    }

    //儲存按鈕確認
    function storebtnClickCheck(extractedArray, keyArray, valueArray){            
        let textToSearch = document.getElementById("regexText").value;                
        textToSearch = textToSearch.replace(/[ .*+?^${}()| [\ ]\\ ]/g,"\\$&");
        let dateFormat = new RegExp(`${textToSearch}`,"g");
        //////console.log("dateFormat: "+ dateFormat);          
        result_array = []
        var paragraph = document.getElementById("reportText").innerHTML;
        
        paragraph = $("#reportText").attr("originalReport");

        // document.getElementById("reportText").innerHTML = paragraph.replace(dateFormat, match => `<mark class="highlight">${match}</mark>`);

        //迴圈執行exec()取得回傳的groups 原本exec只會找一筆所以要回圈 match回傳值沒有groups所以不能用
        while(null != (g = dateFormat.exec(paragraph))) {
            ////console.log("groups: " + g.groups);  // ouput: "a"
            //console.log("pattern: " + g);
            result_array.push(g.groups);
            extractedArray.push(g[0]);
        }
        //console.log("result_array : ", result_array);
        
        var allkeyArray = [];
        var allvalueArray = [];
        for(var i=0 ; i<result_array.length ; i++){
            var  entries = Object.entries(result_array[i]);
            for (const [key, value] of entries) {
                //console.log(`Key: ${key}, Value: ${value}`);
                if(!keyArray.includes(key)){
                    keyArray.push(key);
                    valueArray.push(value);
                }
                allkeyArray.push(key);
                allvalueArray.push(value);
            }
        }

        //console.log("extractedArray : ", extractedArray);
        //console.log("allvalueArray : ", allvalueArray);
        var ex = "";
        var count = 0;
        for(var i=0 ; i<allvalueArray.length ; i++){
            ex = ex.concat((i+1).toString(), ". ", " pattern : ", extractedArray[0], ", value : ", allvalueArray[i], "\n")
            count += 1;
        }

        //console.log("keyArray : ", keyArray);
        //console.log("valueArray : ", valueArray);
        var string = "";
        for(var i=0 ; i<keyArray.length ; i++){
            string += (keyArray[i]).toString() + ". " + valueArray[i].toString() + "<br>"
        }
    }

    //搜尋文章
    function searchArticleClick(){
        var lastSearch = "";
        var lastNum = "";
        var indexOfReports = 0;
        var reportArray = [];
        //////console.log("check clicked");
        word = document.getElementById("inputkeywords").value;
        //console.log("word : ", word);

        var number = document.getElementById("inputReportNumber").value;
        if (number === ""){
            number = "10";
        }
        
        //console.log("lastSearch : ", lastSearch);
        if (lastSearch != word || lastNum != number){

            var responseReport = searchReport(word, number);
            printResult(responseReport);
            if (responseReport.status === "0"){
                indexOfReports = 0;
                reportArray = responseReport.data;

                //console.log("report: ", responseReport);
                //console.log("reportArray: ", reportArray);
                document.getElementById("inputText").value = reportArray[indexOfReports].Text;
                document.getElementById("inputText").innerHTML = reportArray[indexOfReports].Text;
                lastSearch = word;
                lastNum = number;
                document.getElementById("searchArticle").innerHTML = "查詢文章 " + (indexOfReports+1).toString() + "/" + reportArray.length.toString();
            }
        }
        else{
            indexOfReports +=1;
            if (indexOfReports > reportArray.length-1){
                Swal.fire({
                    title: 'Last report',
                    html: "已經是最後一篇文章，從頭開始查看?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'No'
                })
                .then((result) => {
                    if (result.isConfirmed) {
                        indexOfReports = 0;
                        document.getElementById("inputText").value = reportArray[indexOfReports].Text;
                        document.getElementById("inputText").innerHTML = reportArray[indexOfReports].Text;
                        document.getElementById("searchArticle").innerHTML = "查詢文章 " + (indexOfReports+1).toString() + "/" + reportArray.length.toString();
                    } else{
                        Swal.fire({
                            title: 'Canceled',
                            icon: 'info',
                        })
                    }
                });
            }
            else{
                document.getElementById("inputText").value = reportArray[indexOfReports].Text;
                document.getElementById("inputText").innerHTML = reportArray[indexOfReports].Text;
                document.getElementById("searchArticle").innerHTML = "查詢文章 " + (indexOfReports+1).toString() + "/" + reportArray.length.toString();
            }
        }
    }
    
    //新增itemName按鈕
    function insertDefButton(){
        var itemID = document.getElementById("itemDefinition_itemID").value;
        var rootID = document.getElementById("itemDefinition_rootID").value;
        var itemName = document.getElementById("itemDefinition_itemName").value;
        var engName = document.getElementById("itemDefinition_engName").value;
        var chtName = document.getElementById("itemDefinition_chtName").value;
        var itemType = document.getElementById("itemDefinition_itemType").value;
        var rootName = "";
        //console.log("itemID : ", itemID);
        //console.log("rootID : ", rootID);
        //console.log("itemName : ", itemName);
        //console.log("engName : ", engName);
        //console.log("chtName : ", chtName);
        //console.log("itemType : ", itemType);
        if (rootID === "0"){
            rootName = "無";
        }
        else{
            var response = searchItem(rootID);
            //console.log("response : ", response);
            printResult(response);
            rootName = response.chtName;
        }
        Swal.fire({
            title: 'Create a new itemDefinition ?',
            html: "rootName : " + rootName,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        })
        .then((result) => {
            if (result.isConfirmed) {
                var resInsert = insertItemDefinition1(itemID, rootID, itemName, engName, chtName, itemType);  
                printResult(resInsert);
                
                getitemTable();
                // var response = getItemDefinition();
                // responseformodal = response;
                // //console.log("response : ", response);
                
                // $('#itemDefinition tbody').empty()
                // let element = '';
                // for(let i=0;i<response.itemID.length;i++){
                //     element += `<tr>
                //         <td class="double-clickable-itemID" style="user-select : none; cursor: pointer;" >${response.itemID[i]}</td>
                //         <td class="double-clickable-itemID" style="user-select : none; cursor: pointer;" >${response.rootID[i]}</td>
                //         <td class="double-clickable-itemName" style="user-select : none; cursor: pointer;" >${response.itemName[i]}</td>
                //         <td class="double-clickable-engName" style="user-select : none; cursor: pointer;" >${response.engName[i]}</td>
                //         <td class="double-clickable-chtName" style="user-select : none; cursor: pointer;" >${response.chtName[i]}</td>
                //         <td class="double-clickable-itemType" style="user-select : none; cursor: pointer;" >${responseItem.itemType[i]}</td>
                //         </tr>`;
                // }
                // $('.double-clickable-itemID').on('dblclick', function() {
                //     getitemID();
                // });
                // $('.double-clickable-itemName').on('dblclick', function() {
                //     getitemName();
                // });
                // $('.double-clickable-engName').on('dblclick', function() {
                //     getengName();
                // });
                // $('.double-clickable-chtName').on('dblclick', function() {
                //     getchtName();
                // });
                // $('.double-clickable-itemType').on('dblclick', function() {
                //     getitemType();
                // });
                // $('#itemDefinition tbody').append(element);
            } else{
                Swal.fire({
                    title: 'Request Canceled',
                    icon: 'info',
                })
            }
        });
    }

    function getitemTable(){
        console.log("getitemTable in ");
        
        responseItem = getItemDefinition();
        responseformodal = responseItem;
        response = responseItem;
        //console.log("response : ", response);
        
        $('#itemDefinition tbody').empty();
        let element = '';
        for(let i=0;i<response.itemID.length;i++){
            element += `<tr>
                <td class="double-clickable-itemID" style="user-select : none; cursor: pointer;" >${response.itemID[i]}</td>
                <td class="double-clickable-itemID" style="user-select : none; cursor: pointer;" >${response.rootID[i]}</td>
                <td class="double-clickable-itemName" style="user-select : none; cursor: pointer;" >${response.itemName[i]}</td>
                <td class="double-clickable-engName" style="user-select : none; cursor: pointer;" >${response.engName[i]}</td>
                <td class="double-clickable-chtName" style="user-select : none; cursor: pointer;" >${response.chtName[i]}</td>
                <td class="double-clickable-itemType" style="user-select : none; cursor: pointer;" >${responseItem.itemType[i]}</td>
                </tr>`;
        }
        
        $('#itemDefinition tbody').append(element);
        $('.double-clickable-itemID').on('dblclick', function() {
            getitemID();
        });
        $('.double-clickable-itemName').on('dblclick', function() {
            getitemName();
        });
        $('.double-clickable-engName').on('dblclick', function() {
            getengName();
        });
        $('.double-clickable-chtName').on('dblclick', function() {
            getchtName();
        });
        $('.double-clickable-itemType').on('dblclick', function() {
            getitemType();
        });
        
    }

    //取得雙擊元素itemID
    function getitemID(){
        console.log("target : ", event.target);
        var element = document.getElementById("itemDefinition_itemID");
        element.value = event.target.innerHTML;
        element.innerHTML = event.target.innerHTML;
        emphasizeInput(element);
    }

    //取得雙擊元素itemName
    function getitemName(){
        console.log("target : ", event.target);
        var element = document.getElementById("itemDefinition_itemName");
        element.value = event.target.innerHTML;
        element.innerHTML = event.target.innerHTML;
        emphasizeInput(element);
    }

    //取得雙擊元素engName
    function getengName(){
        console.log("target : ", event.target);
        var element = document.getElementById("itemDefinition_engName");
        element.value = event.target.innerHTML;
        element.innerHTML = event.target.innerHTML;
        emphasizeInput(element);
    }

    //取得雙擊元素chtName
    function getchtName(){
        console.log("target : ", event.target);
        var element = document.getElementById("itemDefinition_chtName");
        element.value = event.target.innerHTML;
        element.innerHTML = event.target.innerHTML;
        emphasizeInput(element);
    }

    //取得雙擊元素itemType
    function getitemType(){
        // console.log("target : ", event.target);
        // var element = document.getElementById("itemDefinition_itemType");
        // element.value = event.target.innerHTML;
        // element.innerHTML = event.target.innerHTML;
        // emphasizeInput(element);
        console.log("target : ", event.target);
        var selectedItemType = event.target.innerHTML.trim();
        var itemTypeOptions = document.querySelectorAll('#itemDefinition_itemType option');
        for (var i = 0; i < itemTypeOptions.length; i++) {
            var optionValue = itemTypeOptions[i].getAttribute('value').trim();
            if (optionValue === selectedItemType) {
                itemTypeOptions[i].selected = true;
                break;
            }
        }
        var element = document.getElementById("itemDefinition_itemType");
        // element.innerHTML = element.options[element.selectedIndex].innerHTML;
        emphasizeInput(element);
    }

    //查看報告
    function collapseButtonClick(){
        let textToSearch = document.getElementById("regexText").value;
                        
        textToSearch = textToSearch.replace(/[ .*+?^${}()| [\ ]\\ ]/g,"\\$&");
        let dateFormat = new RegExp(`${textToSearch}`,"g");
        //////console.log("dateFormat: "+ dateFormat);          
        result_array = []
        var paragraph = $("#reportText").attr("originalReport");

        
        if (textToSearch === "" || paragraph === ""){
            Swal.fire({
                title: 'Error',
                html: "請先搜尋, 並且點選自動產生RE後再執行此功能",
                icon: 'error',
                confirmButtonText: 'ok',
            })
            return;
        }

        document.getElementById("reportText").innerHTML = paragraph.replace(dateFormat, match => `<mark class="highlight">${match}</mark>`);

        var modal = document.getElementById("modalReport");
        modal.style.display = "block";

        var closeButton = document.querySelector('#btnclosereport');
        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });
    }

    //select on change顯示3-5字
    function onWordsOptionChange() {
        // Get the selected value from the wordsOption select element
        var words = document.getElementById("wordsOption").value;
        var inputText = document.getElementById("inputkeywords");

        var threewordTable = document.getElementById("stasticsTable");
        var fivewordTable = document.getElementById("stasticsTable2");
        if (words === "1"){
            // threewordTable.style.display = "block";
            // fivewordTable.style.display = "none";
            fadein(threewordTable);
            fadeout(fivewordTable);
            inputText.value = "( [Number] )";
            inputText.innerHTML = "( [Number] )";
        }
        else{
            // threewordTable.style.display = "none";
            // fivewordTable.style.display = "block";
            fadeout(threewordTable);        
            fadein(fivewordTable);
            inputText.value = "( [Number] / [Number] )";
            inputText.innerHTML = "( [Number] / [Number] )";

        }
    }

    //輸入元素fadeout
    function fadeout(element) {
        var op = 1;  // initial opacity
        var timer = setInterval(function () {
            if (op <= 0.1){
                clearInterval(timer);
                element.style.display = 'none';
            }
            element.style.opacity = op;
            element.style.filter = 'alpha(opacity=' + op * 100 + ")";
            op -= op * 0.1;
        }, 15);
    }

    //輸入元素fadein
    function fadein(element) {
        var op = 0.1;  // initial opacity
        element.style.display = 'block';
        var timer = setInterval(function () {
            if (op >= 1){
                clearInterval(timer);
            }
            element.style.opacity = op;
            element.style.filter = 'alpha(opacity=' + op * 100 + ")";
            op += op * 0.1;
        }, 10);
    }

    //根據reportID找文章
    function getReportBylastReportID(reportID){
        var btn = document.getElementById("collapseButton");
        var text = "查詢中";
        var count = 0;
        btn.disabled = true; // Disable the button during the search
        var intervalId = setInterval(function() {
            count++;
            if (count > 3) {
            count = 0;
            }
            switch (count) {
            case 0:
                btn.innerHTML = text;
                break;
            case 1:
                btn.innerHTML = text + ".";
                break;
            case 2:
                btn.innerHTML = text + "..";
                break;
            case 3:
                btn.innerHTML = text + "...";
                break;
            }
        }, 500); // Update the text every 500 milliseconds
        //console.log("reportID" + reportID);     
        $.ajax({
            type: 'POST',
            url: '{% url 'mark:getReportByReportID' %}',
            data:JSON.stringify({
                'reportID': reportID,
            }),
            success:function (response){
                // printResult(response);
                document.getElementById("reportText").innerHTML = response.data;
                document.getElementById("reportText").setAttribute("originalReport", response.data);
                clearInterval(intervalId);
                btn.disabled = false;
                btn.innerHTML = "已找到報告!";
                setTimeout(() => {
                    btn.innerHTML = "顯示報告";
                }, 1000);
            },
        });
    }

    //找文章
    function searchReport(word, number){
        //console.log("number : ", number);
        var res;
        $.ajax({
            async: false, 
            type: 'POST',
            url: '{% url 'mark:getReportTextByMergeTokenExpression' %}',
            data:JSON.stringify({
                'tokens': word,
                'number': number,
            }),
            success:function (response){
                res = response;
            },
        })
        return res;
    }

    //存itemDef
    function insertItemDefinition1(itemID, rootID, itemName, engName, chtName, itemType, leadingID, groupingID){
        var res;
        $.ajax({
            async: false, 
            type: 'POST',
            url: '{% url 'mark:insertintoItemDefinition' %}',
            data:JSON.stringify({
                'itemID': itemID,
                'rootID': rootID,
                'itemName': itemName,
                'engName': engName,
                'chtName': chtName,
                'itemType': itemType,
                'leadingID': leadingID,
                'groupingID': groupingID,
                'control': "0",
            }),
            success:function (response){
                res = response;
            },
        })
        return res;
    }

    //存itemDef
    function insertItemDefinition(itemID, rootID, itemName, engName, chtName, itemType, leadingID, groupingID){
        var res;
        $.ajax({
            async: false, 
            type: 'POST',
            url: '{% url 'mark:insertintoItemDefinition' %}',
            data:JSON.stringify({
                'itemID': itemID,
                'rootID': rootID,
                'itemName': itemName,
                'engName': engName,
                'chtName': chtName,
                'itemType': itemType,
                'leadingID': leadingID,
                'groupingID': groupingID,
                'control': "1",
            }),
            success:function (response){
                res = response;
            },
        })
        return res;
    }

    

    //存leadingGroup對應
    function insertLeadingGroup(leadingID, groupingID){
        var res;
        $.ajax({
            async: false, 
            type: 'POST',
            url: '{% url 'mark:insertintoItemTrans' %}',
            data:JSON.stringify({
                'leadingID': leadingID,
                'groupingID': groupingID,
            }),
            success:function (response){
                res = response;
            },
        })
        return res;
    }

    //找父節點
    function searchItem(itemID){
        //console.log("itemID : ", itemID);
        var res;
        $.ajax({
            async: false, 
            type: 'POST',
            url: '{% url 'mark:getItemByRootID' %}',
            data:JSON.stringify({
                'itemID': itemID,
            }),
            success:function (response){
                res = response;
            },
        })
        return res;
    }

    //確認名稱合法與否
    function checkName(Name){
        var res;
        $.ajax({
            async: false, 
            type: 'GET',
            url: '{% url 'mark:checkName' %}',
            data:{
                'Name[]': Name,
            },
            success:function (response){
                res = response.tokenType;
                const feedbackElement = document.querySelector('.warning-feedback');
                if (response.status == '0'){                     
                    //有找到，報錯
                    feedbackElement.textContent = "Same Name detected, extract will append a new regex to it.";
                    $("#regexName").attr('class', 'form-control is-warning');
                    feedbackElement.textContent = "";
                }
                else{
                    feedbackElement.textContent = "";
                    //沒找到，正確
                    $("#validText").text("Name is valid!");
                    $("#regexName").attr('class', 'form-control is-valid');
                    $("#regexName").attr('class', 'form-control is-valid');
                }
                
                setTimeout(function() {
                    feedbackElement.textContent = "";
                    $("#regexName").attr('class', 'form-control');
                }, 2000); // adjust the delay time to match the animation duration in your CSS
            },
        })
        return res;
    }

    //生成dual listbox
    function dualBox(){
        let dlb2 = new DualListbox('.selectVocabulary', {
            availableTitle:'Available vocabularies',
            selectedTitle: 'Selected vocabularies',
            addButtonText: '>',
            removeButtonText: '<',
            addAllButtonText: '>>',
            removeAllButtonText: '<<',
            searchPlaceholder: 'search vocabulary',
            draggable: true,
            sortable: true,
        });
        dlb2.addEventListener('added', function(event){
            //console.log(event);
        });
        dlb2.addEventListener('removed', function(event){
            //console.log(event);
        });
    }

    //取得所有itemName
    function getItemDefinition(){
        var res;
        $.ajax({
            async:false,
            type: 'GET',
            url: '{% url "mark:getItemDefinition" %}',
            success:function (response){
                res = response;
                //console.log(response, res);
            },
        });
        return res;
    }

    //三字表格
    function getStasticTable(string){
        var btn = document.getElementById("searchbtn");
        var text = "查詢中";
        var count = 0;
        // btn.disabled = true; // Disable the button during the search
        $("#searchbtn").prop("disabled", true);
        var intervalId = setInterval(function() {
            count++;
            if (count > 3) {
            count = 0;
            }
            switch (count) {
            case 0:
                btn.innerHTML = text;
                break;
            case 1:
                btn.innerHTML = text + ".";
                break;
            case 2:
                btn.innerHTML = text + "..";
                break;
            case 3:
                btn.innerHTML = text + "...";
                break;
            }
        }, 500); // Update the text every 500 milliseconds
        var res;
        $.ajax({
            async:true,
            type: 'POST',
            data: JSON.stringify({
                "string": string,
            }),
            url: '{% url "mark:getStasticTable" %}',
            success:function (response){
                res = response;
                //console.log(response, res);
                printResult(response);
                //console.log("response : ", response);
                
                $('#stasticsTable tbody').empty()
                element = '';
                for(let i=0;i<response.numReports.length;i++){
                    // element += `<tr reportID="${response.reportID[i]}">
                    //     <td><button class="btn btn-secondary" onclick="getREofRecord()">${i+1}</button></td>
                    //     <td>${response.numReports[i]}</td>
                    //     <td>${response.times[i]}</td>
                    //     <td class="show">${response.word1[i]}</td>
                    //     <td class="show">${response.word2[i]}</td>
                    //     <td class="show">${response.word3[i]}</td>
                    //     <td>${response.count4[i]}</td>
                    //     <td class="show">${response.word4[i]}</td>
                    //     <td>${response.count5[i]}</td>
                    //     <td class="show">${response.word5[i]}</td>
                    //     <td>${response.count6[i]}</td>
                    //     <td class="show">${response.word6[i]}</td>
                    //     <td>${response.countTarget[i]}</td>
                    //     <td class="show">${response.targetWord1[i]}</td>
                    //     <td class="show">${response.targetWord2[i]}</td>
                    //     <td class="show">${response.targetWord3[i]}</td>
                    //     </tr>`;
                    element += `<tr reportID="${response.reportID[i]}">
                        <td><button class="btn btn-secondary" onclick="getREofRecord()">${i+1}</button></td>
                        <td>${response.numReports[i]}</td>
                        <td>${response.times[i]}</td>
                        <td class="show" word="word1">${response.word1[i]}</td>
                        <td class="show" word="word2">${response.word2[i]}</td>
                        <td class="show" word="word3">${response.word3[i]}</td>
                        <td class="show" word="word4">${response.word4[i]}</td>
                        <td class="show" word="word5">${response.word5[i]}</td>
                        <td class="show" word="word6">${response.word6[i]}</td>
                        <td class="show">${response.targetWord1[i]}</td>
                        <td class="show">${response.targetWord2[i]}</td>
                        <td class="show">${response.targetWord3[i]}</td>
                        </tr>`;
                }
                $('#stasticsTable tbody').append(element);

                clearInterval(intervalId);
                btn.disabled = false;
                btn.innerHTML = "搜尋";
            },
        });
        return res;
    }

    //五字表格
    function getStasticTable2(string){
    var btn = document.getElementById("searchbtn");
    var text = "查詢中";
    var count = 0;
    btn.disabled = true; // Disable the button during the search
    var intervalId = setInterval(function() {
        count++;
        if (count > 3) {
        count = 0;
        }
        switch (count) {
        case 0:
            btn.innerHTML = text;
            break;
        case 1:
            btn.innerHTML = text + ".";
            break;
        case 2:
            btn.innerHTML = text + "..";
            break;
        case 3:
            btn.innerHTML = text + "...";
            break;
        }
    }, 500); // Update the text every 500 milliseconds
    var res;
    $.ajax({
        async:true,
        type: 'POST',
        data: JSON.stringify({
            "string": string,
        }),
        url: '{% url "mark:getStasticTable2" %}',
        success:function (response){
            res = response;
            //console.log(response, res);
            clearInterval(intervalId);
            printResult(response);
            //console.log("response : ", response);
            
            $('#stasticsTable2 tbody').empty()
            element = '';
            for(let i=0;i<response.numReports.length;i++){
                // element += `<tr reportID="${response.reportID[i]}">
                //     <td><button class="btn btn-secondary" onclick="getREofRecord2()">${i+1}</button></td>
                //     <td>${response.numReports[i]}</td>
                //     <td>${response.times[i]}</td>
                //     <td class="show">${response.word1[i]}</td>
                //     <td class="show">${response.word2[i]}</td>
                //     <td class="show">${response.word3[i]}</td>
                //     <td>${response.count4[i]}</td>
                //     <td class="show">${response.word4[i]}</td>
                //     <td>${response.count5[i]}</td>
                //     <td class="show">${response.word5[i]}</td>
                //     <td>${response.count6[i]}</td>
                //     <td class="show">${response.word6[i]}</td>
                //     <td>${response.countTarget[i]}</td>
                //     <td class="show">${response.targetWord1[i]}</td>
                //     <td class="show">${response.targetWord2[i]}</td>
                //     <td class="show">${response.targetWord3[i]}</td>
                //     <td class="show">${response.targetWord4[i]}</td>
                //     <td class="show">${response.targetWord5[i]}</td>
                //     </tr>`;
                element += `<tr reportID="${response.reportID[i]}">
                    <td><button class="btn btn-secondary" onclick="getREofRecord2()">${i+1}</button></td>
                    <td>${response.numReports[i]}</td>
                    <td>${response.times[i]}</td>
                    <td class="show" word="word1">${response.word1[i]}</td>
                    <td class="show" word="word2">${response.word2[i]}</td>
                    <td class="show" word="word3">${response.word3[i]}</td>
                    <td class="show" word="word4">${response.word4[i]}</td>
                    <td class="show" word="word5">${response.word5[i]}</td>
                    <td class="show" word="word6">${response.word6[i]}</td>
                    <td class="show">${response.targetWord1[i]}</td>
                    <td class="show">${response.targetWord2[i]}</td>
                    <td class="show">${response.targetWord3[i]}</td>
                    <td class="show">${response.targetWord4[i]}</td>
                    <td class="show">${response.targetWord5[i]}</td>
                    </tr>`;
            }
            $('#stasticsTable2 tbody').append(element);

            
            btn.disabled = false;
            btn.innerHTML = "搜尋";
        },
    });
    return res;
}

    //改變文字顏色
    function Highlight_Extract() {
        highLight = document.getElementById('flexRadioDefault1')
        if (highLight.checked == true) {
            //定義輸入的regex值存進變數
            let textToSearch = document.getElementById("regexText").value; 

            //定義輸入的文本存進變數
            let text = document.getElementById("inputText");
            if (textToSearch == ""){
                diaplay_please_input_something();
            }
            else{
                //放到結果欄內
                document.getElementById("result").innerHTML = text.value

                //取出輸出的文本
                let paragraph = document.getElementById("result").innerHTML;
                //將輸入文本丟到輸出欄位變數
                paragraph = text.value
                //處理輸入的regex文本
                textToSearch = textToSearch.replace(/[ .*+?^${}()| [\ ]\\ ]/g,"\\$&");
                //////console.log(textToSearch)
                //////console.log(paragraph)
                //將處理好的regex文本定義為新的regex物件
                try {                
                    let pattern = new RegExp(`${textToSearch}`,"g");                
                
                    //將輸出文本與regex物件有符合的地方加上<mark>標籤，然後丟到輸出欄位
                    document.getElementById("result").innerHTML = paragraph.replace(pattern, match => `<mark class="highlight">${match}</mark>`);
                    // while(null != (g = pattern.exec(paragraph))) {
                    //     //console.log("groups: " , g.groups);  // ouput: "a"
                    //     //console.log("pattern: " , g);
                    //     //console.log("test: " , g[0], g[1], g[2]);

                    //     var  entries = Object.entries(g.groups);
                    //     var length = entries.length;
                    //     //console.log("length of groups : ", length);
                    //     //console.log("length of groups member : ", length);
                    //     for (const [key, value] of entries) {
                    //         //console.log(`Key: ${key}, Value: ${value}`);
                            
                    //     }
                    //     // for (var i=0 ; i<g.groups.length ; i++){
                    //     //     //console.log("i: ", g.groups[i]);
                    //     // }
                    //     //textToSearch.substring(0, g.index) + replacement + textToSearch.substring(g.index + replacement.length);
                    // }
                } catch (error) {
                    if (error instanceof Error) {
                        Swal.fire({
                            title: 'Error',
                            text: error,
                            icon: 'error',
                            confirmButtonText: 'Ok',
                        })
                        return;
                    }
                }
                //////console.log(pattern)
            }
        }

        //萃取模式
        exTract = document.getElementById('flexRadioDefault2')
        if (exTract.checked == true) {
            //定義輸入的regex值存進變數
            let textToSearch = document.getElementById("regexText").value; 
            let table_regex = document.getElementById("regexText").value;

            //定義輸入的文本存進變數
            let text = document.getElementById("inputText");
            //放到結果欄內
            document.getElementById("result").innerHTML = text.value

            //取出輸出的文本
            let paragraph = document.getElementById("result").innerHTML;
            //將輸入文本丟到輸出欄位變數
            paragraph = text.value
            //處理輸入的regex文本
            textToSearch = textToSearch.replace(/[ .*+?^${}()| [\ ]\\ ]/g,"\\$&");
            //////console.log(textToSearch)
            //////console.log(paragraph)
            //將處理好的regex文本定義為新的regex物件
            try {                
                let pattern = new RegExp(`${textToSearch}`,"g");
                //////console.log(pattern)
                
                
                //將輸出文本與regex物件有符合的地方取代為空白      
                document.getElementById("result").innerHTML = paragraph.replace(pattern, " ");
                //////console.log(text.value.match(pattern))
                //抓出被取代的資料 + 排版
                //extractedArray = text.value.match(pattern);

                var extractedArray = [];
                // var ex = "";
                // var count = 0;
                // for(var i=0 ; i<extractedArray.length ; i++){
                //     ex = ex.concat((i+1).toString(), ". ", extractedArray[i], "\n")
                //     count += 1;
                // }
                //console.log("ex:", ex);
                if (textToSearch == ""){
                    diaplay_please_input_something();
                }
                else{
                    
                    // //排完丟到畫面顯示
                    // document.getElementById("ExtractOutput").innerHTML = ex;
                    //開始建立表格
                    //解析輸入的regex
                    let dateFormat = new RegExp(`${textToSearch}`,"g");
                    //////console.log("dateFormat: "+ dateFormat);          
                    result_array = []
                    //迴圈執行exec()取得回傳的groups 原本exec只會找一筆所以要回圈 match回傳值沒有groups所以不能用
                    while(null != (g = dateFormat.exec(paragraph))) {
                        ////console.log("groups: " + g.groups);  // ouput: "a"
                        //console.log("pattern: " + g);
                        result_array.push(g.groups);
                        extractedArray.push(g[0]);
                    }
                    //console.log(result_array);
                    var keyArray = [];
                    var valueArray = [];
                    
                    var allkeyArray = [];
                    var allvalueArray = [];
                    for(var i=0 ; i<result_array.length ; i++){
                        var  entries = Object.entries(result_array[i]);
                        for (const [key, value] of entries) {
                            //console.log(`Key: ${key}, Value: ${value}`);
                            if(!keyArray.includes(key)){
                                keyArray.push(key);
                                valueArray.push(value);
                            }
                            allkeyArray.push(key);
                            allvalueArray.push(value);
                        }
                    }
                    //console.log("extractedArray : ", extractedArray);
                    //console.log("allvalueArray : ", allvalueArray);
                    var ex = "";
                    var count = 0;
                    for(var i=0 ; i<allvalueArray.length ; i++){
                        ex = ex.concat((i+1).toString(), ". ", " pattern : ", extractedArray[0], ", value : ", allvalueArray[i], "\n")
                        count += 1;
                    }
                    
                    //排完丟到畫面顯示
                    document.getElementById("ExtractOutput").innerHTML = ex;
                    document.getElementById("ExtractOutput").value = ex;

                    //console.log("keyArray : ", keyArray);
                    //console.log("valueArray : ", valueArray);
                    var string = "";
                    for(var i=0 ; i<keyArray.length ; i++){
                        string += (keyArray[i]).toString() + ". " + valueArray[i].toString() + "<br>"
                    }
                    // //如果有用named capture groups
                    // if (result_array[0] != null){
                    //     //////console.log(result_array);
                    //     //創建表格元素
                    //     let myTable = document.querySelector('#table');
                    //     //////console.log(Object.keys(result_array[0]));
                    //     let headers = Object.keys(result_array[0]);
                    //     let table = document.createElement('table');
                    //     let headerRow = document.createElement('tr');
                    //     headers.forEach(headerText => {
                    //         let header = document.createElement('th');
                    //         let textNode = document.createTextNode(headerText);
                    //         header.appendChild(textNode);
                    //         headerRow.appendChild(header);
                    //     });
                    //     table.appendChild(headerRow);
                    //     result_array.forEach(emp => {
                    //         let row = document.createElement('tr');
                    //         Object.values(emp).forEach(text => {
                    //             let cell = document.createElement('td');
                    //             let textNode = document.createTextNode(text);
                    //             cell.appendChild(textNode);
                    //             row.appendChild(cell);
                    //         })
                    //         table.appendChild(row);
                    //     });
                    //     myTable.appendChild(table);
                    // }
                    // var tokenType = document.getElementById('dropdownbutton').value;

                    var tokenType = "E";
                    // //儲存按鈕
                    // $("#storebtn").click(function(){
                    //     Swal.fire({
                    //         title: 'Continue to define itemID of item?',
                    //         html: string,
                    //         icon: 'question',
                    //         showCancelButton: true,
                    //         confirmButtonText: 'Yes',
                    //         cancelButtonText: 'No'
                    //     })
                    //     .then((result) => {
                    //         if (result.isConfirmed) {
                    //             showModal(keyArray, valueArray);
                    //             //if (tokenType === "E"){
                    //             //    //console.log("result_array : " , result_array);
                    //             //    ////console.log("save pressed E");
                    //             //    //資料到後端儲存
                    //             //    BtnClicked_1(Object.keys(result_array[0]));
                    //             //    document.getElementById("returnbtn").style.visibility = 'visible';
                    //             //}
                    //         } else{
                    //             Swal.fire({
                    //                 title: 'Request Canceled',
                    //                 icon: 'info',
                    //             })
                    //         }
                    //     });
                        
                    // });
                    
                }
            } catch (error) {
                if (error instanceof Error) {
                    Swal.fire({
                        title: 'Error',
                        text: error,
                        icon: 'error',
                        confirmButtonText: 'Ok',
                    })
                    return;
                }
            }
        }
    }

    //顯示結果
    function printResult(response){
        if(response.status == "0"){ 
            if (response.MSG){                
                Swal.fire({
                    title: 'Success',
                    text: response.MSG,
                    icon: 'success',
                })
            }
        }
        else{
            if (response.ERRMSG){
                Swal.fire({
                    title: 'Failed',
                    text: response.ERRMSG,
                    icon: 'error',
                })
            }
            else{
                Swal.fire({
                    title: 'Failed',
                    text: "Something went wrong",
                    icon: 'error',
                })
            }
        }        
    }

    //顯示3字modal
    function showModal(keyArray, valueArray) {
		var modal = document.getElementById("modal");
        modal.style.display = "block";
        //console.log("modal : ", modal);

        var closeButton = document.querySelector('#closeModal');

        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        ////console.log("keyArray : ", keyArray);
        ////console.log("valueArray : ", valueArray);

        const container = document.getElementById('result_data'); // example container 
        container.innerHTML = ''; // empty the container
        
        var response = getItemDefinition();
        var nameArray = response.itemName;   
        var chtArray = response.chtName;   
        var itemIDArray = response.itemID;

        
        var Text = document.createElement('span');
        Text.innerHTML = "請確認 REitem 對應<br>";
        
        var LeadingID = $("#storebtn").attr("leadingID");
        console.log("LeadingID : ", LeadingID);
        if (LeadingID){
            Text.innerHTML = `已自動選取"${selectLeading}"的相關item<br>`;
        }
        container.appendChild(Text); // append the dropdown to the container element
        for (let i = 0; i < keyArray.length; i++) {            
            const dropdown = document.createElement('select'); // create a new dropdown element
            dropdown.className = "form-select";
            dropdown.id = `selectItem${i}`;
            var element = "";
            
            for (let j = 0; j < nameArray.length; j++) {
                //element += `<tr>
                //<td>${response.itemID[i]}</td>
                //<td>${response.rootID[i]}</td>
                //<td>${response.itemName[i]}</td>
                //<td>${response.engName[i]}</td>
                //<td>${response.chtName[i]}</td>
                //</tr>`;
                const option = document.createElement('option'); // create a new option element
                option.text = nameArray[j] + " " + chtArray[j]; // set the text of the option
                option.value = nameArray[j]; // set the text of the option
                option.itemID = itemIDArray[j]; // set the text of the option
                dropdown.add(option); // add the option to the dropdown
                //console.log("nameArray[j], keyArray[i]", nameArray[j], keyArray[i]);
                if (nameArray[j] == keyArray[i]){
                    //console.log("nameArray[j], keyArray[i]", nameArray[j], keyArray[i]);
                    option.setAttribute('selected', true);
                }
            }

            var number = document.createElement('span');
            number.innerHTML = "item" + (i+1).toString() + " : \"" + keyArray[i] + "\", 找到的值 : " + valueArray[i].toString();
            container.appendChild(number); // append the dropdown to the container element
            if (LeadingID){
                dropdown.disabled = true;
            }
            container.appendChild(dropdown); // append the dropdown to the container element
        }
        
        const button = document.createElement('button'); // create a new button element
        button.textContent = '儲存'; // set the text of the button
        button.classList.add('btn', 'btn-secondary'); // add classes to the button

        // add a click event listener to the button
        button.addEventListener('click', function() {
            
            var tableWord = document.getElementById("wordsOption").value;
            if (tableWord === "1"){
                hideElement("stasticsTable");
            }
            else if (tableWord === "2"){                
                hideElement("stasticsTable2");
            }


            var html = "";
            var itemName = [];
            for (let i = 0; i<keyArray.length; i++) {      
                var select = document.getElementById(`selectItem${i}`)
                //console.log("select : ", select);
                var selectedValue = select.value.toString();
                var text = select.innerHTML;
                var selectedOption = select.options[select.selectedIndex];

                // Get the innerHTML value of the selected option element
                var selectedOptionInnerHTML = selectedOption.innerHTML;

                //console.log("selectedValue : ", selectedValue);
                html += (keyArray[i]).toString() + ": " + selectedOptionInnerHTML + "<br>"
                itemName.push(selectedValue);
            }


            Swal.fire({
                title: 'Save the record?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            })
            .then((result) => {
                if (result.isConfirmed) {
                    //放在這

                    Swal.fire({
                        title: 'Data Saved',
                        icon: 'success',
                        confirmButtonText: 'ok',
                    })
                    
                    modal.style.display = "none";
                    var itemName1 = $("#storebtn").attr("itemName");
                    console.log("itemName1 : ", itemName1);
                    itemName = [];
                    itemName.push(itemName1);
                    BtnClicked_1(itemName);
                } 
                else{
                    // Swal.fire({
                    //     title: 'Request Canceled',
                    //     icon: 'info',
                    // })
                    
                    // modal.style.display = "none";
                }                
            });
        });

        // append the button to the document body
        container.appendChild(button);
    }

    function hideElement(tableid){
        var from = document.getElementById("storebtn").getAttribute("from");
        var to = document.getElementById("storebtn").getAttribute("to");
        var no = document.getElementById("storebtn").getAttribute("no");
        console.log("from : ", from);
        console.log("to : ", to);
        var t = document.getElementById(tableid);
        console.log("t : ", t);
        
        var b = t.getElementsByTagName("tbody")[0];

        var d = b.getElementsByTagName("tr")[no-1];
        console.log("d : ", d);
        var word1 = d.getElementsByTagName("td")[3];
        var word2 = d.getElementsByTagName("td")[4];
        var word3 = d.getElementsByTagName("td")[5];
        var word4 = d.getElementsByTagName("td")[6];
        var word5 = d.getElementsByTagName("td")[7];
        var word6 = d.getElementsByTagName("td")[8];
        
        console.log("word1 : ", word1.innerHTML);
        console.log("word2 : ", word2.innerHTML);
        console.log("word3 : ", word3.innerHTML);
        console.log("word4 : ", word4.innerHTML);
        console.log("word5 : ", word5.innerHTML);
        console.log("word6 : ", word6.innerHTML);

        var alltr = b.getElementsByTagName("tr");
        var totalText = "";
        for(var i=0 ; i<alltr.length ; i++){
            var error = 0;
            var word1all = alltr[i].getElementsByTagName("td")[3];
            var word2all = alltr[i].getElementsByTagName("td")[4];
            var word3all = alltr[i].getElementsByTagName("td")[5];
            var word4all = alltr[i].getElementsByTagName("td")[6];
            var word5all = alltr[i].getElementsByTagName("td")[7];
            var word6all = alltr[i].getElementsByTagName("td")[8];
        
            // console.log("word1all : ", word1all);
            // console.log("word2all : ", word2all);
            // console.log("word3all : ", word3all);
            // console.log("word4all : ", word4all);
            // console.log("word5all : ", word5all);
            // console.log("word6all : ", word6all);
            if(word6all.innerHTML === word6.innerHTML){                    
                totalText += "\n";
                totalText += word6all.innerHTML + " ";
                //console.log(word6all.innerHTML, word6.innerHTML);
                //console.log("match");
                //console.log(alltr[i]);
                if (from <= 4 && word5all.innerHTML === word5.innerHTML){
                    totalText += word5all.innerHTML + " ";
                    //console.log(alltr[i]);                        
                    if (from <= 3 && word4all.innerHTML === word4.innerHTML){
                        totalText += word4all.innerHTML + " ";
                        //console.log(alltr[i]);
                        if (from <= 2 && word3all.innerHTML === word3.innerHTML){
                        totalText += word3all.innerHTML + " ";
                        //console.log(alltr[i]);                                
                            if (from <= 1 && word2all.innerHTML === word2.innerHTML){
                            totalText += word2all.innerHTML + " ";
                            //console.log(alltr[i]);
                                if (from <= 0 && word1all.innerHTML === word1.innerHTML){
                                totalText += word1all.innerHTML + " ";
                                //console.log(alltr[i]);
                                }
                                else if(word1all.innerHTML != word1.innerHTML){
                                    error = 1;
                                }
                            }
                            else if(word2all.innerHTML != word2.innerHTML){
                                error = 1;
                            }
                        }
                        else if(word3all.innerHTML != word3.innerHTML){
                            error = 1;
                        }
                    }
                    else if(word4all.innerHTML != word4.innerHTML){
                        error = 1;
                    }
                }
                else if(word5all.innerHTML != word5.innerHTML){
                    error = 1;
                }
            }
            else if(word6all.innerHTML != word6.innerHTML){
                error = 1;
            }
            // console.log(alltr[i]);
            if (error != 1){
                console.log(alltr[i]);
                alltr[i].style.display = "none";
            }
        }
        console.log("totalText : ", totalText);
    }

    //輸入元素強調
    function emphasizeInput(element) {
        // save the current background color of the input element
        var currentColor = element.style.backgroundColor;

        // set the background color of the input element to the emphasized color
        element.style.backgroundColor = "#BAD6F0";

        // after a short delay, restore the original background color
        setTimeout(function() {
            element.style.backgroundColor = currentColor;
        }, 300); // adjust the delay time to match the animation duration in your CSS
    }

    //存檔到後端資料庫
    function BtnClicked_1(itemName){
        //////console.log("execute in")
        console.log("itemName : ", itemName);


        token = document.getElementById('regexName').value;
        //console.log("token : ", token);
        tokenType = "E";
        ////console.log("tokenType : " + tokenType)
        //count = getLength(token);
        //////console.log(input,regex)
        $.ajax({
            type: 'POST',
            url: '{% url 'mark:insertVocabulary' %}',
            data:{
                'token': token,
                'nWord': token.length,
                'tokenType': tokenType,                
            },
            success:function (response){
                ////console.log("result : " + response.status)
                if (tokenType == 'E'){
                    BtnClicked_2(response,itemName);
                }
                printResult(response);
            },
        });
    }

    //存檔到後端資料庫
    function BtnClicked_2(response,itemName){
        ////console.log("btnclicked_2 : " + response.data[0].tokenID)
        var from = document.getElementById("storebtn").getAttribute("from");
        var to = document.getElementById("storebtn").getAttribute("to");
        console.log("from : ", from);
        console.log("to : ", to);
        var word = parseInt(to) - parseInt(from) + 1; 
        console.log("word : ", word);
        tokenID = response.data[0].tokenID;        
        regex = document.getElementById('regexText').value
        ////console.log("tokenID : " + tokenID);

        $.ajax({
            type: 'POST',
            url: '{% url 'mark:inserttokenRE' %}',
            data:{
                'tokenID': tokenID,
                'RE': regex,
                'word': word,
            },
            success:function (response){  
                ////console.log("BtnClicked_2 : ", response)  
                if (tokenType === 'E' && response.status === '0'){
                    ////console.log("btnclicked3")
                    BtnClicked_3(response,itemName);
                }
                
                printResult(response);
            },
            fail:function (){              
            },
        });
    }

    //存檔到後端資料庫
    function BtnClicked_3(response,itemName){   
        ////console.log("btnclicked3_itemName " + itemName)  
        tokenREID = response.data[0].tokenREID;        
        ////console.log("btnclicked")
        for (var i=0 ; i< itemName.length ; i++){
            ////console.log("btnclicked :" + (i+1) + "times")
            $.ajax({
                type: 'POST',
                url: '{% url 'mark:inserttokenREItem' %}',
                data:{
                    'tokenREID': tokenREID,
                    'serialNo': i+1,
                    'itemName': itemName[i],               
                },
                success:function (response){
                    printResult(response);
                },
                fail:function (){              
                },
            });
        }        
    }

    function getREofRecord(){
        ////console.log(event.target);
        //showModalReportText(event.target);
        var token1 = $(event.target).parents('tr').children('td').eq(1).html();
        var token2 = $(event.target).parents('tr').children('td').eq(2).html();
        var target = event.target;

        
        //1. 選root
        var resRoot = selectRoot();
        //console.log("resRoot : ", resRoot);
        var rootArray = resRoot.chtName;
        var element = `<select class="form-select" id="rootSelect">`
        for(var i=0 ; i<rootArray.length ; i++){
            element += `<option value="${rootArray[i].itemID}" id="root${rootArray[i].itemID}">${rootArray[i].chtName}</option>`
        }
        element += `</select>`
        Swal.fire({
            title: '請選擇root',
            html: element,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        })
        .then((result) => {
            if (result.isConfirmed) {
                var rootID = document.getElementById("rootSelect").value;
                var chtNameRoot = document.getElementById(`root${rootID}`).innerHTML;
                
                // Swal.fire({
                //     title: `rootID = ${rootID}, chtName = ${chtNameRoot}`,
                //     html: "123",
                //     icon: 'info',
                //     showCancelButton: true,
                //     confirmButtonText: 'Yes',
                //     cancelButtonText: 'No'
                // })
                // 2. 選該root的leading
                
                var resInternalNode = selectInteralNodeofRoot(rootID, "1");
                //console.log("resInternalNode : ", resInternalNode);
                var internalNodeArray = resInternalNode.chtName;
                element = `<select class="form-select" id="internalNodeSelect">`
                if (internalNodeArray == undefined ){
                    Swal.fire({
                        title: '此root無相關子節點, 請重新選擇',
                        icon: 'error',
                        confirmButtonText: 'ok',
                    })
                    return;
                }
                for(var i=0 ; i<internalNodeArray.length ; i++){
                    element += `<option value="${internalNodeArray[i].itemID}" id="internal${internalNodeArray[i].itemID}">${internalNodeArray[i].chtName} ${internalNodeArray[i].itemName}</option>`
                }
                element += `</select>`




                Swal.fire({
                    title: '請選擇internal Node',
                    html: element,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'No'
                })
                .then((result) => {
                    if (result.isConfirmed) {
                        var internalNodeID = document.getElementById("internalNodeSelect").value;
                        //console.log("internalNodeID : ", internalNodeID);
                        var chtNameInternal = document.getElementById(`internal${internalNodeID}`).innerHTML;
                        //console.log("chtNameInternal : ", chtNameInternal);

                        var resLeadingNode = selectInteralNodeofRoot(internalNodeID, "2");
                        //console.log("resLeadingNode : ", resLeadingNode);
                        
                        element = `<select class="form-select" id="leadingNodeSelect">`
                        if (resLeadingNode.status === "0"){                            
                            var leadingNodeArray = resLeadingNode.chtName;
                            for(var i=0 ; i<leadingNodeArray.length ; i++){
                                element += `<option value="${leadingNodeArray[i].itemID}" id="leading${leadingNodeArray[i].itemID}" itemName="${leadingNodeArray[i].itemName}">${leadingNodeArray[i].chtName}   ${leadingNodeArray[i].itemName}</option>`
                            }
                        }
                        element += `</select>`
                        
                        Swal.fire({
                            title: '請選擇leading Node',
                            html: element,
                            icon: 'info',
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonText: 'Yes',
                            cancelButtonText: 'No',
                            denyButtonText: `新增`,
                        })
                        .then((result) => {
                            if (result.isConfirmed) {
                                var leadingID = document.getElementById("leadingNodeSelect").value;
                                var selectedItemName = $("#leadingNodeSelect option:selected").attr("itemName");
                                console.log("selectedItemName : ", selectedItemName);
                                $("#storebtn").attr("leadingID", leadingID);
                                $("#storebtn").attr("itemName", selectedItemName);
                                var chtNameleading = document.getElementById(`leading${leadingID}`).innerHTML;

                                //console.log("leadingID : ", leadingID);

                                var resgroupNode = selectGroupNodeofRoot(leadingID, "3");
                                console.log("resgroupNode : ", resgroupNode);
                                printResult(resgroupNode);
                                var groupNodeArray = resgroupNode.chtName;
                                element = `<select class="form-select" id="groupNodeSelect">`
                                for(var i=0 ; i<groupNodeArray.length ; i++){
                                    element += `<option value="${groupNodeArray[i].itemID}" id="group${groupNodeArray[i].itemID}">${groupNodeArray[i].itemName}</option>`
                                }
                                element += `</select>`
                                if (groupNodeArray.length > 0){
                                    Swal.fire({
                                        title: '已找到如下groupingID',
                                        html: element,
                                        icon: 'info',
                                        showCancelButton: true,
                                        confirmButtonText: 'Yes',
                                        cancelButtonText: 'No'
                                    })
                                    .then((result) => {
                                        if (result.isConfirmed) {
                                            //console.log("target : ", target);
                                            //console.log("groupNodeSelect : ", groupNodeSelect.value);
                                            var selectedGroup = groupNodeSelect.value;
                                            selectLeading = chtNameleading;
                                            //console.log("selectLeading : ", selectLeading);
                                            showModalStatics(target, resgroupNode, selectedGroup, selectLeading, leadingID);
                                        }else{
                                            Swal.fire({
                                                title: 'Request Canceled',
                                                icon: 'info',
                                            })
                                        }
                                    });
                                }else{
                                    Swal.fire({
                                        title: '未發現相關groupingNode, 請設定',
                                        // html: element,
                                        icon: 'info',
                                        confirmButtonText: 'ok',
                                    })
                                    // .then((result) => {
                                    //     if (result.isConfirmed) {
                                    //         appendNewgroupingNode(target);
                                    //     }else{
                                    //         Swal.fire({
                                    //             title: 'Request Canceled',
                                    //             icon: 'info',
                                    //         })
                                    //     }
                                    // });
                                }

                            }else if (result.isDenied){
                                //Swal.fire('Denied', '', 'info');
                                
                                
                                var lengthOfRecord = $(target).parents('tr').children('td').length;
                                //console.log("lengthOfRecord : ", lengthOfRecord);
                                var text = "";
                                var textArray = [];
                                for(var i=1 ; i<lengthOfRecord ; i++){
                                    if ($(target).parents('tr').children('td').eq(i).attr('class') === "show"){
                                        text += "「" + $(target).parents('tr').children('td').eq(i).html() + "」 ";
                                        textArray.push($(target).parents('tr').children('td').eq(i).html());
                                    }
                                }
                                console.log("textArray : ", textArray);
                                appendNewleadingNode(target, "3", textArray, internalNodeID, rootID);
                            }
                            else{
                                Swal.fire({
                                    title: 'Request Canceled',
                                    icon: 'info',
                                })
                            }
                        });
                        

                    } else{
                        Swal.fire({
                            title: 'Request Canceled',
                            icon: 'info',
                        })
                    }
                });









            } else{
                Swal.fire({
                    title: 'Request Canceled',
                    icon: 'info',
                })
            }
        });

        
        //2. 讀上下對應關係
        
        //如果沒有跳新增
        
        // Swal.fire({
        //         title: '請確認上下關係的對應',
        //         html: "rootName : " + rootName,
        //         icon: 'question',
        //         showCancelButton: true,
        //         confirmButtonText: 'Yes',
        //         cancelButtonText: 'No'
        //     })
        //     .then((result) => {
        //         if (result.isConfirmed) {
        //             var resInsert = insertItemDefinition(itemID, rootID, itemName, engName, chtName, itemType);  
        //             printResult(resInsert);
                    
        //             var response = getItemDefinition();
        //             responseformodal = response;
        //             //console.log("response : ", response);
                    
        //             $('#itemDefinition tbody').empty()
        //             let element = '';
        //             for(let i=0;i<response.itemID.length;i++){
        //                 element += `<tr>
        //                     <td>${response.itemID[i]}</td>
        //                     <td>${response.rootID[i]}</td>
        //                     <td>${response.itemName[i]}</td>
        //                     <td>${response.engName[i]}</td>
        //                     <td>${response.chtName[i]}</td>
        //                     <td>${responseItem.itemType[i]}</td>
        //                     </tr>`;
        //             }
        //             $('#itemDefinition tbody').append(element);
        //         } else{
        //             Swal.fire({
        //                 title: 'Request Canceled',
        //                 icon: 'info',
        //             })
        //         }
        //     });

        //showModalStatics(event.target);
    }

    //新增leadingNode
    function appendNewleadingNode(target, tableType, textArray, internalNodeID, rootID){
        responseformodal = responseItem;
        var nameArray = responseformodal.itemName;   
        var chtArray = responseformodal.chtName;
        var engArray = responseformodal.engName;
        var itemIDArray = responseformodal.itemID;
        var rootIDArray = responseformodal.rootID;
        var itemTypeArray = responseformodal.itemType;
        console.log("itemTypeArray : ", itemTypeArray);

        var modal = document.getElementById("modal");
        modal.style.display = "block";
        //console.log("modal : ", modal);

        var closeButton = document.querySelector('.btn-close');

        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });


        ////console.log("keyArray : ", keyArray);
        ////console.log("valueArray : ", valueArray);

        const container = document.getElementById('result_data'); // example container 
        container.innerHTML = ''; // empty the container
        var lengthOfRecord = $(target).parents('tr').children('td').length;
        //console.log("lengthOfRecord : ", lengthOfRecord);
        var text = "";
        var textArray = [];
        for(var i=1 ; i<lengthOfRecord ; i++){
            if ($(target).parents('tr').children('td').eq(i).attr('class') === "show"){
                text += "「" + $(target).parents('tr').children('td').eq(i).html() + "」 ";
                textArray.push($(target).parents('tr').children('td').eq(i).html());
            }
        }
        var number = document.createElement('span');
        number.innerHTML = "Using : " + text;
        container.appendChild(number); // append the dropdown to the container element
        
        //itemID
        var itemID = document.createElement('span');
        itemID.innerHTML = "<br><br>輸入itemID : ";
        container.appendChild(itemID); // append the dropdown to the container element
        itemID = document.createElement('input');
        var length = itemIDArray.length;
        itemID.placeholder = `input itemID, 目前最大值為 : ${itemIDArray[length-1]}`;
        itemID.className = "form-control";
        itemID.id = "inputItemID";
        itemID.innerHTML = itemIDArray[length-1]+1;
        itemID.value = itemIDArray[length-1]+1;
        container.appendChild(itemID); // append the dropdown to the container element

        
        //rootID
        
        // var rootID = document.createElement('span');
        // rootID.innerHTML = "<br><br>itemID : ";
        // container.appendChild(rootID); // append the dropdown to the container element
        var dropdown1 = document.createElement('select'); // create a new dropdown element
        dropdown1.className = "form-select";
        dropdown1.id = `SelectrootID`;
        text = "<br><br>選擇rootID : ";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element
        var element = "";
        // console.log("internalNodeID : ", internalNodeID);
        var chtname = "";
        var engname = "";
        for (let j = 0; j < nameArray.length; j++) {
            var option = document.createElement('option');
            option.text = itemIDArray[j].toString() + " | " + nameArray[j] + " | " + chtArray[j]; 
            option.value = itemIDArray[j]; 
            option.itemID = itemIDArray[j];
            if (itemTypeArray[j] === 1){
                dropdown1.add(option);
            }
            // console.log("itemIDArray[j] : ", itemIDArray[j]);
            if(itemIDArray[j].toString() === internalNodeID){
                option.setAttribute('selected', true);
                chtname = chtArray[j];
                engname = engArray[j];
            }
        }
        container.appendChild(dropdown1); 
        dropdown1.setAttribute("disabled", true);


        //itemName
        var itemName = document.createElement('span');
        itemName.innerHTML = "<br><br>輸入itemName : ";
        container.appendChild(itemName); // append the dropdown to the container element
        itemName = document.createElement('input');
        itemName.placeholder = "input itemName";
        itemName.className = "form-control";
        itemName.id = "inputItemName";
        var text = "";
        for (var i=0 ; i<textArray.length ; i++){
            if(textArray[i] === "[SPACE]"){
                text += " ";
            }
            else{
                text += textArray[i];
            }
        }
        itemName.value = text;
        itemName.innerHTML = text;
        container.appendChild(itemName); // append the dropdown to the container element

        
        //engName
        var engName = document.createElement('span');
        engName.innerHTML = "<br><br>輸入engName : ";
        container.appendChild(engName); // append the dropdown to the container element
        engName = document.createElement('input');
        engName.placeholder = "input engName";
        engName.className = "form-control";
        engName.id = "inputEngName";
        engName.innerHTML = engname;
        engName.value = engname;
        container.appendChild(engName); // append the dropdown to the container element

        
        //chtName
        var chtName = document.createElement('span');
        chtName.innerHTML = "<br><br>輸入chtName : ";
        container.appendChild(chtName); // append the dropdown to the container element
        chtName = document.createElement('input');
        chtName.placeholder = "input chtName";
        chtName.className = "form-control";
        chtName.id = "inputChtName";
        chtName.innerHTML = chtname;
        chtName.value = chtname;
        container.appendChild(chtName); // append the dropdown to the container element

        //綁定group1
        var dropdown1 = document.createElement('select'); // create a new dropdown element
        dropdown1.className = "form-select";
        dropdown1.id = `group1`;
        text = "<br><br>選擇group1 : ";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element
        var element = "";
        for (let j = 0; j < nameArray.length; j++) {
            var option = document.createElement('option');
            option.text = itemIDArray[j].toString() + " | " + nameArray[j] + " | " + chtArray[j]; 
            option.value = itemIDArray[j]; 
            option.itemID = itemIDArray[j];
            if (itemTypeArray[j] === 3 && rootIDArray[j].toString() === rootID){
                dropdown1.add(option);
            }
        }
        container.appendChild(dropdown1); 
        console.log("tableType : ", tableType);
        // if(tableType === "5"){
            //綁定group2
            var dropdown1 = document.createElement('select'); // create a new dropdown element
            dropdown1.className = "form-select";
            dropdown1.id = `group2`;
            text = "<br><br>選擇group2 : ";
            number = document.createElement('span');
            number.innerHTML = text;
            container.appendChild(number); // append the dropdown to the container element
            var element = "";
            for (let j = 0; j < nameArray.length; j++) {
                var option = document.createElement('option');
                option.text = itemIDArray[j].toString() + " | " + nameArray[j] + " | " + chtArray[j]; 
                option.value = itemIDArray[j]; 
                option.itemID = itemIDArray[j];
                if (itemTypeArray[j] === 3 && rootIDArray[j].toString() === rootID){
                    dropdown1.add(option);
                }
            }
            container.appendChild(dropdown1); 

        // }

        
        //itemType
        var itemType = document.createElement('span');
        itemType.innerHTML = "<br>itemType為 '2' (leadingNode)<br>";
        container.appendChild(itemType); // append the dropdown to the container element

        var button = document.createElement('button'); // create a new button element
        button.textContent = '儲存'; // set the text of the button
        button.id = 'leadingNodeStoreButton'; // set the text of the button
        button.classList.add('btn', 'btn-secondary'); // add classes to the button

        // add a click event listener to the button
        button.addEventListener('click', function() {
            // //console.log("確認儲存");
            var html = "";
            Swal.fire({
                title: '確認儲存此leadingNode?',
                icon: 'question',
                html: html,
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            })
            .then((result) => {
                if (result.isConfirmed) {
                    button.disabled = true;
                    var btn = document.getElementById("leadingNodeStoreButton");
                    var text = "儲存中";
                    var count = 0;
                    button.disabled = true; // Disable the button during the search

                    var reportID = "1";
                    var intervalId = setInterval(function() {
                        count++;
                        if (count > 3) {
                        count = 0;
                        }
                        switch (count) {
                        case 0:
                            button.innerHTML = text;
                            break;
                        case 1:
                            button.innerHTML = text + ".";
                            break;
                        case 2:
                            button.innerHTML = text + "..";
                            break;
                        case 3:
                            button.innerHTML = text + "...";
                            break;
                        }
                    }, 500); // Update the text every 500 milliseconds
                    
                    


                    var itemID = document.getElementById("inputItemID").value;
                    var rootID = document.getElementById("SelectrootID").value;
                    var itemName = document.getElementById("inputItemName").value;
                    var engName = document.getElementById("inputEngName").value;
                    var chtName = document.getElementById("inputChtName").value;
                    var itemType = "2";

                    var rootName = "";
                    //console.log("itemID : ", itemID);
                    //console.log("rootID : ", rootID);
                    //console.log("itemName : ", itemName);
                    //console.log("engName : ", engName);
                    //console.log("chtName : ", chtName);
                    //console.log("itemType : ", itemType);
                    // if (rootID === "0"){
                    //     rootName = "無";
                    // }
                    // else{
                    //     var response = searchItem(rootID);
                    //     //console.log("response : ", response);
                    //     // printResult(response);
                    //     rootName = response.chtName;
                    // }
                    
                    //console.log("rootName : ", rootName);
                    var leadingID = [];
                    var groupingID = [];
                    try{
                        
                            
                        if (rootName == undefined){
                            // Swal.fire({
                            //     title: '父節點錯誤',
                            //     icon: 'error',
                            // })
                            throw new Error('父節點錯誤');
                        }
                        else{
                            // Swal.fire({
                            //     title: '父節點成功',
                            //     icon: 'success',
                            // })
                            
                            leadingID.push(itemID);
                            var groupID1 = document.getElementById("group1").value;
                            
                            groupingID.push(groupID1);
                            // if(tableType === "5"){                            
                                var groupID2 = document.getElementById("group2").value;
                                groupingID.push(groupID2);
                            // }
                            if (itemID == ""){
                                // Swal.fire({
                                //     title: 'itemID不可為空',
                                //     icon: 'error',
                                // })
                                
                                throw new Error('itemID不可為空');
                            }
                            if (groupID1 != groupID2){
                                // console.log("leadingID : ", leadingID);
                                // console.log("groupingID : ", groupingID);
                                // var resTrans = insertLeadingGroup(leadingID, groupingID);
                                // printResult(resTrans);
                                // if (resTrans.status != "0"){
                                //     throw new Error(resTrans.ERRMSG);
                                // }
                                console.log("leadingID : ", leadingID);
                                var resInsert = insertItemDefinition(itemID, rootID, itemName, engName, chtName, itemType, leadingID, groupingID);  
                                printResult(resInsert);
                                
                                if (resInsert.status === "0"){
                                    
                                    getitemTable();
                                    // var response = getItemDefinition();
                                    // responseformodal = response;
                                    // //console.log("response : ", response);
                        
                                    // $('#itemDefinition tbody').empty()
                                    // let element = '';
                                    // for(let i=0;i<response.itemID.length;i++){
                                    //     element += `<tr>
                                    //         <td>${response.itemID[i]}</td>
                                    //         <td>${response.rootID[i]}</td>
                                    //         <td>${response.itemName[i]}</td>
                                    //         <td>${response.engName[i]}</td>
                                    //         <td>${response.chtName[i]}</td>
                                    //         <td>${responseItem.itemType[i]}</td>
                                    //         </tr>`;
                                    // }
                                    // $('#itemDefinition tbody').append(element);
                                    
                                    modal.style.display = "none";
                                    $(target).removeClass("btn-secondary");
                                    $(target).addClass("btn-danger");
                                }
                                else{
                                    throw new Error(resInsert.ERRMSG);
                                }
                            }
                            else{
                                // Swal.fire({
                                //     title: 'group1 與 group2 不可相同!',
                                //     icon: 'error',
                                //     confirmButtonText: 'ok',
                                // })
                                throw new Error('group1 與 group2 不可相同!');
                            }
                        }
                    } catch (error) {
                        if (error instanceof Error) {
                            Swal.fire({
                                title: 'Error',
                                text: error,
                                icon: 'error',
                                confirmButtonText: 'Ok',
                            })
                            
                            button.disabled = false;
                            clearInterval(intervalId);
                            return;
                        }
                    }
                    

                    
                    
                    button.disabled = false;
                    clearInterval(intervalId);
                        
                }
            });
        });

        // append the button to the document body
        container.appendChild(button);
    }

    
    function selectRoot(){
        var res;
        $.ajax({
            async: false,
            type: 'POST',
            url: '{% url "mark:selectRoot" %}',
            success:function (response){
                res = response;
                //console.log("selectRoot : ", response)
            },
        });
        return res;
    }
    function selectInteralNodeofRoot(rootID, itemType){
        var res;
        $.ajax({
            async: false,
            type: 'POST',            
            data:JSON.stringify({
                'rootID': rootID,
                'itemType': itemType,
            }),
            url: '{% url "mark:selectInteralNodeofRoot" %}',
            success:function (response){
                res = response;
                //console.log("selectRoot : ", response)
            },
        });
        return res;
    }
    
    function selectGroupNodeofRoot(rootID, itemType){
        var res;
        $.ajax({
            async: false,
            type: 'POST',            
            data:JSON.stringify({
                'rootID': rootID,
                'itemType': itemType,
            }),
            url: '{% url "mark:selectGroupNodeofRoot" %}',
            success:function (response){
                res = response;
                //console.log("selectRoot : ", response)
            },
        });
        return res;
    }
    function getREofRecord2(){
        ////console.log(event.target);
        //showModalReportText(event.target);
        // var token1 = $(event.target).parents('tr').children('td').eq(1).html();
        // var token2 = $(event.target).parents('tr').children('td').eq(2).html();
        // showModalStatics2(event.target);

        var token1 = $(event.target).parents('tr').children('td').eq(1).html();
        var token2 = $(event.target).parents('tr').children('td').eq(2).html();
        var target = event.target;

        
        //1. 選root
        var resRoot = selectRoot();
        //console.log("resRoot : ", resRoot);
        var rootArray = resRoot.chtName;
        var element = `<select class="form-select" id="rootSelect">`
        for(var i=0 ; i<rootArray.length ; i++){
            element += `<option value="${rootArray[i].itemID}" id="root${rootArray[i].itemID}">${rootArray[i].chtName}</option>`
        }
        element += `</select>`
        Swal.fire({
            title: '請選擇root',
            html: element,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No'
        })
        .then((result) => {
            if (result.isConfirmed) {
                var rootID = document.getElementById("rootSelect").value;
                var chtNameRoot = document.getElementById(`root${rootID}`).innerHTML;
                
                // Swal.fire({
                //     title: `rootID = ${rootID}, chtName = ${chtNameRoot}`,
                //     html: "123",
                //     icon: 'info',
                //     showCancelButton: true,
                //     confirmButtonText: 'Yes',
                //     cancelButtonText: 'No'
                // })
                // 2. 選該root的leading
                
                var resInternalNode = selectInteralNodeofRoot(rootID, "1");
                //console.log("resInternalNode : ", resInternalNode);
                var internalNodeArray = resInternalNode.chtName;
                element = `<select class="form-select" id="internalNodeSelect">`
                if (internalNodeArray == undefined ){
                    Swal.fire({
                        title: '此root無相關子節點, 請重新選擇',
                        icon: 'error',
                        confirmButtonText: 'ok',
                    })
                    return;
                }
                for(var i=0 ; i<internalNodeArray.length ; i++){
                    element += `<option value="${internalNodeArray[i].itemID}" id="internal${internalNodeArray[i].itemID}">${internalNodeArray[i].chtName} ${internalNodeArray[i].itemName}</option>`
                }
                element += `</select>`




                Swal.fire({
                    title: '請選擇internal Node',
                    html: element,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'No'
                })
                .then((result) => {
                    if (result.isConfirmed) {
                        var internalNodeID = document.getElementById("internalNodeSelect").value;
                        //console.log("internalNodeID : ", internalNodeID);
                        var chtNameInternal = document.getElementById(`internal${internalNodeID}`).innerHTML;
                        //console.log("chtNameInternal : ", chtNameInternal);

                        var resLeadingNode = selectInteralNodeofRoot(internalNodeID, "2");
                        //console.log("resLeadingNode : ", resLeadingNode);

                        
                        
                        element = `<select class="form-select" id="leadingNodeSelect">`
                        if (resLeadingNode.status === "0"){                            
                            var leadingNodeArray = resLeadingNode.chtName;
                            for(var i=0 ; i<leadingNodeArray.length ; i++){
                                element += `<option value="${leadingNodeArray[i].itemID}" id="leading${leadingNodeArray[i].itemID}" itemName="${leadingNodeArray[i].itemName}">${leadingNodeArray[i].chtName}   ${leadingNodeArray[i].itemName}</option>`
                            }
                        }
                        element += `</select>`
                        
                        Swal.fire({
                            title: '請選擇leading Node',
                            html: element,
                            icon: 'info',
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonText: 'Yes',
                            cancelButtonText: 'No',
                            denyButtonText: `新增`,
                        })
                        .then((result) => {
                            if (result.isConfirmed) {
                                var leadingID = document.getElementById("leadingNodeSelect").value;
                                var selectedItemName = $("#leadingNodeSelect option:selected").attr("itemName");
                                console.log("selectedItemName : ", selectedItemName);
                                $("#storebtn").attr("leadingID", leadingID);
                                $("#storebtn").attr("itemName", selectedItemName);
                                var chtNameleading = document.getElementById(`leading${leadingID}`).innerHTML;

                                //console.log("leadingID : ", leadingID);

                                var resgroupNode = selectGroupNodeofRoot(leadingID, "3");
                                console.log("resgroupNode : ", resgroupNode);
                                printResult(resgroupNode);
                                var groupNodeArray = resgroupNode.chtName;
                                element = `<select class="form-select" id="groupNodeSelect">`
                                for(var i=0 ; i<groupNodeArray.length ; i++){
                                    element += `<option value="${groupNodeArray[i].itemID}" id="group${groupNodeArray[i].itemID}">${groupNodeArray[i].itemName}</option>`
                                }
                                element += `</select>`

                                var element1 = `<select class="form-select" id="groupNodeSelect1">`
                                for(var i=0 ; i<groupNodeArray.length ; i++){
                                    element1 += `<option value="${groupNodeArray[i].itemID}" id="group${groupNodeArray[i].itemID}" selected>${groupNodeArray[i].itemName}</option>`
                                }
                                element1 += `</select>`
                                
                                element += element1;
                                if (groupNodeArray.length > 0){
                                    Swal.fire({
                                        title: '已找到如下groupingID',
                                        html: element,
                                        icon: 'info',
                                        showCancelButton: true,
                                        confirmButtonText: 'Yes',
                                        cancelButtonText: 'No'
                                    })
                                    .then((result) => {
                                        if (result.isConfirmed) {
                                            console.log("target : ", target);
                                            //console.log("groupNodeSelect : ", groupNodeSelect.value);
                                            var selectedGroup = groupNodeSelect.value;
                                            var selectedGroup1 = groupNodeSelect1.value;
                                            if(selectedGroup === selectedGroup1){
                                                Swal.fire({
                                                    title: '不可選擇相同item',
                                                    icon: 'error',
                                                    confirmButtonText: 'ok',
                                                })
                                            }
                                            selectLeading = chtNameleading;
                                            //console.log("selectLeading : ", selectLeading);
                                            showModalStatics2(target, resgroupNode, selectedGroup, selectLeading, leadingID, selectedGroup1);
                                        }else{
                                            Swal.fire({
                                                title: 'Request Canceled',
                                                icon: 'info',
                                            })
                                        }
                                    });
                                }else{
                                    Swal.fire({
                                        title: '未發現相關groupingNode, 請設定',
                                        // html: element,
                                        icon: 'info',
                                        confirmButtonText: 'ok',
                                    })
                                    // .then((result) => {
                                    //     if (result.isConfirmed) {
                                    //         appendNewgroupingNode(target);
                                    //     }else{
                                    //         Swal.fire({
                                    //             title: 'Request Canceled',
                                    //             icon: 'info',
                                    //         })
                                    //     }
                                    // });
                                }

                            }else if (result.isDenied){
                                //Swal.fire('Denied', '', 'info');
                                
                                var lengthOfRecord = $(target).parents('tr').children('td').length;
                                //console.log("lengthOfRecord : ", lengthOfRecord);
                                var text = "";
                                var textArray = [];
                                for(var i=1 ; i<lengthOfRecord ; i++){
                                    if ($(target).parents('tr').children('td').eq(i).attr('class') === "show"){
                                        text += "「" + $(target).parents('tr').children('td').eq(i).html() + "」 ";
                                        textArray.push($(target).parents('tr').children('td').eq(i).html());
                                    }
                                }
                                console.log("textArray : ", textArray);
                                appendNewleadingNode(target, "5", textArray, internalNodeID, rootID);
                            }
                            else{
                                Swal.fire({
                                    title: 'Request Canceled',
                                    icon: 'info',
                                })
                            }
                        });
                        

                    } else{
                        Swal.fire({
                            title: 'Request Canceled',
                            icon: 'info',
                        })
                    }
                });









            } else{
                Swal.fire({
                    title: 'Request Canceled',
                    icon: 'info',
                })
            }
        });
    }

    function showModalStatics(target, resgroupNode, selectedGroup, selectLeading, leadingID) {
		var modal = document.getElementById("modal");
        modal.style.display = "block";
        //console.log("modal : ", modal);

        var closeButton = document.querySelector('.btn-close');

        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });


        ////console.log("keyArray : ", keyArray);
        ////console.log("valueArray : ", valueArray);

        const container = document.getElementById('result_data'); // example container 
        container.innerHTML = ''; // empty the container
        var lengthOfRecord = $(target).parents('tr').children('td').length;
        //console.log("lengthOfRecord : ", lengthOfRecord);
        var text = "";
        var textArray = [];
        for(var i=1 ; i<lengthOfRecord ; i++){
            if ($(target).parents('tr').children('td').eq(i).attr('class') === "show"){
                text += "「" + $(target).parents('tr').children('td').eq(i).html() + "」 ";
                textArray.push($(target).parents('tr').children('td').eq(i).html());
            }
        }
        var number = document.createElement('span');
        number.innerHTML = "Using : " + text;
        container.appendChild(number); // append the dropdown to the container element

        text = "<br><br>Select range for building RE : ";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element

        for (var i = 0; i<3 ; i++) {            
            const dropdown = document.createElement('select'); // create a new dropdown element
            dropdown.className = "form-select";
            dropdown.id = `selectItem${i}`;
            
            
            // dropdown.onchange = () => {
            //     var selectedOption = this.options[0];
            //     console.log("selectedOption : ", selectedOption);
            // };

            var element = "";
            for (var j = 0; j < textArray.length; j++) {
                //element += `<tr>
                //<td>${response.itemID[i]}</td>
                //<td>${response.rootID[i]}</td>
                //<td>${response.itemName[i]}</td>
                //<td>${response.engName[i]}</td>
                //<td>${response.chtName[i]}</td>
                //</tr>`;
                const option = document.createElement('option'); // create a new option element
                option.text = textArray[j];
                option.value = textArray[j]; 
                option.id = `option${i.toString()}${j.toString}`; // set the text of the option
                dropdown.add(option); // add the option to the dropdown
                // //console.log("nameArray[j], keyArray[i]", nameArray[j], keyArray[i]);
                // if (nameArray[j] == keyArray[i]){
                //     //console.log("nameArray[j], keyArray[i]", nameArray[j], keyArray[i]);
                //     option.setAttribute('selected', true);
                // }
                option.setAttribute('position', j);
                if ((i == 0 && j == 0) || (i == 1 && j == textArray.length-1) || (i == 2 && j == textArray.length-2)){
                    option.setAttribute('selected', true);
                }
            }
            
            if (i == 0){
                text = "<br><br>From : ";
                number = document.createElement('span');
                number.innerHTML = text;
                container.appendChild(number); // append the dropdown to the container element
            }
            else if (i == 1){
                text = "<br>To : ";
                number = document.createElement('span');
                number.innerHTML = text;
                container.appendChild(number); // append the dropdown to the container element
            }
            else if(i == 2){
                text = "<br>Extract Value : ";
                number = document.createElement('span');
                number.innerHTML = text;
                container.appendChild(number); // append the dropdown to the container element
            }
            
            container.appendChild(dropdown);// append the dropdown to the container element
        }

        

        
        responseformodal = responseItem;
        var nameArray = responseformodal.itemName;   
        var chtArray = responseformodal.chtName;   
        var itemIDArray = responseformodal.itemID;
        
        const dropdown1 = document.createElement('select'); // create a new dropdown element
        dropdown1.className = "form-select";
        dropdown1.id = `SelectitemName`;
        text = "<br>itemName: ";
        number = document.createElement('span');
        var element = "";
        var autoSelect = 0;
        for (let j = 0; j < nameArray.length; j++) {            
            const option = document.createElement('option');
            option.text = nameArray[j] + " " + chtArray[j]; 
            option.value = nameArray[j]; 
            option.itemID = itemIDArray[j];
            if (option.itemID == selectedGroup){
                option.setAttribute('selected', true);
                autoSelect = 1;
            }
            dropdown1.add(option);            
        }
        if (autoSelect == 1){
            dropdown1.disabled = true;
            text = `<br>已自動選擇"${selectLeading}"的itemName`;
        }
        $("#storebtn").attr("autoSelect", autoSelect);
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element
        container.appendChild(dropdown1); 
        

        // if ((i == 0 && j == 0) || (i == 1 && j == textArray.length-1)){
        //     option.setAttribute('selected', true);
        // }
        text = "<br>";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element
        
        const button = document.createElement('button'); // create a new button element
        button.textContent = '自動建立RE'; // set the text of the button
        button.id = 'generateREButton'; // set the text of the button
        button.classList.add('btn', 'btn-secondary'); // add classes to the button
        button.setAttribute('lastReportID', $(target).parents('tr').attr("reportID"));

        
        


        // add a click event listener to the button
        button.addEventListener('click', function() {

            var ExtractValue = document.getElementById("selectItem2").value;
            var extractPos = textArray.indexOf(ExtractValue);
            var itemName = document.getElementById("SelectitemName").value;
            var RE = "";

            var startWord = document.getElementById("selectItem0").value;
            var startPos = textArray.indexOf(startWord);
            var endWord = document.getElementById("selectItem1").value;
            var endPos = textArray.indexOf(endWord);

            var poscheck = checkPos(startPos, endPos, extractPos);
            if (poscheck == "1"){
                return;
            } 

            for (var i=startPos ; i<textArray.length ; i++){
                if ( textArray[i] == "\\."){
                    textArray[i] = "."
                }
                if (ExtractValue == textArray[i]){
                    RE += "(";
                    RE += `?<${itemName}>`;
                }

                var pattern = /[\\^$.|?*+(){[}\]\"]/g;
                var matches = textArray[i].match(pattern);
                //console.log("matches : ", matches);
                if (textArray[i] == "[SPACE]" ){    
                    RE += " ";
                }
                else if (textArray[i] == "[Number]"){        
                    RE += "\\d+" ;
                }
                else if (matches && textArray[i] != "[Number]"){        
                    RE += "\\" + textArray[i];    
                }
                else {
                    RE += textArray[i];
                }
                
                if (ExtractValue == textArray[i]){
                    RE += ")";
                }
            }

            
            var from = $("#selectItem0").find(':selected').attr("position");
            console.log("from : ", from);
            
            var to = $("#selectItem1").find(':selected').attr("position");
            console.log("to : ", to);

            var no = $(target).parents('tr').children('td').eq(0).children('button').html();
            console.log("no : ", no);
                
            console.log("RE : ", RE);
            var html = `<div class="form-floating mb-3">
                        <input class="form-control" id="floatingInput" placeholder="RE" value='${RE}'>
                        <label for="floatingInput">Auto generated RE</label>
                        </div>`
            console.log("html : ", html);
            Swal.fire({
                title: '自動填入此RE?',
                icon: 'question',
                html: html,
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            })
            .then((result) => {
                if (result.isConfirmed) {
                    // //console.log("success");
                    var storeButton = document.getElementById("storebtn");
                    storeButton.setAttribute("from", from);
                    storeButton.setAttribute("to", to);
                    storeButton.setAttribute("no", no);

                    var regexFinished = document.getElementById("floatingInput").value;
                    document.getElementById("regexText").innerHTML = regexFinished;
                    document.getElementById("regexText").value = regexFinished;
                    modal.style.display = "none";
                    //console.log("this : ", this.getAttribute("lastReportID"));
                    var reportID = this.getAttribute("lastReportID");
                    //找report
                    var report = getReportBylastReportID(reportID.toString());
                    //console.log("report : ", report);

                    var inputElement = document.querySelector('#regexName');
                    emphasizeInput(inputElement);
                    var regexText = document.querySelector('#regexText');
                    emphasizeInput(regexText);

                } 
                else{
                    //console.log("fail");
                }                
            });
        });

        // append the button to the document body
        container.appendChild(button);

        // //console.log("target : ", target.innerHTML);
        // //console.log("reportID : ", $(target).parents('tr').attr("reportID"));
        // $("#storebtn").attr("lastReportID", $(target).parents('tr').attr("reportID"));
    } 

    function showModalStatics2(target, resgroupNode, selectedGroup, selectLeading, leadingID, selectedGroup1) {
        console.log("target : ", target);
		var modal = document.getElementById("modal");
        modal.style.display = "block";
        //console.log("modal : ", modal);

        var closeButton = document.querySelector('.btn-close');

        closeButton.addEventListener('click', function() {
            modal.style.display = 'none';
        });


        ////console.log("keyArray : ", keyArray);
        ////console.log("valueArray : ", valueArray);

        const container = document.getElementById('result_data'); // example container 
        container.innerHTML = ''; // empty the container
        var lengthOfRecord = $(target).parents('tr').children('td').length;
        //console.log("lengthOfRecord : ", lengthOfRecord);
        var text = "";
        var textArray = [];
        for(var i=1 ; i<lengthOfRecord ; i++){
            if ($(target).parents('tr').children('td').eq(i).attr('class') === "show"){
                text += "「" + $(target).parents('tr').children('td').eq(i).html() + "」 ";
                textArray.push($(target).parents('tr').children('td').eq(i).html());
            }
        }
        console.log("text : ", text);
        var number = document.createElement('span');
        number.innerHTML = "Using : " + text;
        container.appendChild(number); // append the dropdown to the container element

        text = "<br><br>Select range for building RE : ";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element

        for (let i = 0; i<4 ; i++) {            
            const dropdown = document.createElement('select'); // create a new dropdown element
            dropdown.className = "form-select";
            dropdown.id = `selectItem${i}`;
            var element = "";
            for (let j = 0; j < textArray.length; j++) {
                //element += `<tr>
                //<td>${response.itemID[i]}</td>
                //<td>${response.rootID[i]}</td>
                //<td>${response.itemName[i]}</td>
                //<td>${response.engName[i]}</td>
                //<td>${response.chtName[i]}</td>
                //</tr>`;
                const option = document.createElement('option'); // create a new option element
                option.text = textArray[j];
                option.value = textArray[j]; 
                option.id = `option${i.toString()}${j.toString}`; // set the text of the option
                
                dropdown.add(option); // add the option to the dropdown
                // //console.log("nameArray[j], keyArray[i]", nameArray[j], keyArray[i]);
                // if (nameArray[j] == keyArray[i]){
                //     //console.log("nameArray[j], keyArray[i]", nameArray[j], keyArray[i]);
                //     option.setAttribute('selected', true);
                // }
                if ((i == 0 && j == 0) || (i == 1 && j == textArray.length-1) || (i == 2 && j == textArray.length-4) || (i == 3 && j == textArray.length-2)){
                    option.setAttribute('selected', true);
                }
            }
            
            if (i == 0){
                text = "<br><br>From : ";
                number = document.createElement('span');
                number.innerHTML = text;
                container.appendChild(number); // append the dropdown to the container element
            }
            else if (i == 1){
                text = "<br>To : ";
                number = document.createElement('span');
                number.innerHTML = text;
                container.appendChild(number); // append the dropdown to the container element
            }
            else if(i == 2){
                text = "<br>Extract Value1 : ";
                number = document.createElement('span');
                number.innerHTML = text;
                container.appendChild(number); // append the dropdown to the container element
            }
            else if(i == 3){
                text = "<br>Extract Value2 : ";
                number = document.createElement('span');
                number.innerHTML = text;
                container.appendChild(number); // append the dropdown to the container element
            }
            
            container.appendChild(dropdown);// append the dropdown to the container element
        }
        
            
        text = "<br>※item1 必須不等於 item2 !!";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element

        

        
        responseformodal = responseItem;
        var nameArray = responseformodal.itemName;   
        var chtArray = responseformodal.chtName;   
        var itemIDArray = responseformodal.itemID;
        
        const dropdown1 = document.createElement('select'); // create a new dropdown element
        dropdown1.className = "form-select";
        dropdown1.id = `SelectitemName`;
        text = "<br>itemName1: ";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element
        var element = "";        
        var autoSelect = 0;
        for (let j = 0; j < nameArray.length; j++) {            
            const option = document.createElement('option');
            option.text = nameArray[j] + " " + chtArray[j]; 
            option.value = nameArray[j]; 
            option.itemID = itemIDArray[j];
            
            if (option.itemID == selectedGroup){
                option.setAttribute('selected', true);
                autoSelect = 1;
            }
            dropdown1.add(option); 
            
        }        
        if (autoSelect == 1){
            dropdown1.disabled = true;
            text = `<br>已自動選擇"${selectLeading}"的itemName`;
        }
        $("#storebtn").attr("autoSelect", autoSelect);
        container.appendChild(dropdown1); 

        const dropdown2 = document.createElement('select'); // create a new dropdown element
        dropdown2.className = "form-select";
        dropdown2.id = `SelectitemName1`;
        text = "<br>itemName2: ";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element
        var element = "";
        autoSelect = 0;
        for (let j = 0; j < nameArray.length; j++) {            
            const option = document.createElement('option');
            option.text = nameArray[j] + " " + chtArray[j]; 
            option.value = nameArray[j]; 
            option.itemID = itemIDArray[j];
            if (option.itemID == selectedGroup1){
                option.setAttribute('selected', true);
                autoSelect = 1;
            }
            dropdown2.add(option); 
            
        }
        
        if (autoSelect == 1){
            dropdown2.disabled = true;
            text = `<br>已自動選擇"${selectLeading}"的itemName`;
        }
        $("#storebtn").attr("autoSelect", autoSelect);
        container.appendChild(dropdown2); 

        // if ((i == 0 && j == 0) || (i == 1 && j == textArray.length-1)){
        //     option.setAttribute('selected', true);
        // }
        text = "<br>";
        number = document.createElement('span');
        number.innerHTML = text;
        container.appendChild(number); // append the dropdown to the container element
        
        const button = document.createElement('button'); // create a new button element
        button.textContent = '自動建立RE'; // set the text of the button
        button.id = 'generateREButton'; // set the text of the button
        button.classList.add('btn', 'btn-secondary'); // add classes to the button
        button.setAttribute('lastReportID', $(target).parents('tr').attr("reportID"));

        
        


        // add a click event listener to the button
        button.addEventListener('click', function() {

            var ExtractValue = document.getElementById("selectItem2").value;
            var ExtractValue1 = document.getElementById("selectItem3").value;
            var extractPos = textArray.indexOf(ExtractValue);
            var extractPos1 = textArray.indexOf(ExtractValue1, extractPos+1);
            var itemName = document.getElementById("SelectitemName").value;
            var itemName1 = document.getElementById("SelectitemName1").value;
            var RE = "";

            var startWord = document.getElementById("selectItem0").value;
            var startPos = textArray.indexOf(startWord);
            var endWord = document.getElementById("selectItem1").value;
            var endPos = textArray.indexOf(endWord);

            var poscheck = checkPos1(startPos, endPos, extractPos, extractPos1);
            if (poscheck == "1"){
                return;
            } 

            var itemNum = 0;
            for (var i=startPos ; i<textArray.length ; i++){
                if ( textArray[i] == "\\."){
                    textArray[i] = "."
                }
                if (ExtractValue == textArray[i] && itemNum === 0){
                    RE += "(";
                    RE += `?<${itemName}>`;
                    itemNum = 1;
                    var pattern = /[\\^$.|?*+(){[}\]]/g;
                    var matches = textArray[i].match(pattern);
                    //console.log("matches : ", matches);
                    if (textArray[i] == "[SPACE]" ){    
                        RE += " ";
                    }
                    else if (textArray[i] == "[Number]"){        
                        RE += "\\d+" ;
                    }
                    else if (matches && textArray[i] != "[Number]"){        
                        RE += "\\" + textArray[i];    
                    }
                    else {
                        RE += textArray[i];
                    }
                    if (ExtractValue == textArray[i]){
                        RE += ")";
                    }
                    continue;
                }
                if (ExtractValue1 == textArray[i]){
                    RE += "(";
                    RE += `?<${itemName1}>`;
                    itemNum = 2;
                    var pattern = /[\\^$.|?*+(){[}\]]/g;
                    var matches = textArray[i].match(pattern);
                    //console.log("matches : ", matches);
                    if (textArray[i] == "[SPACE]" ){    
                        RE += " ";
                    }
                    else if (textArray[i] == "[Number]"){        
                        RE += "\\d+" ;
                    }
                    else if (matches && textArray[i] != "[Number]"){        
                        RE += "\\" + textArray[i];    
                    }
                    else {
                        RE += textArray[i];
                    }
                    if (ExtractValue == textArray[i]){
                        RE += ")";
                    }
                    continue;
                }
                
                var pattern = /[\\^$.|?*+(){[}\]\"]/g;
                var matches = textArray[i].match(pattern);
                //console.log("matches : ", matches);
                if (textArray[i] == "[SPACE]" ){    
                    RE += " ";
                }
                else if (textArray[i] == "[Number]"){        
                    RE += "\\d+" ;
                }
                else if (matches && textArray[i] != "[Number]"){        
                    RE += "\\" + textArray[i];    
                }
                else {
                    RE += textArray[i];
                }
                
                // if (ExtractValue1 == textArray[i] && itemNum === 2){
                //     RE += ")";
                // }
            }


            var html = `<div class="form-floating mb-3">
                        <input type="email" class="form-control" id="floatingInput" placeholder="RE" value='${RE}'>
                        <label for="floatingInput">Auto generated RE</label>
                        </div>`







            var from = $("#selectItem0").find(':selected').attr("position");
            console.log("from : ", from);
            
            var to = $("#selectItem1").find(':selected').attr("position");
            console.log("to : ", to);

            var no = $(target).parents('tr').children('td').eq(0).children('button').html();
            console.log("no : ", no);


            //console.log("textArray : ", textArray);
            Swal.fire({
                title: '自動填入此RE?',
                icon: 'question',
                html: html,
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            })
            .then((result) => {
                if (result.isConfirmed) {
                    var item1 = $("#SelectitemName").val();
                    var item2 = $("#SelectitemName1").val();
                    //console.log("item1 : ", item1);
                    //console.log("item2 : ", item2);
                    if (item1 === item2){
                        Swal.fire({
                            title: 'itemName不可相同',
                            icon: 'error',
                            confirmButtonText: 'ok',
                        })
                    }
                    
                    var storeButton = document.getElementById("storebtn");
                    storeButton.setAttribute("from", from);
                    storeButton.setAttribute("to", to);
                    storeButton.setAttribute("no", no);

                    // //console.log("success");
                    var regexFinished = document.getElementById("floatingInput").value;
                    document.getElementById("regexText").innerHTML = regexFinished;
                    document.getElementById("regexText").value = regexFinished;
                    modal.style.display = "none";
                    //console.log("this : ", this.getAttribute("lastReportID"));
                    var reportID = this.getAttribute("lastReportID");
                    //找report
                    var report = getReportBylastReportID(reportID.toString());
                    //console.log("report : ", report);

                    var inputElement = document.querySelector('#regexName');
                    emphasizeInput(inputElement);
                    var regexText = document.querySelector('#regexText');
                    emphasizeInput(regexText);
                } 
                else{
                    //console.log("fail");
                }                
            });
        });

        // append the button to the document body
        container.appendChild(button);

        // //console.log("target : ", target.innerHTML);
        // //console.log("reportID : ", $(target).parents('tr').attr("reportID"));
        // $("#storebtn").attr("lastReportID", $(target).parents('tr').attr("reportID"));
    } 

    function checkPos(startPos, endPos, extractPos){
        var poscheck = "0";
        // if (startPos >= extractPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "起始字大於萃取字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }
        // else if (startPos >= endPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "起始字大於尾字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }

        // if (endPos <= extractPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "尾字小於萃取字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }
        // else if (endPos <= startPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "尾字小於起始字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }
        return poscheck;

    }

    function checkPos1(startPos, endPos, extractPos, extractPos1){
        var poscheck = "0";
        // if (startPos >= extractPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "起始字大於萃取字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }
        // else if (startPos >= endPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "起始字大於尾字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }

        // if (endPos <= extractPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "尾字小於萃取字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }
        // else if (endPos <= startPos){
        //     Swal.fire({
        //         title: '錯誤',
        //         icon: 'error',
        //         text: "尾字小於起始字",
        //         confirmButtonText: 'ok',
        //     })
        //     poscheck = "1";
        // }

        if (extractPos == extractPos1){
            Swal.fire({
                title: '錯誤',
                icon: 'error',
                text: "兩個Extract Value不可相同",
                confirmButtonText: 'ok',
            })
            poscheck = "1";
        }
        else if (extractPos > extractPos1){
            Swal.fire({
                title: '錯誤',
                icon: 'error',
                text: "Extract Value2小於Extract Value1 或是 Extract Value1大於Extract Value2",
                confirmButtonText: 'ok',
            })
            poscheck = "1";            
        }
        return poscheck;

    }



</script>

