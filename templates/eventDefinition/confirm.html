{% load static%}

<!DOCTYPE html>
<html lang="zh-Hant" >
<head>
    <meta name="viewport" maximum-scale=1.0, user-scalable=0 content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

    <!-- CSS only -->
    <link rel="stylesheet" href="{% static 'css_js/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/font-awesome.min.css' %}">


    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap.css' %}">

    <link rel="stylesheet" href="{% static 'css_js/loaders.css-master/loaders.css' %}">
    <!-- JS, Popper.js, and jQuery -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{% static 'css_js/jquery-3.5.1.slim.min.js' %}"></script>
    <script src="{% static 'css_js/popper.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.js' %}"></script>
    <script src="{% static 'css_js/key_forbidden.js' %}"></script>
    <script src="{% static 'css_js/popper.min.js' %}"></script>
    <script src="{% static 'css_js/loaders.css-master/loaders.css.js' %}"></script>
    <title>DICOM</title>
    </head>

<style>
        /* width */
    ::-webkit-scrollbar {
      width: 10px;
    }
    
    /* Track */
    ::-webkit-scrollbar-track {
      background: #f1f1f1;

    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #888;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    body{background:url("{% static 'image/texture.png' %}");-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;overflow: hidden}
    textarea {resize: none}
    .ChartNo{display: none}
    .OrderNo{display: none}
    .eventID{display: none}
    .pdID{display: none}
    .loader{display:none;position:absolute;top:40%;left:50%}
    .ball-grid-pulse div{background-color:#000000}
    @media (min-width: 0px) {
        body{overflow-x: hidden}
        .loader2{display:none;position:absolute;top:30%;left:55%;transform: scale(2)}
        #Report td{color: whitesmoke;font-size: 16pt}
        #Report tr{padding: 0;margin: 0}
        #patient{background:url("{% static 'image/texture.png' %}");padding: 0px;margin: 0px;z-index: 1;position: absolute;top: 250px;min-width:150px;width: 200px;height:calc(100% - 250px);overflow-x: hidden;overflow-y: auto;background-color: #32435F}
        #patient table{background:url("{% static 'image/texture.png' %}");padding: 0px;margin: 0px;color:white;width: 100%;}
        input[name='confirmPID']{display: none}
        input[name='confirmPID'] +label{background:url("{% static 'image/texture.png' %}");width: calc(100% + 30px);height: 55px;padding-top: 10px;margin-bottom: -12px;margin-top: -12px;margin-left: -15px;margin-right: -15px}


        input[name='timePID']{display: none}/*radio  消失*/
        input[name='timePID'] +label{background:url("{% static 'image/texture.png' %}");width: 110%;padding-left: 12px;margin-bottom: -16px;margin-top: -8px;margin-left: -15px}/*點擊顏色變長*/
        input[name='timePID']:checked ~label{background-color: #ffdf7e;color:black;}
        
        #time td{color: black;font-family: 微軟正黑體;font-weight:bold;font-size: 12pt;color: #33333a;height: 100%}
        
        .header{font-size: 16pt;color: white;padding: 0;text-align: center}
        .edate{font-size:12pt;float: left;width: 15%;padding-left: 20px;height: auto}
        .type2{font-size:12pt;float: left;width: 15%;margin-left: 20px;height: auto}
        .note{font-size:12pt;float: left;width: 40%;padding-left: 20px;height: auto;word-break:break-all;}
        .menu{width: 20%;right:0;position:absolute;padding-top:5px}
        .add{width:calc(95%);height:20px;line-height:14px;padding:0;margin-left:0px;border-style:dashed;border-width:2px;border-radius:0}
        

        .report2{display: none}
        .Ignore{margin-left:20px;width: calc(18% + 20px);height: 100%;padding: 0}
        #text{font-size:12pt;outline:#000000 solid 1px;background:url("{% static 'image/texture.png' %}");background-color:#FFFFFF;bottom:0px;height: calc(50% - 105px);width:calc( 50% - 124px);position: absolute;left:199px ;font-size: 12pt;padding:20px}/*Report 放的框框*/
        p{height: 100%;align-items: center;vertical-align: center}
        #Disease{position: absolute;top: 55px;height: 195px;;min-width:200px;width: 200px;background-color: #11171a}
        #Disease select{width:92%;height: 40px;margin: 5px;font-size: 11pt}
        #header_date{width:18%}
        #header_note{width:60%}
        #header_confirm{}
        #extractedFactor{
            background:url("{% static 'image/texture.png' %}");
            position: absolute;
            bottom:0px;
            top:auto;
            height: calc(50% - 104px);
            width:calc( 50% - 75px);
            margin-left: 0px;
            left:calc(50% + 75px) ;
            border-radius:0px;
            font-size: 10pt;
            border:1px solid #000;
            display:inline;
            overflow-x:hidden;
        }

    }
    @media (min-width: 0px) {
        body{overflow-x: hidden}
        .loader2{display:none;position:absolute;top:50%;left:36%;transform: scale(2)}
        #Report td{color: whitesmoke;font-size: 16pt}
        #Report tr{padding: 0;margin: 0}
        #patient{background:url("{% static 'image/texture.png' %}");padding: 0px;margin: 0px;z-index: 1;position: absolute;top: 250px;min-width:150px;width: 200px;height:calc(100% - 250px);overflow-x: hidden;overflow-y: auto;background-color: #32435F}
        #patient table{background:url("{% static 'image/texture.png' %}");padding: 0px;margin: 0px;color:white;width: 100%;}
        input[name='confirmPID']{display: none}
        input[name='confirmPID'] +label{background:url("{% static 'image/texture.png' %}");width: calc(100% + 30px);height: 55px;padding-top: 10px;margin-bottom: -12px;margin-top: -12px;margin-left: -15px;margin-right: -15px;padding-left:25%}
        input[name='confirmPID']:checked ~label{background-color: #e78632;}
        input[name='timePID']{display: none}/*radio  消失*/
        input[name='timePID'] +label{background:url("{% static 'image/texture.png' %}");width: 110%;padding-left: 12px;margin-bottom: -16px;margin-top: -8px;margin-left: -15px}/*點擊顏色變長*/
        input[name='timePID']:checked ~label{background-color: #ffdf7e;color:black;}
        #timetable{position: absolute;top:125px;width: 54.5% ;left: 200px;position: absolute;height:calc(100% - 110px);overflow-y: scroll;overflow-x: hidden}
        #time td{background:url("{% static 'image/texture.png' %}");color: black;height: auto;font-family: 微軟正黑體;;font-weight:bold;font-size: 16pt;color: #33333a;vertical-align: center;align-items: center}
        #title{top:55px;height:40px;width: 54.5%;left:200px;position: absolute;background-color: #11171a;font-weight: bolder;padding-top: 10px}
        #title table{width: 100%}
        
        .header{font-size: 16pt;color: white;padding: 0;text-align: center}
        .edate{position:flex;width: 15%;padding-left: 20px;padding-top:5px;height: auto}
        .type2{position:flex;width: 25%;padding-left: 20px;padding-top:5px;height: auto}
        .note{width: 25%;margin:0px;padding-left: 20px;height: auto;font-size: 12pt;padding-top:5px}
        .eventNote{height:100%}
        .menu{width: 25%;right:0;position:absolute;padding-top:5px}
        .add{width:95%;height:20px;line-height:14px;padding:0;border-style:dashed;border-width:2px;border-radius:0}
        .menublock{width:100%}
        .phase{margin: 0;width: calc(65%);height: auto;padding-top: 0;display:inline-block;min-width:0px;padding-left:2px;padding-right:10px}
        .IntervalNo{margin: 0;top:0;width: calc(30%);padding-top: 0;display:inline-block;min-width:0px;padding-right:2px}
        .report2{display: none}
        .Ignore{margin-left:  20px;width: calc(12% + 68px);height: 100%;padding: 0}
        #text{background:url("{% static 'image/texture.png' %}");padding-left:5px;top:50%;height: calc(50%);width: calc(45.5% - 200px);position: absolute;margin-left: 0px;left:calc(54.5% + 201px) ;font-size: 12pt}/*Report 放的框框*/

        p{height: 100%;align-items: center;vertical-align: center}
        #Disease{position: absolute;top: 55px;height: 195px;width: 200px;background-color: #11171a}
        #Disease select{width: 190px;height: 40px;margin: 5px;font-size: 11pt;}
        #header_date{width:18%}
        #header_note{width:45%}
        #header_confirm{}
        #extractedFactor{
            background:url("{% static 'image/texture.png' %}");
            top:55px;
            height: calc(50% - 55px);
            width: calc(45.5% - 200px);
            position: absolute;
            margin-left: 0px;
            left:calc(54.5% + 200px) ;
            border-radius:0px;
            font-size: 10pt;
            border:1px solid #000;
            overflow-x:hidden;
            display:inline;
        }
        #extractedFactor2{
            position:absolute;
            background:url("{% static 'image/texture.png' %}");
            top:55px;
            height: calc(50% - 55px);
            width: calc(22.75% - 100px);
            position: absolute;
            margin-left: 0px;
            left:calc(77.25% + 100px) ;
            border-radius:0px;
            font-size: 10pt;
            border:1px solid #000;
            overflow-x:hidden;
            display:inline;
        }
    }
    .checkPannel{
        position:absolute;
        display:none;
        border-radius:10px;
        z-index:10;
        height:555px;
        width:400px;
        left:30%;
        top:calc(50% - 200px);
        background-color:#FFFFFF;
        border:1px solid #AAAAAA;
    }
    #processing{width:100%;height:250px;border-bottom:1px solid #AAAAAA}
    #destination{width:100%;height:250px;border-top:1px solid #AAAAAA}
    .customMenu{
        padding-bottom:5px;
        padding-left:5px;
        padding-right:5px;
        position: fixed;
        z-index: 5;
        max-height: 85vh;
        display: none;
        margin: 0;
        width: 100px;
        background-color: #FFFFFF; 
        border-radius: 5px 5px 5px 5px;
        border:1px solid #CCCCCC;
    }
    .resetbtn {
        font-size:10pt;
        margin:0;
        margin-top: 5px;
        width: 100%;
        max-height: 85vh; 
        border-radius: 5px 5px 5px 5px
    }
    .row{margin:0px}
    .col-md-6{padding:2px}
    .col-md-12{padding:2px}
    .ascriptionContentHeader{
        width:100%;
        text-align:center;
        border-bottom:1px solid #AAAAAA;
        z-index:500;
    }
    .ascriptionHeader{
        border-radius:10px 10px 0px 0px;
        width:100%;
        height:30px;
        background:url("{% static 'image/texture.png' %}");
        background-color:#000;
        text-align:center;
        line-height:30px;
        font-weight:900;
        color:#FFFFFF;
        z-index:500;
    }
    .close{position:absolute;right:5px;margin-top:3px;filter: invert(1)}
    .item{margin:2px;width:calc(100% - 4px);border:1px solid #AAAAAA;border-radius:5px;}
    .content{height:50px;text-align:center;padding-top:5px}
    #ascriptionPhase , #desPhase{height:150px;width:100%}
    #ascription select{pointer-events:none}
    .inductionEventID{display:none}
    .submit{height:20px;line-height:8px;width:calc(100% - 8px);position:absolute;bottom:5px;margin-left:4px}
    #cancerRegistCheck{width:500px}
    input[name='test']{display: none}/*radio  消失*/
    input[name='test'] +label{background:url("{% static 'image/texture.png' %}");width: 100%;}/*點擊顏色變長*/
    input[name='test']:checked ~label{background-color: #ffdf7e;color:black;}
    .accordion{left:-8px;position:absolute;width:5px;height:100%;z-index:5}
    .collapseItem{padding-left:20px;}


    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #FFFFFF; --border-radius: 10px; --formwidth: 600px; --form-mob-width: 500px; }
    #mycheckbox { position: absolute; left: -9999px; }
    .feedback-label,.form { position: fixed; top: 50%; right: 0; }
    .feedback-label { transform-origin: top right; transform:  translate(0%, -100%); z-index: 10; }
    .form {height:500px;background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--formwidth); max-height: 85vh;margin-top: 2%; transform: translate(100%, -50%); padding: 0px; overflow: auto; background-color: var(--form); z-index: 10; border-radius:10px}
    .feedback-label { border-radius: var(--border-radius); }
    .feedback-label { padding: 5px 10px; border-radius: var(--border-radius)  0 0 var(--border-radius) ; }
    .feedback-label { writing-mode: vertical-rl;background: brown; color: white; }
    .feedback-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #mycheckbox:checked + .feedback-label { background: #e78632; transform:  translate(calc((var(--formwidth) ) * -1),-100%)}
    #mycheckbox:checked ~ .form { transform: translate(0, -50%);z-index: 10;}
    .feedback-label, .form { transition: all 0.35s ease-in-out; }
    .form{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    td{padding:0px;margin:0px;font-size:10pt}
    .status{padding:0px;padding-top:5px;padding-bottom:5px}
    #statusMenu{width:150px}
    .noted{color:#FFFF00}
    .customCol{margin:0px;padding:0px;height:50px}
    
    .medType{display:none}

    #extractedFactor .ascriptionHeader{border-radius:0px;}
    #extractedFactor li{font-size:10pt}
    .factorGroupArea{height:calc(100% - 80px);overflow-y:auto;overflow-x:hidden}
    
    #extractedFactor label{padding-left:5px}
    #extractedFactor ul{margin-left: 0; padding-left: 20px;}
    .mainBlock{
        border-bottom:3px black solid;
    }
    #patientStatusCheck{width:650px}
    #statusArea table{text-align:center}
    #statusArea table th{font-size:10pt}
    #statusArea input[type="checkbox"] {
        width: 20px;
        height: 20px;
    }
    .statusFilter{color:#333;padding:0px;padding-left:2px;padding-right:2px;width:60px;height:20px;font-size:12px;background-color:#FFF}
    #statusFilterPannel{padding-left:5px}
    .exclude{color:red}
    #header_disabled{width:50px;font-size:10pt}
    #formVersion{position:absolute;top:2px;left:40%;height:26px}
    #formDisease{position:absolute;top:2px;left:0px;height:26px;font-size:5pt;padding-top:0px;padding-bottom:0px;padding-left:0px}
    #procedureOfForm{position:absolute;top:2px;left:20%;height:26px}
    .changeSeq{position:absolute;top:2px;left:60%;height:26px}
    #formVersion2{position:absolute;top:2px;left:40%;height:26px}
    #formDisease2{position:absolute;top:2px;left:0px;height:26px;font-size:5pt;padding-top:0px;padding-bottom:0px;padding-left:0px}
    #procedureOfForm2{position:absolute;top:2px;left:20%;height:26px}

    #formDesignPannel{display:none;width:1400px;background:url("{% static 'image/texture.png' %}") #08192D;left:10%;}
    .formFilter{width:calc(20% - 3.2px);display:inline;border-radius:0}
    #designArea{width:50%;height:calc(100% - 100px);background:url("{% static 'image/texture.png' %}") #FFFFFF;position:absolute;left:0px;overflow-y:scroll;overflow-x:hidden;border-right:1px solid}
    #preview{width:50%;height:calc(100% - 100px);background:url("{% static 'image/texture.png' %}") #FFF;position:absolute;right:0px;overflow-y:scroll;overflow-x:hidden}
    .designFactor{width:100%;display:inline;font-size:10pt;;margin:0px;border-radius:0}
    #designArea table{text-align:center;font-size:8pt;padding:0px;margin:0px;height:0px}
    #designArea table td{font-size:8pt;padding:0px;padding-bottom:2px;width:20px}
    #designArea table th{font-size:8pt;padding:0px;}
    .formTitle{width:calc(20% - 3.2px);text-align:center;margin:0px;background:url("{% static 'image/texture.png' %}") #ECB88A}
    .delete{margin-top:10px}
    input[name="deleteFactorRow"]{display:none}
    input[name="deletePatientDisease"]{display:none}
    .deletePatientDisease{width:20px}
    .form-control{font-size:10pt}
    #topicArea{position:absolute;top:40px;left:10px;height:500px;overflow-y:auto;display:inline}
    .hiddenRow {
        padding: 0 !important;
    }
    .hiddenRow div{
        margin-left:10px !important;
    }
    .hiddenRow div .edate{
        width:18% !important;
    }
    .hiddenRow div .note{
        width:45% !important;
    }
    .customSelect{background-image:none;width:20%;font-size:5pt;padding:0px;padding-left:5px}
    #extractedFactor2{display:none;}
    #extractedFactor2 .ascriptionHeader{border-radius:0px}
    #batchDefinite {
        display: none;
    }
    .buttonAtBottom{position:absolute;height:30px;line-height:15px;width:calc(100% - 20px);margin-left:10px;margin-top:calc(32%)}
    .event_content{height:calc(30% - 50px)}
    input[name='confirmPID']:disabled ~label{pointer-events: none;}
    .eventChecked{position:absolute;display:none;color:yellow;left:0px;z-index:10}

    #title{z-index:12}
    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #FFFFFF; --border-radius: 10px;  --form-mob-width: 500px; }
    #medtypeFilterCheckbox { position: absolute; left: -9999px; }
    #medtypeFilterForm { position: fixed;top:calc(95px - 100px);height:30px;width: 100%;left:200px;}
    #medtypeFilter-label { position: fixed; top:95px;height:30px;width: 54.5%;left:200px;}
    #medtypeFilter-label { transform-origin: top right;  z-index: 11; }
    #medtypeFilterForm {height:100px;background:url("{% static 'image/texture.png' %}");
                        border:solid 2px #44444a; 
                        width: 54.5%; 
                        max-height: 85vh;
                        padding: 0px; 
                        overflow: auto; 
                        background-color: var(--form); 
                        z-index: 11;
                        background-color:#000
                    }
    #medtypeFilter-label { padding: 5px 10px; border-radius: 0 0 var(--border-radius)  var(--border-radius) }
    #medtypeFilter-label { text-align: center;background: brown; color: white; }
    #medtypeFilter-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #medtypeFilterCheckbox:checked + #medtypeFilter-label { background: #e78632; transform:  translate(0,100px)}
    #medtypeFilterCheckbox:checked ~ #medtypeFilterForm { transform: translate(0%, 100px);z-index: 11;}
    #medtypeFilter-label, #medtypeFilterForm { transition: all 0.35s ease-in-out; }
    #medtypeFilterForm{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #medtypeFilter{padding-left:5px;padding-right:5px}

    #searchChartNoPannel{padding:5px}
</style>


<script type="text/javascript" src="{% static 'css_js/jquery-3.6.0.min.js' %}"></script>
<script >

    function setdisplay(i,zoom=0){
        let type2_height = $(`#${i}`).next('label').children('.type2').height()
        let label_height = $(`#${i}`).next('label').height()
        let note_height = $(`#${i}`).next('label').children('.note').height()
        let menu_height = $(`#${i}`).next('label').children('.menu').height()
        let date_height = $(`#${i}`).next('label').children('.edate').height()
        var numArray = [type2_height, label_height, note_height, menu_height,date_height];
        let now_maxHeight = Math.max.apply(null, numArray)
        let index = parseInt(i.split('timePID')[1])
        let oriHeight = [type2_height_array[index], label_height_array[index], note_height_array[index], menu_height_array[index],date_height_array[index]];

        let ori_maxHeight = Math.max.apply(null, oriHeight)
        let maxHeight = 0
        if(zoom==1){
            maxHeight = Math.min.apply(null, [now_maxHeight,ori_maxHeight])+5
        }else{
            maxHeight = Math.max.apply(null, [now_maxHeight,ori_maxHeight])+5
        }
        
        $(`#${i}`).next('label').css('height',0)
        $(`#${i}`).next('label').children('.accordion').css('height',0)    
        $(`#${i}`).next('label').css('height',maxHeight)
        $(`#${i}`).next('label').children('.accordion').css('height',maxHeight)    
    }
    function addPhaseAndSeq(pannel,medType,selection,seqNoOption,appendOrPrepend){
        let num = 0 
        let addObject = '<div class=menublock id="sno_-1_0_-1_0">'+
            '<select onchange="UpdateInterval()" class="IntervalNo  form-select form-select-sm" aria-label=".form-select-sm example">'+seqNoOption+'</select>'+
            '<select onchange="UpdatePhase()" class="phase form-select form-select-sm" aria-label=".form-select-sm example">'+selection+'</select>'+
            '</div>'
        if(appendOrPrepend=='append'){
            $('#'+pannel).next('label').children('.menu').append(addObject)
        }else{
            $('#'+pannel).next('label').children('.menu').children('.addButton').before(addObject)
        }
        num = $(`label[for="${pannel}"] .menu .menublock`).length-1
        $('#'+pannel).next('label').children('.menu').children('.menublock').eq(num).children('.phase').children(`:not([data-medtype=${medType}])`).remove()
        $('#'+pannel).next('label').children('.menu').children('.menublock').eq(num).children('.phase').prepend('<option value=0>請確認階段</option>')
        $('#'+pannel).next('label').children('.menu').children('.menublock').eq(num).children('.phase').children('option').eq(0).prop('selected',true)
    }

    function getClinicalProcedures(){
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getClinicalProcedures" %}', // this is the mapping between the url and view
            data:{
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            async:false,
            success:function (response){
                selection = response.selection
            }
        })
        return selection
    }

    function addMenu(){
        let id = $(event.target).parents('label').prevAll('input').attr('id')
        let medType = $(event.target).parents('.menu').prevAll('.medType').html()
        let IND = id.split('timePID')[1]
        addPhaseAndSeq(id,medType,selection,seqNoOption,'prepend')
        let target = $(`#${id}`).next('label').children('.menu').children('div')

        if("{{eventDefinition_edit}}"=='False' ){
            target.eq(target.length-2).children('.phase').prop('disabled',true)
            target.eq(target.length-2).children('.IntervalNo').prop('disabled',true)
        }else{
            target.eq(target.length-2).children('.phase').prop('disabled',false)
            target.eq(target.length-2).children('.IntervalNo').prop('disabled',false)
        }

        setdisplay(id)
        let type2_height = $(`#${id}`).next('label').children('.type2').height()-10
        let label_height = $(`#${id}`).next('label').height()-10
        let note_height = $(`#${id}`).next('label').children('.note').height()-10
        let menu_height = $(`#${id}`).next('label').children('.menu').height()-10
        let date_height = $(`#${id}`).next('label').children('.edate').height()-10

        type2_height_array[IND]=type2_height
        label_height_array[IND]=label_height
        note_height_array[IND]=note_height
        menu_height_array[IND]=menu_height
        date_height_array[IND]=date_height

    }

    function searchNote(IND,eventID){
        let chartNo= parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:searchNote" %}', // this is the mapping between the url and view
            data:{
                'chartNo':chartNo,
                'IND':IND,
                'eventID':eventID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $('#timePID'+response.IND).next('label').children('.note').html(response.object)
            }
        })
        
    }
    function searchPhaseAndInterval(i,sno){
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:searchPhaseAndInterval" %}', // this is the mapping between the url and view
            data:{
                'sno':sno,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $('#sno_'+sno).children('.eventGroup').children('option[value='+response.eventNo+']').attr('selected','selected')
                let eventNo = response.eventNo[0]

                if(eventNo!=0){
                    $.ajax({
                        type: 'post',
                        url: '{% url "eventDefinition:Phase" %}', // this is the mapping between the url and view
                        data:{
                            'eventNo':eventNo,
                            'csrfmiddlewaretoken': window.CSRF_TOKEN
                        },
                        success:function (response){
    
                            $('#sno_'+sno).children('.phase').empty()
                            $('#sno_'+sno).children('.phase').append(response.phase)
                        }
                    })
                }
                if(i==total_num-1){
                    $('#timetable').css('visibility','visible')
                    $('.loader2').css('display','none')
                }
                
            },
            complete:function(response){
                $('#sno_'+sno).children('.phase').children('option[value='+response.eventTag+']').attr('selected','selected')
                $('#sno_'+sno).children('.IntervalNo').children('option[value='+response.seqNo+']').attr('selected','selected')
                
            }
        })

    }
    function indexOfAll(array, searchItem) {
        var i = array.indexOf(searchItem),
            indexes = [];
        while (i !== -1) {
          indexes.push(i);
          i = array.indexOf(searchItem, ++i);
        }
        return indexes;
    }

    function searchRecord(IND,eventID,medType,seqNoOption,total){
        let chartNo=$('input[name="confirmPID"]:checked').attr('data-chartNo')
        let username = '{{user.username}}'
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:searchRecord" %}', // this is the mapping between the url and view
            data:{
                'IND':IND,
                'chartNo':chartNo,
                'eventID':eventID,
                'username':username,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                var eventID_search = response.eventID_F
                var eventID_table = $('#accordionExample .eventID').map(function(){return parseInt($(this).parents('label').children('.eventID').html())}).get()
                eventID_table = eventID_table.filter(function (value) {return !Number.isNaN(value);});
                var id_table = $('#accordionExample .eventID').map(function(){return $(this).parents('label').attr('for')}).get()
                for(let i =0 ;i<eventID_table.length;i++){
                    let searchIndex = indexOfAll(eventID_search,eventID_table[i])
                    
                    var id = id_table[i]
                    if(searchIndex.length != 0){
                        for(let j=0 ; j<searchIndex.length;j++){
                            //$(`#${id}`).next('label').children('.menu').children('div').remove()
                            addPhaseAndSeq(id,medType[i],selection,seqNoOption,'append')
                            let RecordedID=`sno_${response.EDID[searchIndex[j]]}_${response.eventID_F[searchIndex[j]]}_${response.PDID[searchIndex[j]]}_${response.caSeqNo[searchIndex[j]]}`
                            let n_menuBlock = $(`#${id}`).next('label').children('.menu').children('div').length-1
                            $(`#${id}`).next('label').children('.menu').children('div').eq(n_menuBlock).attr('id',RecordedID)
                            $(`#${RecordedID}`).children('.phase').children('option[value='+response.procedureID[searchIndex[j]]+']').attr('selected','selected')
                            $(`#${RecordedID}`).children('.IntervalNo').children('option[value='+response.caSeqNo[searchIndex[j]]+']').attr('selected','selected') 
                            if(response.eventID[searchIndex[j]]==null){
                                $(`#${id}`).attr('class','sno_'+response.EDID[searchIndex[j]])
                                $(`#${id}`).parent().css('background-color','#4D5139')
                                $(`#${id}`).parent().css('color','#FFFFFF')
                            }
                            if("{{eventDefinition_edit}}"=='False'){
                                $(`#${RecordedID}`).children('.phase').prop('disabled',true)
                                $(`#${RecordedID}`).children('.IntervalNo').prop('disabled',true)
                            }else if('{{user.is_superuser}}'=='True' ){
                                $(`#${RecordedID}`).children('.phase').prop('disabled',false)
                                $(`#${RecordedID}`).children('.IntervalNo').prop('disabled',false)
                            }else{
                                if(response.editor[searchIndex[j]]!=username){
                                    $(`#${RecordedID}`).children('.phase').prop('disabled',true)
                                    $(`#${RecordedID}`).children('.IntervalNo').prop('disabled',true)
                                }
                                if(response.editor[searchIndex[j]]=='NoRecord'){
                                    $(`#${RecordedID}`).children('.phase').prop('disabled',false)
                                    $(`#${RecordedID}`).children('.IntervalNo').prop('disabled',false)
                                }
                            }
                        }
                        

                    }else{
                        addPhaseAndSeq(id,medType[i],selection,seqNoOption,'append')

                    }
                    //檢查是不是癌登尚未確認的資料

                    $(`#${id}`).next('label').children('.menu').append('<div class="addButton"><button type="button" onclick="addMenu()" class="add btn btn-outline-primary">+</button></div>')
                    let type2_height = $(`#timePID${i}`).next('label').children('.type2').height()
                    let label_height = $(`#timePID${i}`).next('label').height()
                    let note_height = $(`#timePID${i}`).next('label').children('.note').height()
                    let menu_height = $(`#timePID${i}`).next('label').children('.menu').height()
                    let date_height = $(`#timePID${i}`).next('label').children('.edate').height()
                    type2_height_array.push(type2_height)
                    label_height_array.push(label_height)
                    note_height_array.push(note_height)
                    menu_height_array.push(menu_height)
                    date_height_array.push(date_height)
                    setdisplay(id)
                }
                
                $('#timetable').css('visibility','visible')
                $('.loader2').css('display','none')
                
            }
        })
        
        
    }

    function GetTimeContent(id,text){
        $('#timetable').css('visibility','hidden')
        $('.loader2').css('display','inline')
        $('.factorGroupArea').empty()
        $('.procedureOfForm').empty()
        $('.formVersion').empty()
        ascriptionClose(detect=true)
        cancerRegistCheckClose()
        patientStatusCheckClose()
        extractedFactorClose()
        batchDefiniteClose()
        seqNoOption='<option value=0>?</option>'
        let scrollTop = $('#patient').scrollTop()
        let excludeFilter = $('#excludeFilter').is(':checked')
        let data_medtype = $('.medtypeFilter').map(function(){
            if($(this).is(':checked')==false){
                return $(this).attr('data-medtype')    
            }
        }).get()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getSeqNoOption" %}', // this is the mapping between the url and view
            data:{
                'chartNo':text,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                seqNoOption+=response.seqNo
            },
            complete:function(){
                $.ajax({
                    type: 'post',
                    url: '{% url "eventDefinition:confirmpat2" %}', // this is the mapping between the url and view
                    data:{
                        'ID':text,
                        'scrollTop':scrollTop,
                        'excludeFilter':excludeFilter,
                        'medtype':data_medtype,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success:function (response){
                        $('#time').children('tbody').children('tr').remove()
                        var HeavyDisease=[30001,30002]
                        if(response.objectArray.length!=0){
                            $('#accordionExample').empty()
                            for(var i=0;i<response.objectArray.length;i++){
                                if(response.MedType[i]==30001 || response.MedType[i]==30002){
                                    $('#time').append(response.objectArray[i])
                                    $('#timePID'+i).parents('td').css('background-color', '#33333a')
                                    $('#timePID'+i).next('label').css('color', 'red')
                                    
                                }else if(response.MedType[i]==1218401){
                                    $('#time').append(response.objectArray[i])
                                    $('#timePID'+i).parents('td').css('background-color', '#aef2f1')
                                }else{
                                    $('#time').append(response.objectArray[i])
                                }

                                if (!response.eventCheckedArray[i] && typeof(response.eventCheckedArray[i])!='undefined' && response.eventCheckedArray[i]!=0){ 
                                    $('.eventChecked').eq(i).css('display','inline')
                                }

                                
                            }
                            searchRecord(i,response.eventID,response.MedType,seqNoOption,response.objectArray.length)
                            total_num = response.objectArray.length
                            var InducedEvent_ind=[]
                            var targetID = []
                            if(response.eventID_F.length!=0){
                                for(let i=0;i<response.eventID_F.length;i++){
                                    let eventIDGroup = $('#timetable .eventID').map(function(){return parseInt($(this).html())}).get()
                                    let index = eventIDGroup.indexOf(response.eventID_F[i])
                                    let target = $('#timetable .eventID').eq(index)
                                    targetID.push($('#timetable .eventID').eq(index).parents('label').prevAll('input').attr('id'))
                                    target.parents('label').append(`<div class="btn btn-primary accordion accordion-toggle" data-bs-toggle="collapse" data-bs-target="#collapse${i}" ></div>`)
                                    target.nextAll('.accordion').css('height',target.parents('label').height()+16+'px')
                                    InducedEvent_ind.push(i)
                                    
                                }

                                addInducedEvent(InducedEvent_ind,response.eventID_F,targetID)
                            }
                        }else{
                            $('#accordionExample').html('<p style="postion:absolute;width:100%;font-size: 40pt;font-weight:700;text-align: center;font-family: font-family: "LiGothic", "FangSong", Arial, serif;">查無資料</p>')
                            $('#timetable').css('visibility','visible')
                            $('#timetable').css('visibility','visible')
                            $('.loader2').css('display','none')
                            
                        }
                        $(`input[type="radio"][name="confirmPID"][id=${id}]`).prop('checked',true)
                        $('input[type="radio"][name="confirmPID"]').prop('disabled',false)
                        $('input[type="radio"][name="confirmPID"]').next('label').prop('disabled',false)

                    }
                })
                
            }
        })
        
        
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getCancerRegistData" %}', // this is the mapping between the url and view
            data:{
                'chartNo':text,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $('#cancerRegistInfo').children('tbody').empty()
                for(let i=0;i<response.PD.length;i++){
                    $('#cancerRegistInfo').children('tbody').append(`<tr><td>${response.PD[i]}</td><td>${response.chartNo[i]}</td><td>${response.disease[i]}</td><td>${response.caSeqNo[i]}</td></tr>`)
                }
            }
        })
        return true
    }

    function GetTimeByInput(){
        text = parseInt($('#searchChartNo').val())
        GetTimeContent(0,text)
    }


    function GetTime(){
        var id = $('input[type="radio"][name="confirmPID"]:checked').attr('id')

        $('input[type="radio"][name="confirmPID"]').prop('disabled',true)
        $('input[type="radio"][name="confirmPID"]').next('label').prop('disabled',true)

        text=parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        GetTimeContent(id,text)
    }

    function addInducedEvent(i,eventID,index){
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:addInducedEvent" %}', // this is the mapping between the url and view
            data:{
                'ind':i,
                'eventID':eventID,
                'index':index,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){

                for(let i=0;i<response.index_result.length;i++){
                    $(`#${response.index_result[i]}`).parents('tr').after(response.objectList[i])
                }
            }
        })
    }
    function showReport(){
        $('#text').html($('input[name=timePID]:checked').next('label').children('.report2').text())
    }
    function GetReport() {

        reporttext=$('input[name=timePID]:checked').next('label').children('.report2').text()
        if($('input[name=timePID]:checked').attr('id')!=$('input[name=timePID][data-extractFactor=1]').attr('id')){
            $('input[name=timePID]').attr('data-extractFactor',0)
        }

        $('#text').html(reporttext)
        if($('#ascription').css('display')!='none'){
            let pdID = $('input[name="timePID"]:checked').next('label').children('.pdID').html()
            let eventID = $('input[name="timePID"]:checked').next('label').children('.eventID').html()
            let ChartNo = $('input[name="timePID"]:checked').next('label').children('.ChartNo').html()
            let OrderNo = $('input[name="timePID"]:checked').next('label').children('.OrderNo').html()
            let edate = $('input[name="timePID"]:checked').next('label').children('.edate').html()
            let type2 = $('input[name="timePID"]:checked').next('label').children('.type2').html()
            let menublock = $('input[name="timePID"]:checked').next('label').children('.menu').children('.menublock')
            $('#desDate').html(edate)
            $('#desExam').html(type2)
            $('#desPhase').html(menublock.clone(true))
            $('#inductionEventID2').text(eventID)
        }
        
    }
    function UpdatePhase(){
        target=$(event.target)
        let IND = target.parents('label').prevAll('input').attr('id').split('timePID')[1]
        let EDID = target.parents('.menublock').attr('id').split('_')[1]
        let pdID = target.parents('.menublock').attr('id').split('_')[3]
        let originSeqNo = target.parents('.menublock').attr('id').split('_')[4]
        let eventID = target.parents('.menu').prevAll('.eventID').html()
        let procedureID = target.val()
        let PDIDGroup = $('#accordionExample .menublock').map(function(){return parseInt($(this).attr('id').split('_')[3])}).get()
        let chartNo = target.parents('.menu').prevAll('.ChartNo').html()
        let diseaseId = $('#ChangeDisease').val()
        let username = '{{user.username}}'
        target.css('border','none')
        if(pdID==-1){
            pdID = Math.min(...PDIDGroup.filter(PDID => PDID > 0))
            target.prevAll('.IntervalNo').val(1)
            originSeqNo = 1
        }
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updatePhase" %}', // this is the mapping between the url and view
            data:{
                'EDID':EDID,
                'PDID':pdID,
                'eventID':eventID,
                'procedureID':procedureID,
                'chartNo':chartNo,
                'diseaseId':diseaseId,
                'originSeqNo':originSeqNo,
                'username':username,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                target.prevAll('.IntervalNo').val(response.originSeqNo)
                target.parents('.menublock').attr('id',`sno_${response.sno}_${eventID}_${response.PDID}_${response.originSeqNo}`)
                let timePID = $('input[name="timePID"]:checked').next('label').children('.eventChecked')
                if(timePID.css('display')!='none'){
                    timePID.css('display','none')
                    let num = $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text().split(' ')[1].split('(')[1].split(')')[0]-1
                    let chartNo = $('input[name="confirmPID"]:checked').attr('data-chartNo')
                    $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text(`${chartNo} (${num})`)
                    $('input[name="confirmPID"]:checked').next('label').children('.ID').text(`${chartNo} (${num})`)
                }
            }
        })
    }


    function UpdateInterval(){
        target=$(event.target)
        let IND = target.parents('label').prevAll('input').attr('id').split('timePID')[1]
        let EDID = target.parents('.menublock').attr('id').split('_')[1]
        let pdID = target.parents('.menublock').attr('id').split('_')[3]
        let seqNo = target.val()
        let eventID = target.parents('.menu').prevAll('.eventID').html()
        let procedureID = target.next('.phase').val()
        let PDIDGroup = $('#accordionExample .menublock').map(function(){return parseInt($(this).attr('id').split('_')[3])}).get()
        let chartNo = target.parents('.menu').prevAll('.ChartNo').html()
        let diseaseId = $('#ChangeDisease').val()
        let username = '{{user.username}}'
        target.css('border','none')
        if(pdID==-1){
            target.next('.phase').children('option').eq(1).prop('selected',true)
            procedureID =  target.next('.phase').val()
        }
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updateInterval" %}', // this is the mapping between the url and view
            data:{
                'EDID':EDID,
                'PDID':pdID,
                'eventID':eventID,
                'procedureID':procedureID,
                'chartNo':chartNo,
                'diseaseId':diseaseId,
                'seqNo':seqNo,
                'username':username,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                target.next('.phase').val(response.procedureID)
                target.parents('.menublock').attr('id',`sno_${response.sno}_${eventID}_${response.PDID}_${response.seqNo}`)
                let timePID = $('input[name="timePID"]:checked').next('label').children('.eventChecked')
                if(timePID.css('display')!='none'){
                    timePID.css('display','none')
                    let num = $('input[name="confirmPID"]:checked').next('label').children('.eventUnCheckedNum').text().split(' ')[1].split('(')[1].split(')')[0]-1
                    let chartNo = $('input[name="confirmPID"]:checked').attr('data-chartNo')
                    $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text(`${chartNo} (${num})`)
                    $('input[name="confirmPID"]:checked').next('label').children('.ID').text(`${chartNo} (${num})`)
                }
            }
        })
    }


    function belong(){
        $('#ascription').css('display','inline')
        let inductionID = $('input[name="timePID"]:checked').attr('id')
        let pdID = $('#'+inductionID).next('label').children('.pdID').html()
        let eventID = $('#'+inductionID).next('label').children('.eventID').html()
        let ChartNo = $('#'+inductionID).next('label').children('.ChartNo').html()
        let OrderNo = $('#'+inductionID).next('label').children('.OrderNo').html()
        let edate = $('#'+inductionID).next('label').children('.edate').html()
        let type2 = $('#'+inductionID).next('label').children('.type2').html()
        let menublock = $('#'+inductionID).next('label').children('.menu').children('.menublock')
        $(`label[for=${inductionID}]`).parents('td').css('background-color','#FF0000')

        $('#inductionID').text(inductionID)
        $('#date').html(edate)
        $('#exam').html(type2)
        $('#ascriptionPhase').html(menublock.clone(true))
        $('#inductionEventID1').text(eventID)
        $("#menu").css('display', 'none');
    }
    function ascriptionClose(detect=false){
        
        if(detect==false){
            let inductionID = $('#inductionID').text()
            $(`label[for=${inductionID}]`).parents('td').css('background-color','transparent') 
        }
        $('#date').empty()
        $('#exam').empty()
        $('#ascriptionPhase').empty()
        $('#inductionEventID1').empty()
        $('#desDate').empty()
        $('#desExam').empty()
        $('#desPhase').empty()
        $('#inductionEventID2').empty()
        $("#ascription").css('display', 'none');
    }

    function statusOpen(){
        let seq = ''
        for(let i=0;i<=10;i++){seq+=`<option value=${i}>${i}</option>`}
        let chartNo=parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        let diseaseId = $('#ChangeDisease').val()
        $("#patientStatusCheck").css('display', 'inline');
        $("#statusMenu").css('display', 'none');
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getPatientStatus" %}', // this is the mapping between the url and view
            data:{
                'chartNo':chartNo,
                'diseaseId':diseaseId,
            },
            success:function (response){
                $('#statusArea tbody').empty()

                for(let i=0; i<response.PD.length; i++){
                    $('#statusArea tbody').append(`
                    <tr data-prepareAdd='true' id=${response.PD[i]}>
                        <td><select onchange="updateDiseaseAndSeq()" class="diseaseCheck form-control">${$('#ChangeDisease').html()}</select></td>
                        <td><select onchange="updateDiseaseAndSeq()" class="seqCheck form-control">${seq}</select></td>
                        <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="diagChecked" name=${response.PD[i]}></td>
                        <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="treatChecked" name=${response.PD[i]}></td>
                        <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="fuChecked" name=${response.PD[i]}></td>
                        <td><input type="checkbox" onclick="excludeCheck('statusArea');ambiguous();" class="ambiguousChecked" name=${response.PD[i]}></td>
                        <td><input type="text" class="ambiguousNote"  name=ambiguousNote_${response.PD[i]}></td>
                        <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="pdConfirmed" name=${response.PD[i]}></td>
                        <td><input type="radio" name="deletePatientDisease"><button type="button" onclick="deletelePatientDiseaseRow()" class="btn-close delete deletePatientDisease" aria-label="Close"  data-bs-toggle="modal" data-bs-target="#deletelePatientDiseaseModal"></button></td>
                    </tr>
                    `)
                    $('#statusArea .diagChecked').eq(i).prop('checked',response.diagChecked[i])
                    $('#statusArea .treatChecked').eq(i).prop('checked',response.treatChecked[i])
                    $('#statusArea .fuChecked').eq(i).prop('checked',response.fuChecked[i])
                    $('#statusArea .ambiguousChecked').eq(i).prop('checked',response.ambiguousChecked[i])
                    $('#statusArea .ambiguousNote').eq(i).val(response.ambiguousNote[i])
                    $('#statusArea .pdConfirmed').eq(i).prop('checked',response.pdConfirmed[i])
                    if(response.ambiguousChecked[i]=='true'){
                        $('#statusArea .ambiguousNote').eq(i).prop('disabled',false)
                    }else{
                        $('#statusArea .ambiguousNote').eq(i).prop('disabled',true)
                    }
                    $('#statusArea .diseaseCheck').eq(i).val(response.disease[i])
                    $('#statusArea .seqCheck').eq(i).val(response.caSeqNo[i])
                }
                $('#statusArea tbody').append('<tr><td colspan=9><div class="addButton"><button type="button" onclick="addPatientStatus()" class="add btn btn-outline-primary">+</button></div></td></tr>')
            }
        })
    }


    function addPatientStatus(){
        let chartNo = parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        let seq = ''
        for(let i=0;i<=10;i++){seq+=`<option value=${i}>${i}</option>`}
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:addPatientDiease" %}', // this is the mapping between the url and view
            data:{
                'chartNo':chartNo,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                let PD = response.PD
                $(` <tr data-prepareAdd='true' id=${PD}>
                    <td><select onchange="updateDiseaseAndSeq()" class="form-control diseaseCheck">${$('#ChangeDisease').html()}</select></td>
                    <td><select onchange="updateDiseaseAndSeq()" class="form-control seqCheck">${seq}</select></td>
                    <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="diagChecked" name=${PD}></td>
                    <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="treatChecked" name=${PD}></td>
                    <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="fuChecked" name=${PD}></td>
                    <td><input type="checkbox" onclick="excludeCheck('statusArea');ambiguous();" class="ambiguousChecked" name=${PD}></td>
                    <td><input type="text" class="ambiguousNote"  disabled></td>
                    <td><input type="checkbox" onclick="excludeCheck('statusArea')" class="pdConfirmed" name=${PD}></td>
                    <td><input type="radio" name="deletePatientDisease"><button type="button" onclick="deletelePatientDiseaseRow()" class="btn-close delete deletePatientDisease" aria-label="Close"  data-bs-toggle="modal" data-bs-target="#deletelePatientDiseaseModal"></button></td>
                </tr>
                `).insertBefore($('#statusArea .addButton').parents('tr'))
            }
        })
    }
    function updateDiseaseAndSeq(){
        let PDID = $(event.target).parents('tr').attr('id')
        let diseaseID = $(event.target).parents('tr').children('td').eq(0).children('select').val()
        let caSeqNo = $(event.target).parents('tr').children('td').eq(1).children('select').val()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updateDiseaseAndSeq" %}', // this is the mapping between the url and view
            data:{
                'PDID':PDID,
                'diseaseID':diseaseID,
                'caSeqNo':caSeqNo,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(){
                let caSeqNo = $('#statusArea .seqCheck')
                let caSeqNoObject = '<option value=0>?</option>'
                for(let i=0;i<caSeqNo.length;i++){caSeqNoObject+=`<option value=${caSeqNo.eq(i).val()}>${caSeqNo.eq(i).val()}</option>`}
                let IntervalNoObject = $('.menublock .IntervalNo')
                if(IntervalNoObject.eq(0).html!=undefined){
                    IntervalNoObject.map(function(){
                        return $(this).html(caSeqNoObject)
                    }).get()
                }
            }
        })
    }
    function ambiguous(){
        let trID = $(event.target).attr('name')
        if ($(event.target).prop('checked')==true){
            $(event.target).parent('td').next().children('.ambiguousNote').prop('disabled',false)
        }else{
            $(event.target).parent('td').next().children('.ambiguousNote').prop('disabled',true)
        }
    }
    function excludeCheck(pannel){
        let targetClass=$(event.target).attr('class').split(' ')[0]
        let targetName=$(event.target).attr('name')
        if(targetClass=='pdConfirmed'){
            $(`#${pannel} input[name="${targetName}"][class^="diagChecked"]`).prop('checked',false)
            $(`#${pannel} input[name="${targetName}"][class^="treatChecked"]`).prop('checked',false)
            $(`#${pannel} input[name="${targetName}"][class^="ambiguousChecked"]`).prop('checked',false)
            $(`#${pannel} input[name="${targetName}"][class^="fuChecked"]`).prop('checked',false)
            $(`#${pannel} input[name="ambiguousNote_${targetName}"][class="ambiguousNote"]`).prop('disabled',true)
        }else{
            $(`#${pannel} input[name="${targetName}"][class^="pdConfirmed"]`).prop('checked',false)
        }
    }
    function patientStatusCheckClose(){
        $('#statusArea .ambiguousNote').val('')
        $("#patientStatusCheck").css('display', 'none');
        
    }
    function deletelePatientDiseaseRow(){
        $(event.target).prev('input').prop('checked',true)
    }
    function deletelePatientDisease(){
        let PDID = $('input[name="deletePatientDisease"]:checked').parents('tr').attr('id')
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:deletelePatientDisease" %}', // this is the mapping between the url and view
            data:{
                'PDID':PDID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $('input[name="deletePatientDisease"]:checked').parents('tr').remove()
                let caSeqNo = $('#statusArea .seqCheck')
                let caSeqNoObject = '<option value=0>?</option>'
                for(let i=0;i<caSeqNo.length;i++){caSeqNoObject+=`<option value=${caSeqNo.eq(i).val()}>${caSeqNo.eq(i).val()}</option>`}
                let IntervalNoObject = $('.menublock .IntervalNo')
                if(IntervalNoObject.eq(0).html!=undefined){
                    IntervalNoObject.map(function(){
                        return $(this).html(caSeqNoObject)
                    }).get()
                }
            }
        })
    }
    function patientStatusSubmit(){
        var target = $('#statusArea').children('table').children('tbody').children('tr[data-prepareAdd="true"]')
        let PD = target.map(function(){return $(this).attr('id')}).get()
        let diagChecked = target.map(function(){return Number($(this).children('td').children('.diagChecked').prop('checked'))}).get()
        let treatChecked = target.map(function(){return Number($(this).children('td').children('.treatChecked').prop('checked'))}).get()
        let fuChecked = target.map(function(){return Number($(this).children('td').children('.fuChecked').prop('checked'))}).get()
        let pdConfirmed = target.map(function(){return Number($(this).children('td').children('.pdConfirmed').prop('checked'))}).get()
        let ambiguousChecked = target.map(function(){return Number($(this).children('td').children('.ambiguousChecked').prop('checked'))}).get()
        let ambiguousNote = target.map(function(){return $(this).children('td').children('.ambiguousNote').val()}).get()
        let total = $('#statusArea .diagChecked').length
        let scrollTop = $('#patient').scrollTop()
        var excludes = 1
        let checked_pdConfirmed = 0
        let checked_diagChecked = 0
        let checked_treatChecked = 0
        let checked_fuChecked = 0
        let checked_ambiguousChecked = 0
        let checked = 0
        for(let i =0;i<pdConfirmed.length;i++){checked_pdConfirmed+=pdConfirmed[i]}
        for(let i =0;i<diagChecked.length;i++){checked_diagChecked+=diagChecked[i]}
        for(let i =0;i<treatChecked.length;i++){checked_treatChecked+=treatChecked[i]}
        for(let i =0;i<fuChecked.length;i++){checked_fuChecked+=fuChecked[i]}
        for(let i =0;i<ambiguousChecked.length;i++){checked_ambiguousChecked+=ambiguousChecked[i]}
        if(checked_pdConfirmed==total||checked_diagChecked==total||checked_treatChecked==total||checked_fuChecked==total||checked_ambiguousChecked==total){
            checked=1
        }
        
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updatePatientStatus" %}', // this is the mapping between the url and view
            data:{
                'PD':PD,
                'diagChecked':diagChecked,
                'treatChecked':treatChecked,
                'fuChecked':fuChecked,
                'pdConfirmed':pdConfirmed,
                'ambiguousChecked':ambiguousChecked,
                'ambiguousNote':ambiguousNote,
                'scrollTop':scrollTop,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                if($('input[name="disappear"]').is(':checked')==0){
                    if(excludes==1){
                        $('input[name=confirmPID]:checked').next('label').css('color','red')
                    }else{
                        $('input[name=confirmPID]:checked').next('label').css('color','#FFFFFF')
                    }
                    if(checked>0){
                        $('input[name=confirmPID]:checked').next('label').css('color','#FFFFFF')
                    }else{
                        $('input[name=confirmPID]:checked').next('label').css('color','#AAA')
                    }
                }else{
                    statusFilter()
                }
                patientStatusCheckClose()
            }
        })
    }

    function extractedFactorOpen(data_form,procedureID,diseaseId,source){
        let pd = $('input[name="timePID"]:checked').next('label').children('.menu').children('.menublock').eq(0).attr('id').split('_')[3]
        let eventID = $('input[name="timePID"]:checked').next('label').children('.eventID').html()
        let medType= $('input[name="timePID"]:checked').next('label').children('.medType').html()
        let nWindow = $('#extractedFactor').attr('data-window')

        let data_extractFactor = $('input[name="timePID"]:checked').attr('data-extractFactor')
        
        $('#factorGroupArea').empty()
        $("#extractedFactor").css('display', 'inline');
        $("#menu").css('display', 'none');
        $(`#factorGroupArea${data_form} .formStructure`).remove()
        $(`#factorGroupArea${data_form}`).attr('data-eventID',eventID)
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:searchExtractedEventFactorCode" %}', // this is the mapping between the url and view
            data:{
                'pd':pd,
                'eventID':eventID,
                'medType':medType,
                'diseaseId':diseaseId,
                'procedureID':procedureID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $(`.formVersion[data-form=${data_form}]`).empty()
                for(let i=0;i<response.eventFactorCode.length;i++){
                    $(`.formVersion[data-form=${data_form}]`).append(`<option value=${response.eventFactorCode[i]}>版本${response.version[i]}</option>`)
                }
                if(source==1){
                    for(let j=response.isRecorded.length-1;j>=0;j--){
                        if(response.isRecorded[j]==1){
                            $(`.formVersion[data-form=0]`).children('option').eq(j).prop('selected',true)
                        }
                    }
                    $(`.formVersion[data-form=1]`).val($(`.formVersion[data-form=0]`).children('option:not(:selected)').eq(0).val())
                }else{
                    for(let j=response.isRecorded.length-1;j>=0;j--){
                        if(response.isRecorded[j]==1){
                            $(`.formVersion[data-form=${data_form}]`).children('option').eq(j).prop('selected',true)
                        }
                    }
                    let eventFactorCode0 = $(`.formVersion[data-form=0]`).val()
                    let eventFactorCode1 = $(`.formVersion[data-form=1]`).val()
                    if(eventFactorCode0==eventFactorCode1){
                        $(`.formVersion[data-form=${data_form}]`).val($(`.formVersion[data-form=${data_form}]`).children('option:not(:selected)').eq(0).val())
                    }
                }
                getExtractedFactorsRecordSeq(data_form)
            },
            complete:function(){
                let eventFactorCode = $(`.formVersion[data-form=${data_form}]`).val()
                if(!eventFactorCode==false){
                    formGenerator(eventID,eventFactorCode,`#factorGroupArea${data_form}`,'prepend',true,data_form)
                } 
            }
        })
        $('input[name=timePID]:checked').attr('data-extractFactor',1)
    
        
    }
        
    
    
    function changeFormbyDisease(){
        let data_form = $(event.target).attr('data-form')
        let disease = $(event.target).val()
        let procedure = $(event.target).next('.procedureOfForm').val()
        let source = 0 //0=特定的 1=全部
        
        extractedFactorOpen(data_form,procedure,disease,source)
    }

    function changeForm(){
        let data_form = $(event.target).attr('data-form')
        getExtractedFactorsRecordSeq(data_form)
        let eventID = $('input[name="timePID"]:checked').next('label').children('.eventID').html()
        $(`#factorGroupArea${data_form[0]} .formStructure`).remove()
        let eventFactorCode = $(`.formVersion[data-form=${data_form}]`).val()
        let eventFactorCode0 = $(`.formVersion[data-form=0]`).val()
        let eventFactorCode1 = $(`.formVersion[data-form=1]`).val()
        if(eventFactorCode0!=eventFactorCode1){
            formGenerator(eventID,eventFactorCode,`#factorGroupArea${data_form}`,'prepend',true,data_form)
        }
    }

    function addExtractFactorReport(){
        let form = $('input[name="extractedFactorPannel"]:checked').attr('data-windowSeq')-1
        let num = $(`.changeSeq[data-form=${form}] option`).length+1
        $(`.changeSeq[data-form=${form}]`).append(`<option value="${num}">第${num}份</option>`)
        $(`.changeSeq[data-form=${form}] option`).eq(num-1).prop('selected',true)
        changeSeq()    
    }

    function changeSeq(){
        let data_form = $('input[name="extractedFactorPannel"]:checked').attr('data-windowSeq')-1
        let eventID = $('input[name="timePID"]:checked').next('label').children('.eventID').html()
        $(`#factorGroupArea${data_form} .formStructure`).remove()
        let eventFactorCode = $(`.formVersion[data-form=${data_form}]`).val()
        let eventFactorCode0 = $(`.formVersion[data-form=0]`).val()
        let eventFactorCode1 = $(`.formVersion[data-form=1]`).val()
        if(eventFactorCode0!=eventFactorCode1){
            formGenerator(eventID,eventFactorCode,`#factorGroupArea${data_form}`,'prepend',true,data_form)
        }
    }

    function formGenerator(eventID,eventFactorCode,pannel,method,otherFunction,form){
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:formGenerator" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'eventFactorCode':eventFactorCode,
                'form':form,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                if(method=='prepend'){
                    $(pannel).prepend(response.formObject)
                }else if(method=='append'){
                    $(pannel).html(response.formObject)
                }
            },
            complete:function(){
                if(otherFunction==true){
                    searchExtractedFactorsRecord(form)
                }
            }
        })
    }

    function extractedFactorClose(){
        $('#factorGroupArea').empty()
    }

    function extractedFactorSubmit(form){
        let container = `#factorGroupArea${form}`
        let eventID = $(container).attr('data-eventID')
        //------------------------------------------------------------
        let checkboxIDArray = $(`${container} input[name^="formStructure"][type="checkbox"]:checked`).map(function(){
            return $(this).attr('data-eventFactorID')
        }).get()

        let checkboxValArray = $(`${container} input[name^="formStructure"][type="checkbox"]:checked`).map(function(){
            return $(this).prop('checked')
        }).get()

        let checkboxRecordedArray = $(`${container} input[name^="formStructure"][type="checkbox"]:checked`).map(function(){
            return $(this).attr('data-recorded')
        }).get()
        let checkboxSeqArray = $(`${container} input[name^="formStructure"][type="checkbox"]:checked`).map(function(){
            return $(this).parents('.mainBlock').attr('data-Seq')
        }).get()
        //------------------------------------------------------------
        let radioIDArray = $(`${container} input[name^="formStructure"][type="radio"][data-usage!="text"]:checked`).map(function(){
            return $(this).attr('data-eventFactorID')
        }).get()
        let radioValArray = $(`${container} input[name^="formStructure"][type="radio"][data-usage!="text"]:checked`).map(function(){
            return $(this).prop('checked')
        }).get()

        let radioRecordedArray = $(`${container} input[name^="formStructure"][type="radio"][data-usage!="text"]:checked`).map(function(){
            return $(this).attr('data-recorded')
        }).get()
        let radioSeqArray = $(`${container} input[name^="formStructure"][type="radio"][data-usage!="text"]:checked`).map(function(){
            return $(this).parents('.mainBlock').attr('data-Seq')
        }).get()
        //------------------------------------------------------------
        let textIDArray = $(`${container} input[name^="formStructure"][type="text"]`).map(function(){
            if($(this).val()!=''){return $(this).attr('data-eventFactorID')}
        }).get()
        let textValArray = $(`${container} input[name^="formStructure"][type="text"]`).map(function(){
            if($(this).val()!=''){return $(this).val()}
        }).get()

        let textRecordedArray = $(`${container} input[name^="formStructure"][type="text"]`).map(function(){
            if($(this).val()!=''){return $(this).attr('data-recorded')}
        }).get()
        let textSeqArray = $(`${container} input[name^="formStructure"][type="text"]`).map(function(){
            if($(this).val()!=''){return $(this).parents('.mainBlock').attr('data-Seq')}
        }).get()
        //------------------------------------------------------------
        let dateIDArray = $(`${container} input[name^="formStructure"][type="date"]`).map(function(){
            if($(this).val()!=''){return $(this).attr('data-eventFactorID')}
        }).get()
        let dateValArray = $(`${container} input[name^="formStructure"][type="date"]`).map(function(){
            if($(this).val()!=''){return $(this).val()}
        }).get()

        let dateRecordedArray = $(`${container} input[name^="formStructure"][type="date"]`).map(function(){
            if($(this).val()!=''){return $(this).attr('data-recorded')}
        }).get()
        let dateSeqArray = $(`${container} input[name^="formStructure"][type="date"]`).map(function(){
            if($(this).val()!=''){return $(this).parents('.mainBlock').attr('data-Seq')}
        }).get()
        let version =  $(`.formVersion[data-form=${form}]`).val()
        let procedure =  $(`.procedureOfForm[data-form=${form}]`).val()
        let insertSeq = checkboxSeqArray.concat(radioSeqArray,textSeqArray,dateSeqArray)
        let insertIDArray =  checkboxIDArray.concat(radioIDArray,textIDArray,dateIDArray)
        let insertValArray = checkboxValArray.concat(radioValArray,textValArray,dateValArray)
        let insertRecordedArray = checkboxRecordedArray.concat(radioRecordedArray,textRecordedArray,dateRecordedArray)

        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:insertExtractedFactors" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'procedure':procedure,
                'version':version,
                'insertSeq':insertSeq,
                'insertIDArray':insertIDArray,
                'insertValArray':insertValArray,

                'insertRecordedArray':insertRecordedArray,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(){
                
                Swal.fire({
                    title: '',
                    html: '儲存成功',
                    icon: 'success',
                    timer: 1000,
                    showConfirmButton: false,
                    timerProgressBar: true,
                })
            }
        })
    
    }

    function searchExtractedFactorsRecord(form){

        let container = `#factorGroupArea${form}`
        
        //------------------------------------------------------------
        let checkboxIDArray = $('input[name^="formStructure"][type="checkbox"]').map(function(){
            return $(this).attr('data-eventFactorID')
        }).get()
        let checkboxSeqArray = $('input[name^="formStructure"][type="checkbox"]').map(function(){
            return $(this).parents('.mainBlock').attr('data-Seq')
        }).get()
        let checkboxClassArray = $('input[name^="formStructure"][type="checkbox"]').map(function(){
            return $(this).parents('.mainBlock').attr('class').split(' ')[1]
        }).get()

        //------------------------------------------------------------
        let radioIDArray = $('input[name^="formStructure"][type="radio"][data-usage!="text"]').map(function(){
            return $(this).attr('data-eventFactorID')
        }).get()
        let radioSeqArray = $('input[name^="formStructure"][type="radio"][data-usage!="text"]').map(function(){
            return $(this).parents('.mainBlock').attr('data-Seq')
        }).get()
        let radioClassArray = $('input[name^="formStructure"][type="radio"][data-usage!="text"]').map(function(){
            return $(this).parents('.mainBlock').attr('class').split(' ')[1]
        }).get()

        //------------------------------------------------------------
        let textIDArray = $('input[name^="formStructure"][type="text"]').map(function(){
            return $(this).attr('data-eventFactorID')
        }).get()
        let textSeqArray = $('input[name^="formStructure"][type="text"]').map(function(){
            return $(this).parents('.mainBlock').attr('data-Seq')
        }).get()
        let textClassArray = $('input[name^="formStructure"][type="text"]').map(function(){
            return $(this).parents('.mainBlock').attr('class').split(' ')[1]
        }).get()
        //------------------------------------------------------------
        let dateIDArray = $('input[name^="formStructure"][type="date"]').map(function(){
            return $(this).attr('data-eventFactorID')
        }).get()
        let dateSeqArray = $('input[name^="formStructure"][type="date"]').map(function(){
            return $(this).parents('.mainBlock').attr('data-Seq')
        }).get()
        let dateClassArray = $('input[name^="formStructure"][type="date"]').map(function(){
            return $(this).parents('.mainBlock').attr('class').split(' ')[1]
        }).get()

        let eventID = $(container).attr('data-eventID')
        let procedure =  $(`.procedureOfForm[data-form=${form}]`).val()
        let seqArray = checkboxSeqArray.concat(radioSeqArray,textSeqArray,dateSeqArray)
        let diseaseId = $(`.ChangeDisease[data-form=${form}]`).val()
        let idArray =  checkboxIDArray.concat(radioIDArray,textIDArray,dateIDArray)
        let classArray =  checkboxClassArray.concat(radioClassArray,textClassArray,dateClassArray)

        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:searchExtractedFactorsRecord" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'diseaseId':diseaseId,
                'procedure':procedure,
                'seq':seqArray,
                'idArray':idArray,
                'classArray':classArray,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                
                for(let i=0; i<response.seqRecorded.length; i++){
                    console.log(`.${response.classRecorded[i]}[data-Seq=${response.seqRecorded[i]}] [data-eventFactorID=${response.factorIdRecorded[i]}]`)
                    let targetObject = $(`.${response.classRecorded[i]}[data-Seq=${response.seqRecorded[i]}] [data-eventFactorID=${response.factorIdRecorded[i]}]`)
                    let type = targetObject.attr('type')
                    if (type=='text'||type=='date'){
                        targetObject.val(response.factorValueRecorded[i])
                    }else{
                        
                        targetObject.prop('checked',response.factorValueRecorded[i])
                    }
                    targetObject.attr('data-recorded',1)
                }
            }
        })
    }

    function getExtractedFactorsRecordSeq(form){
        let container = `#factorGroupArea${form}`
        let eventID = $(container).attr('data-eventID')
        let procedure =  $(`.procedureOfForm[data-form=${form}]`).val()
        let eventFactorCode = $(`.formVersion[data-form=${form}]`).val()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getExtractedFactorsRecordSeq" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'procedureID':procedure,
                'eventFactorCode':eventFactorCode,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                $(`.changeSeq[data-form=${form}]`).empty()
                $(`.changeSeq[data-form=${form}]`).append(`<option value="1">第1份</option>`)
                for(let i=1;i<response.seq.length;i++){
                    $(`.changeSeq[data-form=${form}]`).append(`<option value="${response.seq[i]}">第${response.seq[i]}份</option>`)
                }
            }
        })
    }

    function cancerRegistCheck(){
        $('#checkArea').empty()
        let cloneObject = $('.'+$('input[name="timePID"]:checked').attr('class'))
        for(let i=0; i<cloneObject.length; i++){
            $('#checkArea').append(cloneObject.eq(i).parent().clone(true))
            $('#checkArea input').attr('name','test')
            $('#checkArea .note').remove()
            $('#checkArea .addButton').remove()
            $('#checkArea div').css('width','165px')
            $('#checkArea td').css('height','70px')
            $('#checkArea label').css('height','70px')
            $('#checkArea label').css('width','498px')
            $('#checkArea label').css('margin-left','-12px')
            $('#checkArea label').css('margin-top','0px')
            $('#checkArea .IntervalNo').css('width','55px')
            $('#checkArea .IntervalNo').css('margin','0px')
            $('#checkArea select').css('pointer-events','none')
        }
        $("#cancerRegistCheck").css('display', 'inline');
        $("#menu").css('display', 'none');
    }

    function cancerRegistCheckClose(){
        $('#checkArea').empty()
        $("#cancerRegistCheck").css('display', 'none');
    }

    function cancerRegistSubmit(){
        let eventID = $('input[name="test"]:checked').next('label').children('.eventID').html().replaceAll(' ','')
        let EDID = $('input[name="test"]:checked').attr('class').split('sno_')[1]

        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updateCancerRegist" %}', // this is the mapping between the url and view
            data:{
                'EDID':EDID,
                'eventID':eventID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(){
                $('#timetable #'+$('input[name="test"]').eq(i).attr('id')).next('label').children()
                let timePID = $('input[name="timePID"]:checked').next('label').children('.eventChecked')
                if(timePID.css('display')!='none'){
                    timePID.css('display','none')
                    let num = $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text().split(' ')[1].split('(')[1].split(')')[0]-1
                    let chartNo = $('input[name="confirmPID"]:checked').attr('data-chartNo')
                    $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text(`${chartNo} (${num})`)
                    $('input[name="confirmPID"]:checked').next('label').children('.ID').text(`${chartNo} (${num})`)
                }
                cancerRegistCheckClose()
            }
        })

        for(let i=0; i<$('input[name="test"]:not(:checked)').length; i++){
            let ob ='#sno_'+EDID+'_'+$('input[name="test"]:not(:checked)').eq(i).next('label').children('.eventID').html().replaceAll(' ','')
            let notCheckedId = $('input[name="test"]:not(:checked)').eq(i).attr('id')
            if($(`#timetable #${notCheckedId}`).next('label').children('.menu').children('.menublock').length==1){
                $(`#timetable #${notCheckedId}`).next('label').children('.menu').children(ob).children('.IntervalNo').val(1)
                $(`#timetable #${notCheckedId}`).next('label').children('.menu').children(ob).children('.phase').val(0)
            }else{
                $(`#timetable #${notCheckedId}`).next('label').children('.menu').children(ob).remove()
            }
        }
        for(let i=0; i<$('input[name="test"]').length; i++){
            let id = $('input[name="test"]').eq(i).attr('id')
            $(`#timetable #${id}`).parent('td').css('background-color','transparent')
            $(`#timetable #${id}`).parent('td').css('color','#000000')
            setdisplay(id)
        }
    }

    function ascriptionSubmit(){
        let eventID_F = $('#inductionEventID2').text()
        let eventID = $('#inductionEventID1').text()

        if(eventID_F!=''){ //沒歸屬偵測
            $.ajax({
                type: 'post',
                url: '{% url "eventDefinition:updateInducedEvent" %}', // this is the mapping between the url and view
                data:{
                    'eventID_F':eventID_F,
                    'eventID':eventID,
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
                success:function(){
                    
                    let eventIDGroup = $('#timetable .eventID').map(function(){return parseInt($(this).html())}).get()
                    let index = eventIDGroup.indexOf(parseInt(eventID_F))
                    let index_origin = eventIDGroup.indexOf(parseInt(eventID))
                    let target = $('#timetable .eventID').eq(index)
                    let origin = $('#timetable .eventID').eq(index_origin)
                    let num = 0
                    if($('.accordion').length==0){
                        num = 0
                    }else{
                        num = $('.accordion').length+1
                    } 
                    let targetID = $('#timetable .eventID').eq(index).parents('label').prevAll('input').attr('id')

                    if(target.nextAll('.accordion').length==0){
                        target.parents('label').append(`<div class="btn btn-primary accordion" data-bs-toggle="collapse" data-bs-target="#collapse${num}" ></div>`)
                        target.nextAll('.accordion').css('height',target.parents('label').height()+'px')
                    }else{
                        num = parseInt(target.nextAll('.accordion').attr('data-bs-target').split('#collapse')[1])
                    }

                    

                    $(`.collapse${num}`).parents('tr').remove()

                    origin.parents('tr').remove()
                    addInducedEvent([num],[eventID_F],[targetID])
                },
                complete:function(){
                    let timePID = $('input[name="timePID"]:checked').next('label').children('.eventChecked')
                    if(timePID.css('display')!='none'){
                        timePID.css('display','none')
                        let num = $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text().split(' ')[1].split('(')[1].split(')')[0]-1
                        let chartNo = $('input[name="confirmPID"]:checked').attr('data-chartNo')
                        $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text(`${chartNo} (${num})`)
                        $('input[name="confirmPID"]:checked').next('label').children('.ID').text(`${chartNo} (${num})`)
                    }
                    ascriptionClose()
                }
            })
        }
    }

    function deleteEvent_F(){
        let eventID = $(event.target).prevAll('.eventID').html()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:deleteEvent_F" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(){
                GetTime()
            }
        })
    }

    function getNum(){
        let disease = $('#ChangeDisease').val()
        let diagChecked=Number($('#statusFilterPannel .diagChecked').prop('checked'))
        let treatChecked=Number($('#statusFilterPannel .treatChecked').prop('checked'))
        let fuChecked=Number($('#statusFilterPannel .fuChecked').prop('checked'))
        let ambiguousChecked=Number($('#statusFilterPannel .ambiguousChecked').prop('checked'))
        let pdConfirmed=Number($('#statusFilterPannel .pdConfirmed').prop('checked'))
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getNum" %}', // this is the mapping between the url and view
            data:{
                'disease':disease,
                'diagChecked':diagChecked,
                'treatChecked':treatChecked,
                'fuChecked':fuChecked,
                'ambiguousChecked':ambiguousChecked,
                'pdConfirmed':pdConfirmed,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                let str=['全部']
                $('#filter').children('option').eq(0).html(`${str[0]}(${response.num[0]})`)
            }
        })
    }

    function move(id){
        var move=false;//移動標記  
        var height = $(window).height()-$(`#${id}`).height();
        var width = $(window).width()-$(`#${id}`).width();
        var _x,_y;//左上角位置 
            $(`#${id} .ascriptionHeader`).mousedown(function(e){  
                move=true;  
                _x=e.pageX-parseInt($(`#${id}`).css("left"));  
                _y=e.pageY-parseInt($(`#${id}`).css("top")); 
            });  
            $(document).mousemove(function(e){  
                if(move){  
                    var x=e.pageX-_x;
                    var y=e.pageY-_y; 
                    if(x>=0 && y>=50 && x<=width && y<=height){
                        $(`#${id}`).css({"top":y,"left":x}); 
                        $(`#${id}`).css({"z-index":2000});
                    }

                }  
            }).mouseup(function(){  
                $(`#${id}`).css({"z-index":1030});
                move=false;
        });
    }
    function  myFunction(){
        if($(event.target).attr('data-checked')==0){
            $(event.target).attr('data-checked','1')
        }else{
            $(event.target).attr('data-checked','0')
            $(event.target).prop('checked',false)
        }
        $('input[name^="formStructure[1]"][type="radio"]:not(:checked)').each(function(){
            $(this).attr('data-checked','0')
        })
    }

    function addMainBlock(){

        $('#extraFactorMenu').css('display','none')
        var object = $('[data-prepareAdd=1]').clone()
        var objectHTML = object.html()
        var cloneObject = object.find('input[name^="formStructure"]')

        var indexArray = $('input[name^="formStructure"]').map(function(){return parseInt($(this).attr('name').split('_')[1].replaceAll('[','').replaceAll(']',''))}).get()
        var idArray = $('input[name^="formStructure"]').map(function(){return parseInt($(this).attr('id').split('_')[1])}).get()

        var maxIndex = Math.max.apply(Math,indexArray)+1 
        var maxID = Math.max.apply(Math,idArray)
        var names = cloneObject.map(function(){return $(this).attr('name')}).get()

        var id = cloneObject.map(function(){return $(this).attr('id')}).get()
        var subjectID = $('[data-prepareAdd=1]').attr('class').split(' ')[1]
        var dataSeq = Math.max.apply(Math,$(`.${subjectID}`).map(function(){return $(this).attr('data-Seq')}).get())+1 

        for(let i=0;i<names.length;i++){
            var newElement = names[i].split('_')
            var newID = id[i].split('_')
            maxID +=1
            objectHTML = objectHTML.replaceAll(names[i],newElement[0]+`_[${maxIndex}]_`+newElement[2])
            objectHTML = objectHTML.replaceAll(id[i],newID[0]+`_${maxID}`)
        }

        newObject=`<div data-prepareAdd=0 onmousedown="record()" class="mainBlock ${subjectID}" data-Seq=${dataSeq}>`
        newObject+=objectHTML
        newObject+='</div>'
        let className = $('[data-prepareAdd=1]').attr('class').split(' ')[1]
        var dataSeq = Math.max.apply(Math,$(`.${className}`).map(function(){return $(this).attr('data-Seq')}).get())
        $(newObject).insertAfter(`.${className}[data-seq=${dataSeq}]`)
        
    }

    function record(){
        $('.mainBlock').attr('data-prepareAdd',0)
        $(event.target).children().parents('.mainBlock').attr('data-prepareAdd',1)
        $(event.target).parents('.mainBlock').attr('data-prepareAdd',1)
    }

    function menu(pannel,menu,useRadio=true){
        var window_height = $(window).height()
        var window_width = $(window).width()
        if(useRadio){
            $(`#${pannel}`).on('mousedown','td',function(d){
                $(this).children('input[type="radio"]').prop('checked',true)
                showReport()
                if(d.which == 3){  // 1 = 滑鼠左鍵; 2 = 滑鼠中鍵; 3 = 滑鼠右鍵
                    var x = d.originalEvent.x || d.originalEvent.layerX || 0;
                    var y = d.originalEvent.y || d.originalEvent.layerY || 0;
                    let menu_height = parseInt($(`#${menu}`).css('height').split('px')[0])
                    let menu_width = parseInt($(`#${menu}`).css('width').split('px')[0])
                    if((menu_width+x)>window_width){
                        $(`#${menu}`).css('left', x - menu_width)
                    }else{
                        $(`#${menu}`).css('left', x);
                    }
                    if((menu_height+y)>window_height){
                        $(`#${menu}`).css('top', y-menu_height)
                    }else{
                        $(`#${menu}`).css('top', y);
                    }
                    
                    $(".customMenu").css('display', 'none');
                    $(".customMenu").css('z-index', '100');
                    $(`#${menu}`).css('display', 'inline');
                }else if(d.which == 1){
                    $(".customMenu").css('display', 'none');
                }
                if(menu=="menu"){
                    if($('input[name="timePID"]:checked').attr('data-eventCheck')=='True'){
                        $(`#${menu}`).children('#disableEvent').attr('data-eventCheck','0');
                        $(`#${menu}`).children('#disableEvent').html('disabled')
                    }else{
                        $(`#${menu}`).children('#disableEvent').attr('data-eventCheck','1');
                        $(`#${menu}`).children('#disableEvent').html('undisabled')
                    }
                }
                if(menu=="statusMenu"){
                    if($('input[name="confirmPID"]:checked').attr('data-isDone')=='1'){
                        $(`#isDone`).html('標記未完成');
                    }else{
                        $(`#isDone`).html('標記已完成');
                    }
                }

            })
        }else{
            $(`#${pannel}`).on('mousedown',function(d){
                if(d.which == 3){  // 1 = 滑鼠左鍵; 2 = 滑鼠中鍵; 3 = 滑鼠右鍵
                    var x = d.originalEvent.x || d.originalEvent.layerX || 0;
                    var y = d.originalEvent.y || d.originalEvent.layerY || 0;
                    let menu_height = parseInt($(`#${menu}`).css('height').split('px')[0])
                    let menu_width = parseInt($(`#${menu}`).css('width').split('px')[0])
                    if((menu_width+x)>window_width){
                        $(`#${menu}`).css('left', x - menu_width)
                    }else{
                        $(`#${menu}`).css('left', x);
                    }
                    if((menu_height+y)>window_height){
                        $(`#${menu}`).css('top', y-menu_height)
                    }else{
                        $(`#${menu}`).css('top', y);
                    }
                    $(".customMenu").css('display', 'none');
                    $(".customMenu").css('z-index', '10000');
                    $(`#${menu}`).css('display', 'inline');
                }else if(d.which == 1){
                    $(".customMenu").css('display', 'none');
                }

                if(menu=='extractFactorMenu'){
                    $(this).parent('label').prev('input').prop('checked',true)
                }
            })
        }
    }

    function statusFilter(){
        $('#Report').empty()
        //let name = $(event.target).attr('name')
        let diagChecked=Number($('#statusFilterPannel .diagChecked').prop('checked'))
        let treatChecked=Number($('#statusFilterPannel .treatChecked').prop('checked'))
        let fuChecked=Number($('#statusFilterPannel .fuChecked').prop('checked'))
        let ambiguousChecked=Number($('#statusFilterPannel .ambiguousChecked').prop('checked'))
        let pdConfirmed=Number($('#statusFilterPannel .pdConfirmed').prop('checked'))
        var disease = $('#ChangeDisease').val()
        let filter = $('#filter').val()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:confirmpat" %}', // this is the mapping between the url and view
            data:{
                'filter':filter,
                'Disease':disease,
                'diagChecked':diagChecked,
                'treatChecked':treatChecked,
                'fuChecked':fuChecked,
                'ambiguousChecked':ambiguousChecked,
                'pdConfirmed':pdConfirmed,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $('#Report').append(response.examID) 
                $('#patient').scrollTop(parseInt(response.scrollTop)*1.8616427135304192)
                
                $('input[name="confirmPID"]').map(function(){
                    if($(this).attr('data-isDone')=="1"){
                        $(this).next('label').css('color','white')
                    }else{
                        $(this).next('label').css('color','white')
                    }
                })
            },
            complete:function(){
                if("{{de_identification}}"=='False'){
                    $('.ID').css('display','none')
                    $('.PatientListID').css('display','inline')
                }else{
                    $('.ID').css('display','inline')
                    $('.PatientListID').css('display','none')
                }
                $('.loader1').css('display','none')
                $('.PatientListID[data-checked=0]').parents('label').css('color','#AAA')
                getNum()
            }
        })
        
    }

    function excludeFilterFuncrion(){
        if($('#excludeFilter').is(':checked')==true){
            $('.medtypeFilter').prop('disabled',true)
        }else{
            $('.medtypeFilter').prop('disabled',false)
        }
        GetTime()
    }

    function disableEvent(){
        let eventID = $('input[name=timePID]:checked').next('label').children('.eventID').html()
        let disable = $(event.target).attr('data-eventCheck')
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updateEventConfirm" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'disable':disable,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(){
                let excludeFilter = $('#excludeFilter').is(':checked')
                if(excludeFilter==false){
                    $('input[name=timePID]:checked').parents('tr').remove()
                }
                if(disable=='1'){
                    $('input[name=timePID]:checked').parents('td').css('background-color','transparent')
                }
                $('#menu').css('display','none')
            }
        })
    }
    function searchForm(pannel,bool){
        let code = $(`#${pannel} [name="formFilter"]`).map(function(){return $(this).val()}).get()
        
        if(code.includes('')==false){
            console.log(bool==true)
            if(bool==true){
                $('#designArea tbody').empty()
                $('#preview').empty()
            }
            $.ajax({
                type: 'post',
                url: '{% url "eventDefinition:searchEventFactorCode" %}', // this is the mapping between the url and view
                data:{
                    'groupNo':code[0],
                    'diseaseID':code[1],
                    'procedureID':code[2],
                    'version':code[3],
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
                success:function(response){
                    $(`#${pannel} input[list="eventFactorCode"]`).val(response.eventFactorCode)
                    if(bool==true){
                        formGenerator(-999999,response.eventFactorCode,'#preview','append',false)
                        getFromStructure(response.eventFactorCode)
                    }
                }
            })
        }else{
            if(bool==true){
                $('#designArea tbody').empty()
                $('#preview').empty()
            }
        }
    }
    function getFromStructure(eventFactorCode){
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getFromStructure" %}', // this is the mapping between the url and view
            data:{
                'eventFactorCode':eventFactorCode,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){

                $('#designArea tbody').empty()
                let object = ''
                for(let i=0;i<response.eventFactorID.length;i++){
                    object += '<tr>'
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor eventFactorID" value="${response.eventFactorID[i]}"></td>`
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor serialNo" value="${response.serialNo[i]}"></td>`
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor factorName" value="${response.factorName[i]}"></td>`
                    object += `<td><select onchange="updateStructure()" class="form-control designFactor itemType" ><option value="NE">NE</option><option value="text">text</option><option value="radio">radio</option><option value="checkbox">checkbox</option><option value="date">date</option></select></td>`
                    object += `<td><select onchange="updateStructure()" class="form-control designFactor labeled" ><option value="true">true</option><option value="false">false</option></select></td>`
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor F_eventFactorID" value="${response.F_eventFactorID[i]}"></td>`
                    object += `<td><select onchange="updateStructure()" class="form-control designFactor isLeaf" ><option value="true">true</option><option value="false">false</option></select></td>`
                    object += `<td><input type="radio" name="deleteFactorRow"><button type="button" onclick="deleteFactorRow()" class="btn-close delete" aria-label="Close"  data-bs-toggle="modal" data-bs-target="#deleteleModal"></button></td>`
                    object += '</tr>'
                }
                object += '<tr><td colspan=8><div class="addButton"><button type="button" onclick="addFactor()" class="add btn btn-outline-primary">+</button></div></td></tr>'
                $('#designArea tbody').html(object)
                for(let j=0;j<response.isLeaf.length;j++){$('.isLeaf').eq(j).val(response.isLeaf[j].toString().replaceAll(' ',''))}
                for(let j=0;j<response.labeled.length;j++){$('.labeled').eq(j).val(response.labeled[j].toString().replaceAll(' ',''))}
                for(let j=0;j<response.itemType.length;j++){$('.itemType').eq(j).val(response.itemType[j].toString().replaceAll(' ',''))}
            }
        })
    }
    function deleteFactor(){
        $('input[name="deleteFactorRow"]:checked').parents('tr').remove()
        updateStructure()
    }
    function deleteFactorRow(){
        $(event.target).prev('input').prop('checked',true)
    }
    function updateStructure(){
        let code = $('.formFilter').map(function(){return $(this).val()}).get()
        let eventFactorID = $('#designArea .eventFactorID').map(function(){return $(this).val()}).get()
        let eventFactorCode = $('#formFilter input[list="eventFactorCode"]').val()
        let serialNo = $('#designArea .serialNo').map(function(){return $(this).val()}).get()
        let factorName = $('#designArea .factorName').map(function(){return $(this).val()}).get()
        let itemType = $('#designArea .itemType').map(function(){return $(this).val()}).get()
        let labeled = $('#designArea .labeled').map(function(){return $(this).val()}).get()
        let F_eventFactorID = $('#designArea .F_eventFactorID').map(function(){return $(this).val()}).get()
        let isLeaf = $('#designArea .isLeaf').map(function(){return $(this).val()}).get()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updateFromStructure" %}', // this is the mapping between the url and view
            data:{
                'code':code,
                'eventFactorID':eventFactorID,
                'eventFactorCode':eventFactorCode,
                'serialNo':serialNo,
                'factorName':factorName,
                'itemType':itemType,
                'labeled':labeled,
                'F_eventFactorID':F_eventFactorID,
                'isLeaf':isLeaf,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                formGenerator(-999999,code[0],'#preview','append',false)
            }
        })
    }
    function addFactor(){
        let code = $('.formFilter').map(function(){return $(this).val()}).get()
        let object = ''
        let target = $(event.target)
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getNewEventFactorID" %}', // this is the mapping between the url and view
            data:{
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                if(code.includes('')==false){
                    object += '<tr>'
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor eventFactorID" value="${response.newEventFactorID}"></td>`
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor serialNo" value=""></td>`
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor factorName" value=""></td>`
                    object += `<td><select onchange="updateStructure()" class="form-control designFactor itemType" ><option value="NE">NE</option><option value="text">text</option><option value="radio">radio</option><option value="checkbox">checkbox</option><option value="date">date</option></select></td>`
                    object += `<td><select onchange="updateStructure()" class="form-control designFactor labeled" ><option value="true">true</option><option value="false">false</option></select></td>`
                    object += `<td><input onchange="updateStructure()" type='text' class="form-control designFactor F_eventFactorID" value=""></td>`
                    object += `<td><select onchange="updateStructure()" class="form-control designFactor isLeaf" ><option value="true">true</option><option value="false">false</option></select></td>`
                    object += `<td><input type="radio" name="deleteFactorRow"><button type="button" onclick="deleteFactorRow()" class="btn-close delete" aria-label="Close"  data-bs-toggle="modal" data-bs-target="#deleteleModal"></button></td>`
                    object += '</tr>'
                    target.parents('tr').before(object)
                    updateStructure()
                }
            }
        })
    }
    function addGenerateValue(plane,response){
        $(`#${plane} #eventFactorCode`).empty()
        $(`#${plane} #groupNo`).empty()
        $(`#${plane} #diseaseID`).empty()
        $(`#${plane} #procedureID`).empty()
        $(`#${plane} #version`).empty()
        $(`#${plane} #groupNo`).append('<option value="">請選擇</option>')
        $(`#${plane} #diseaseID`).append('<option value="">請選擇</option>')
        $(`#${plane} #procedureID`).append('<option value="">請選擇</option>')
        for(let i=0;i<response.eventFactorCode.length;i++){$(`#${plane} #eventFactorCode`).append(`<option value="${response.eventFactorCode[i]}">`)}
        for(let i=0;i<response.groupNo.length;i++){$(`#${plane} #groupNo`).append(`<option value="${response.groupNo[i]}">${response.groupName[i]}</option>`)}
        for(let i=0;i<response.diseaseID.length;i++){$(`#${plane} #diseaseID`).append(`<option value="${response.diseaseID[i]}">${response.disease[i].replaceAll(' ','')}</option>`)}
        for(let i=0;i<response.procedureID.length;i++){$(`#${plane} #procedureID`).append(`<option value="${response.procedureID[i]}">${response.procedureName[i].replaceAll(' ','')}</option>`)}
        for(let i=0;i<response.version.length;i++){$(`#${plane} #version`).append(`<option value="${response.version[i]}">`)}
    }
    function formDesign(){
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getEventFactorCode" %}', // this is the mapping between the url and view
            data:{
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                //formGenerator(-999999,code[0],'#preview','append','')
                addGenerateValue('formFilter',response)
                addGenerateValue('formGeneratorMenu',response)
            }
        })
        $("#formDesignPannel").css('display', 'inline');
        $("#menu").css('display', 'none');
        $("#statusMenu").css('display', 'none');
    }
    function formDesignClose(){
        $(".formFilter").val('')
        $("#preview").empty()
        $("#designArea tbody").empty()
        $("#formDesignPannel").css('display', 'none');
    }

    function updateEventNote(){
        let eventID = $(event.target).parent('.note').prevAll('.eventID').html()
        let note = $(event.target).val()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:updateEventNote" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'note':note,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            }
        })
    }

    function emptyAll(){
        let seq = $('input[name="extractedFactorPannel"]:checked').attr('data-windowSeq')
        $(`#factorGroupArea${seq-1} .formStructure`).find('input[type="checkbox"]').prop('checked',false)
        $(`#factorGroupArea${seq-1} .formStructure`).find('input[type="radio"]').prop('checked',false)
        $(`#factorGroupArea${seq-1} .formStructure`).find('input[type="text"]').val('')
        $(`#extractFactorMenu`).css('display','none')
    }

    function isDone(){
        let chartNo = parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        let isDone = $('input[name="confirmPID"]:checked').attr('data-isDone')
        if(isDone=="1"){
            $('input[name="confirmPID"]:checked').attr('data-isDone','0')
            $('input[name="confirmPID"]:checked').next('label').css('color','red')
        }else{
            $('input[name="confirmPID"]:checked').attr('data-isDone','1')
            $('input[name="confirmPID"]:checked').next('label').css('color','white')
        }
        isDone = $('input[name="confirmPID"]:checked').attr('data-isDone')
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:isDone" %}', // this is the mapping between the url and view
            data:{
                'isDone':isDone,
                'chartNo':chartNo,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                $('#statusMenu').css('display','none')
            }
        })
    }

    function getCurrentEventProcedure(){

        let optionName = $('input[name="timePID"]:checked').next('label').children('.menu').children('.menublock').map(function(){return $(this).children('.phase').children('option:checked').html()}).get()
        let optionValue = $('input[name="timePID"]:checked').next('label').children('.menu').children('.menublock').map(function(){return $(this).children('.phase').children('option:checked').val()}).get()
        $('.procedureOfForm').empty()

        $('.procedureOfForm').map(function(){
            for(let i=0;i<optionName.length;i++){
                $(this).append(`<option data-seq=${i+1} value=${optionValue[i]}>${i+1}.${optionName[i]}</option>`)
            }  
        },optionName,optionValue)

        let procedureID = $('.procedureOfForm').map(function(){return $(this).val()}).get()
        let diseaseId = $('.formDisease').map(function(){return $(this).val()}).get()
        let data_form = [0,1]
        let source = 0 //0=特定的 1=全部
        let window = $('#extractedFactor').attr('data-window')
        if(window==1){
            data_form = [0]
        }else{
            data_form = [0,1]
        }
        for(let j=0;j<data_form.length;j++){
            
            extractedFactorOpen(data_form[j],procedureID[j],diseaseId[j],source);
        }
        
    }   

    function procedureOfForm(){
        let data_form = [$(event.target).attr('data-form')]
        let procedure = $(event.target).val()
        let disease = $(event.target).prev('.formDisease').val()
        let source = 0 //0=特定的 1=全部
        extractedFactorOpen(data_form,procedure,disease,source)
    }

    function addTopicFormOpen(){
        let disease = $('#ChangeDisease').val()
        $('#addTopicForm').css('display','inline')
        $('#statusMenu').css('display','none')
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getTopic" %}', // this is the mapping between the url and view
            data:{
                'disease':disease,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                $('#topicArea').empty()
                for(let i=0;i<response.topic.length;i++){
                    $('#topicArea').append(`
                        <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="topic" data-Annotated=0 data-topicNo="${response.topicNo[i]}" data-diseaseID="${response.diseaseID[i]}" id="topic_${response.topicNo[i]}">
                        <label class="form-check-label" for="topic_${response.topicNo[i]}">${response.topic[i]}</label>
                        </div>
                        `)
                }
            },
            complete:function(){
                addTopicFormRecord()
            }
        })
    }
    function addTopicFormRecord(){
        let chartNo = parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getTopicRecord" %}', // this is the mapping between the url and view
            data:{
                'chartNo':chartNo,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                $('input[name="topic"]').prop('checked',false)
                for(let i=0;i<response.topicNo.length;i++){
                    $(`input[name="topic"][data-topicNo="${response.topicNo[i]}"]`).prop('checked',true)
                    $(`input[name="topic"][data-topicNo="${response.topicNo[i]}"]`).attr('data-Annotated',1)
                }
            }
        })
    }

    
    function addTopicFormClose(){
        $('#addTopicForm').css('display','none')
    }

    function addTopicFormSubmit(){
        let chartNo = parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))

        let topicNo = $(`input[name="topic"]`).map(function(){
            return $(this).attr('data-topicNo')
        }).get()
        let diseaseID = $(`input[name="topic"]`).map(function(){
            return $(this).attr('data-diseaseID')
        }).get()
        let annotated = $(`input[name="topic"]`).map(function(){
            return $(this).attr('data-Annotated')
        }).get()
        let checked = $(`input[name="topic"]`).map(function(){
            return Number($(this).is(':checked'))
        }).get()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:processCorrelationPatientListAndAnnotation" %}', // this is the mapping between the url and view
            data:{
                'chartNo':chartNo,
                'topicNo':topicNo,
                'diseaseID':diseaseID,
                'annotated':annotated,
                'checked':checked,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                addTopicFormClose()
                Swal.fire({
                    title: '',
                    html: '儲存成功',
                    icon: 'success',
                    timer: 1000,
                    showConfirmButton: false,
                    timerProgressBar: true,
                })
            }
        })
    }

    function getTopicPatientNum(){
        let disease = $('#ChangeDisease').val()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getTopicPatientNum" %}', // this is the mapping between the url and view
            data:{
                'disease':disease,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $('#filter option:not(:first-child)').remove()
                for(var i=0;i<response.topic.length;i++){
                    $('#filter').append(`<option value=${response.topicNo[i]}>${response.topic[i]}(${response.num[i]})</option>`)
                }
            }
        })
    }

    function onewindow(){
        let width = $('#extractedFactor').width()
        let nWindow = $('#extractedFactor').attr('data-window')
        let select = $('#extractedFactor .ascriptionHeader .form-select').map(function(){return $(this).css('width')}).get()
        if(nWindow==2){
            $('#extractedFactor').css('width',`calc(45.5% - 200px)`)
            $('#extractedFactor').attr('data-window',1)
            
        }
        $('#extractedFactor2').css('display','none')
        $('#extractFactorMenu').css('display','none')
        $('#extractedFactor2 .formVersion').empty()
        if($('input[name="timePID"]').is(':checked')){
            getCurrentEventProcedure()
        }
        
    }

    function twowindow(){
        let width = $('#extractedFactor').width()
        let nWindow = $('#extractedFactor').attr('data-window')
        let select = $('#extractedFactor .ascriptionHeader .form-select').map(function(){return $(this).css('width')}).get()
        let half = 45.5/2 

        if(nWindow==1){
            $('#extractedFactor').css('width',`calc(${half}% - 100px)`)
            $('#extractedFactor').attr('data-window',2)
            
        }
        $('#extractedFactor2').css('display','inline')
        $('#extractFactorMenu').css('display','none')
        if($('input[name="timePID"]').is(':checked')){
            getCurrentEventProcedure()
        }
    }

    function addTTP(){
        let eventID = $('input[name=timePID]:checked').next('label').children('.eventID').html()
        let diseaseID = $('#ChangeDisease').val()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:addTTP" %}', // this is the mapping between the url and view
            data:{
                'eventID':eventID,
                'diseaseID':diseaseID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                GetTime()
            }
        })
    }

    function batchDefiniteClose(){
        $('#batchDefinite').css('display','none')
    }

    function batchDefiniteOpen(){
        $('#batchDefinite').css('display','inline')
        $('#menu').css('display','none')
        $('#event_setting').html($('.IntervalNo').eq(0).clone())
        $('#event_setting .IntervalNo option').eq(0).remove()
        $('#event_setting .IntervalNo').attr('onchange','')
        $('#event_setting .IntervalNo').attr('class','form-select seq')
        $('#event_setting').append(`<select class="form-select therapy">
            <option value="defineDefinitiveRT">DefinitiveRT</option>
            <option value="defineDefinitiveCCRT">DefinitiveCCRT</option>
            <option value="defineAdjuvantChemotherapy">AdjuvantChemotherapy</option>
            <option value="defineNeoadjuvantCCRT">NeoadjuvantCCRT</option>
            <option value="defineInductionChemotherapy">InductionChemotherapy</option>
        </select>`)
    }

    function batchDefinite(pannel){
        let target = $('input[name="timePID"]:checked').next('label')
        let eventID = target.children('.eventID').html()
        let edate = target.children('.edate').html()
        let type2 = target.children('.type2').html()
        let IND = target.attr('for').split('timePID')[1]
        $(`#${pannel} .event_content`).html(`
        <table class="table">
            <tr><td>eventID</td><td class="batchDefiniteEventID">${eventID}</td></tr>
            <tr><td>Date</td><td>${edate}</td></tr>
            <tr><td>Exam</td><td>${type2}</td></tr>
            <tr style="display:none"><td>IND</td><td class="batchDefiniteIND">${IND}</td></tr>
        </table>
        `)
    }

    function batchDefiniteSubmit(){
        let startTherapy = $('#event_start .event_content .batchDefiniteEventID').html()
        let endTherapy = $('#event_end .event_content .batchDefiniteEventID').html()
        let seqNo =  $('#event_setting .seq').val()
        let therapy = $('#event_setting .therapy').val()
        let chartNo = parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        let startTherapyIND = $('#event_start .event_content .batchDefiniteIND').html()
        let endTherapyIND = $('#event_end .event_content .batchDefiniteIND').html()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:batchDefinite" %}', // this is the mapping between the url and view
            data:{
                'startTherapy':startTherapy,
                'endTherapy':endTherapy,
                'seqNo':seqNo,
                'therapy':therapy,
                'chartNo':chartNo,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                let total = $('#accordionExample tr').length
                var eventID = []
                var medType = []
                for(let ind =startTherapyIND;ind<=endTherapyIND;ind++){
                    eventID.push($(`label[for="timePID${ind}"] .eventID`).html())
                    medType.push($(`label[for="timePID${ind}"] .medType`).html())
                }
                searchRecord(ind,eventID,medType,seqNoOption,total)
            }
        })
    }

    function confirmDone(){
        let eventIDArray = $('input[name="timePID"]').next('label').children('.eventID').map(function(){return $(this).html()}).get()
        $.ajax({
            type: 'post',
            url: '{% url "warehousing_eventDefinitions:confirmDone" %}', // this is the mapping between the url and view
            data:{
                'eventIDArray':eventIDArray,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },success:function (response){
                $('#menu').css('display','none')
                $('.eventChecked').css('display','none')
                let num = 0
                let chartNo = $('input[name="confirmPID"]:checked').attr('data-chartNo')
                $('input[name="confirmPID"]:checked').next('label').children('.PatientListID').text(`${chartNo} (${num})`)
                $('input[name="confirmPID"]:checked').next('label').children('.ID').text(`${chartNo} (${num})`)
            }
        })
    }

    function filter(){
        let data_medtype = $('.medtypeFilter').map(function(){
            if($(this).is(':checked')==false){
                return $(this).attr('data-medtype')    
            }
        }).get()
        GetTime()
    }
    function releaseDisabled(){
        $('#excludeFilter').prop('disabled',false)
        $('.medtypeFilter').prop('disabled',false)
    }

    function getMedtype(){
        let chartNo = parseInt($('input[name="confirmPID"]:checked').attr('data-chartNo'))
        $('#medtypeFilter').empty()
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getMedtype" %}', // this is the mapping between the url and view
            data:{
                'chartNo':chartNo,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                $('#medtypeFilter').append(`<label style="color:white;margin-right:10px"><input type="checkbox" id="excludeFilter" onclick="excludeFilterFuncrion()">全部</label>`)
                for(let i=0;i<response.medtype.length;i++){
                    $('#medtypeFilter').append(`<label style="color:white;margin-right:10px"><input type="checkbox" 
                        onclick="filter()" class="medtypeFilter" data-medtype="${response.medtype[i]}" checked>
                        ${response.typename[i]}</label>`)
                }
            }
        })
    }

    function copyForm(){
        let code = $('.formFilterMenu').map(function(){return $(this).val()}).get()
        let eventFactorCode_ori = $('#formFilter input[list="eventFactorCode"]').val()
        let eventFactorCode = $('#formGeneratorMenu input[list="eventFactorCode"]').val()
        let eventFactorID = $('.form-control.designFactor.eventFactorID').map(function(){return $(this).val()}).get()
        let serialNo = $('.form-control.designFactor.serialNo').map(function(){return $(this).val()}).get()
        let factorName = $('.form-control.designFactor.factorName').map(function(){return $(this).val()}).get()
        let itemType = $('.form-control.designFactor.itemType').map(function(){return $(this).val()}).get()
        let labeled = $('.form-control.designFactor.labeled').map(function(){return $(this).val()}).get()
        let F_eventFactorID = $('.form-control.designFactor.F_eventFactorID').map(function(){return $(this).val()}).get()
        let isLeaf = $('.form-control.designFactor.isLeaf').map(function(){return $(this).val()}).get()
        console.log(eventFactorID.length)
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:getNewEventFactorID" %}', // this is the mapping between the url and view
            data:{
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                let copyFactor=[]
                let num = eventFactorID.length
                let tatal = response.newEventFactorID+num
                for(let i=response.newEventFactorID;i<tatal;i++){
                    copyFactor.push(i.toString())
                }
                uniqueF_eventFactorID = F_eventFactorID.filter(function (value,index,self) { return self.indexOf(value) == index; })
                for(j=0;j<uniqueF_eventFactorID.length;j++){
                    let index_eventFactorID = eventFactorID.indexOf(uniqueF_eventFactorID[j])
                    let index_F_eventFactorID = indexOfAll(F_eventFactorID,uniqueF_eventFactorID[j])
                    if(index_eventFactorID!=-1){
                        for(k=0;k<index_F_eventFactorID.length;k++){
                            F_eventFactorID[index_F_eventFactorID[k]] = copyFactor[index_eventFactorID]
                        }
                    }
                }

                if(eventFactorCode_ori!=eventFactorCode){
                    $.ajax({
                        type: 'post',
                        url: '{% url "eventDefinition:deleteExtractedFactor" %}', // this is the mapping between the url and view
                        data:{
                            'eventFactorCode':eventFactorCode,
                            'csrfmiddlewaretoken': window.CSRF_TOKEN
                        },
                    })
                    $.ajax({
                        type: 'post',
                        url: '{% url "eventDefinition:updateFromStructure" %}', // this is the mapping between the url and view
                        data:{
                            'code':code,
                            'eventFactorID':copyFactor,
                            'eventFactorCode':eventFactorCode,
                            'serialNo':serialNo,
                            'factorName':factorName,
                            'itemType':itemType,
                            'labeled':labeled,
                            'F_eventFactorID':F_eventFactorID,
                            'isLeaf':isLeaf,
                            'csrfmiddlewaretoken': window.CSRF_TOKEN
                        },
                        success:function (response){
                            $('#formGeneratorMenu').css('display','none')
                            Swal.fire({
                                title: '',
                                html: '複製成功',
                                icon: 'success',
                                timer: 1000,
                                showConfirmButton: false,
                                timerProgressBar: true,
                            })
                        }
                    })
                }else{
                    Swal.fire({
                        title: '',
                        html: '無法複製(同一份表格)',
                        icon: 'success',
                        timer: 1000,
                        showConfirmButton: false,
                        timerProgressBar: true,
                    })
                }
                
            }
        })
        
    }
    $(document).ready(function (e) {
        selection = getClinicalProcedures()
        $('#defaultMenuBlock1').get(0).oncontextmenu = function() {
            return false
        };

        $('#defaultMenuBlock2','body').get(0).oncontextmenu = function() {
            return false
        };
        //右鍵選單
        menu('defaultMenuBlock1','statusMenu')
        menu('defaultMenuBlock2','menu')
        menu('extractedFactor','extractFactorMenu',false)
        menu('extractedFactor2','extractFactorMenu',false)
        menu('preview','formGeneratorMenu',false)
        move('ascription')
        move('cancerRegistCheck')
        move('patientStatusCheck')
        move('addTopicForm')
        move('formDesignPannel')
        move('batchDefinite')
        


        $('.loader1').css('display','inline')
        $.ajax({
            type: 'post',
            url: '{% url "eventDefinition:Disease" %}', // this is the mapping between the url and view
            data:{
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                for(var i=0;i<response.DiseaseNo.length;i++){
                    $('#Disease').children('#ChangeDisease').append(`<option value=${response.DiseaseNo[i]}>${response.Disease[i]}</option>`)
                    $('.formDisease').append(`<option value=${response.DiseaseNo[i]}>${response.Disease[i]}</option>`)
                }
            },
            complete:function (){
                statusFilter()
                getTopicPatientNum()
            }
        })
        
        $('#ChangeDisease').on('change',function (){
            ascriptionClose(detect=true)
            cancerRegistCheckClose()
            patientStatusCheckClose()
            extractedFactorClose()
            addTopicFormClose()
            batchDefiniteClose()
            $('#accordionExample').empty()
            let filter = $('#filter').val()
            let disease = $('#ChangeDisease').val()
            $('.formDisease').val(disease)
            $('.factorGroupArea').empty()
            $('.procedureOfForm').empty()
            $('.formVersion').empty()
            $('#Report').empty()
            statusFilter()
            getTopicPatientNum()
            $('#statusFilterPannel').css('display','inline')
        })
        $('#filter').on('change',function (){
            ascriptionClose(detect=true)
            cancerRegistCheckClose()
            patientStatusCheckClose()
            extractedFactorClose()
            addTopicFormClose()
            batchDefiniteClose()
            $('#accordionExample').empty()
            let filter = $('#filter').val()
            let disease = $('#ChangeDisease').val()
            $('#Report').empty()
            statusFilter()
            if(filter!=0){
                $('#statusFilterPannel').css('display','none')
            }else{
                $('#statusFilterPannel').css('display','inline')
            }
        })
        $( window ).resize(function() {
            let timePID = $('input[name="timePID"]').map(function(){return $(this).attr('id')}).get()
            let zoom = 0
            if($( window ).width()>size){
                zoom = 1
            }else{
                zoom = 0
            }
            for(let i=0;i<timePID.length;i++){
                setdisplay(timePID[i],zoom)
            }
            size = $( window ).width()
        });
        type2_height_array=[]
        label_height_array=[]
        note_height_array=[]
        menu_height_array=[]
        date_height_array=[]
        size = $( window ).width()


    })

//-------------------------------定位功能------------------------------------
</script>

<body >
{{ user.username|json_script:"user_username" }}
{{ user.last_name|json_script:"hospital" }}
{% include 'navBar.html' %}



    
    <div id="Disease" >
        <select class="form-select" aria-label="Default select example" id="ChangeDisease"></select>
        <select class="form-select" aria-label="Default select example" id="filter">
            <option value=0>全部</option>
        </select>
        <div id="statusFilterPannel">
            <input type="checkbox" id="statusFilter1" onclick="statusFilter();excludeCheck('statusFilterPannel');" class="diagChecked btn-check" name="disappear"><label class="btn btn-outline-warning statusFilter" for="statusFilter1">Diag</label>
            <input type="checkbox" id="statusFilter2" onclick="statusFilter();excludeCheck('statusFilterPannel');" class="treatChecked btn-check" name="disappear"><label class="btn btn-outline-warning statusFilter" for="statusFilter2">Treat</label>
            <input type="checkbox" id="statusFilter5" onclick="statusFilter();excludeCheck('statusFilterPannel');" class="fuChecked btn-check" name="disappear"><label class="btn btn-outline-warning statusFilter" for="statusFilter5">F/U</label>
            <input type="checkbox" id="statusFilter4" onclick="statusFilter();excludeCheck('statusFilterPannel');" class="ambiguousChecked btn-check" name="disappear"><label class="btn btn-outline-warning statusFilter" for="statusFilter4">Ambiguous</label>
            <input type="checkbox" id="statusFilter6" onclick="statusFilter();excludeCheck('statusFilterPannel');" class="pdConfirmed btn-check" name="disappear"><label class="btn btn-outline-warning statusFilter" for="statusFilter6">Exclude</label>
        </div>            
        <div id="searchChartNoPannel">
            <input type="text" class="form-control" placeholder="輸入病歷號" id="searchChartNo" onchange="GetTimeByInput()">
        </div>
    </div>
    <div id='defaultMenuBlock1'>  
        <div id="patient">
            <div class="loader loader1">
                <div class="loader-inner pacman">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
                <span class="tooltip">
                    <p>載入中，請稍後‧‧‧</p>
                </span>
            </div>
            <table class="table table-striped" id="Report"></table>
        </div>
    </div>
    <div id='defaultMenuBlock2'>  
        <div id="title">
            <table  class="thead-dark">
                <thead>
                    <tr>
                        <th class="header" id ="header_date">日期</th>
                        <th class="header" id ="header_exam">檢查項目</th>
                        <th class="header" id ="header_note">註記</th>
                        <th class="header" id ="header_confirm">確認階段</th>
                    </tr>
                </thead>

            </table>
        </div>


        <div id="medtypeFilterTable">
            <input type="checkbox" id="medtypeFilterCheckbox">
            <label for="medtypeFilterCheckbox" id="medtypeFilter-label">設定</label>
            <form class="" id="medtypeFilterForm">
                <div id = "medtypeFilter">
                
                </div>
            </form>
        </div>

        <div class="loader loader2">
            <div class="loader-inner ball-grid-pulse">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <span class="tooltip">
                <p>載入中，請稍後‧‧‧</p>
            </span>
        </div>


        <div id="timetable">
            <table class="table   table-hover" id="time">
                <tbody id="accordionExample"></tbody>
            </table>
        </div>



        <div class="checkPannel" id="ascription">
            <div class="ascriptionHeader">
                歸納
                <button type="button" class="btn-close close" aria-label="Close" onclick="ascriptionClose()"></button>
            </div>
            <div id="processing"  class="row">
                <div class="col-md-6 ">
                    <div class="item">
                        <div class="ascriptionContentHeader">日期</div>
                        <div class="content" id="date">a</div>
                    </div>
                </div>
                <div class="col-md-6 ">
                    <div class="item">
                        <div class="ascriptionContentHeader">項目</div>
                        <div class="content" id="exam"></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="item">
                        <div class="content" id="ascriptionPhase"></div>
                    </div>
                </div>
                <p class="inductionEventID" id="inductionEventID1"></p>
                <p class="inductionEventID" id="inductionID"></p>
            </div>
            <div id="destination" class="row">
                <div class="col-md-6 ">
                    <div class="item">
                        <div class="ascriptionContentHeader">日期</div>
                        <div class="content" id="desDate">a</div>
                    </div>
                </div>
                <div class="col-md-6 ">
                    <div class="item">
                        <div class="ascriptionContentHeader">項目</div>
                        <div class="content" id="desExam"></div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="item">
                        <div class="content" id="desPhase"></div>
                    </div>
                </div>
                <p class="inductionEventID" id="inductionEventID2"></p>
            </div>
            <button type="submit" class="btn btn-primary submit"  onclick="ascriptionSubmit()">Submit</button>
        </div>


        <div class="checkPannel" id="cancerRegistCheck">
            <div class="ascriptionHeader">
                癌登資料確認
                <button type="button" class="btn-close close" aria-label="Close" onclick="cancerRegistCheckClose()"></button>
            </div>
            <div id="checkArea"  class="row">
                
            </div>
            <button type="submit" class="btn btn-primary submit"  onclick="cancerRegistSubmit()">Submit</button>
        </div>

        <div class="checkPannel" id="addTopicForm">
            <div class="ascriptionHeader">
                研究主題
                <button type="button" class="btn-close close" aria-label="Close" onclick="addTopicFormClose()"></button>
            </div>
            <div id="topicArea"  class="row">
                
            </div>
            <button type="submit" class="btn btn-primary submit"  onclick="addTopicFormSubmit()">Submit</button>
        </div>       


        <div id="statusMenu" class="customMenu">
            <p class="btn btn-secondary resetbtn status" role="button" onclick="statusOpen()">病患資料確認</p>
            <p class="btn btn-secondary resetbtn" role="button"  onclick="formDesign()">表單設計</p>
            <p class="btn btn-secondary resetbtn" role="button" data-isDone="1" id="isDone"  onclick="isDone()">標記已完成</p>
            <p class="btn btn-secondary resetbtn" role="button"  onclick="addTopicFormOpen()">加入研究主題</p>
        </div>

        <div id="menu" class="customMenu">
            <p class="btn btn-secondary resetbtn" id="belong" role="button" onclick="belong()">歸屬</p>
            <!--<p class="btn btn-secondary resetbtn" id="CR_check" role="button" onclick="cancerRegistCheck()">癌登確認</p>-->
            <p class="btn btn-secondary resetbtn" id="extract" role="button" onclick="extractedFactorOpen()">報告萃取</p>
            <p class="btn btn-secondary resetbtn" id="disableEvent" role="button" data-eventCheck=1 onclick="disableEvent()">disabled</p>
            <p class="btn btn-secondary resetbtn" id="formDesign" role="button"  onclick="formDesign()">表單設計</p>
            {% if user.is_superuser %}
            <p class="btn btn-secondary resetbtn" id="formDesign" role="button"  onclick="addTTP()"  aria-label="Close" data-bs-toggle="modal" data-bs-target="#addTTPModal">add TTP</p>
            {% endif %}
            <p class="btn btn-secondary resetbtn" id="formDesign" role="button"  onclick="batchDefiniteOpen()">批次定義</p>
            <p class="btn btn-secondary resetbtn" id="formDesign" role="button"  onclick="confirmDone()">一鍵確認</p>
        </div>

        <div id="extractFactorMenu" class="customMenu">
            <p class="btn btn-secondary resetbtn" id="emptyAll" role="button" onclick="emptyAll()">全部清空</p>
            <p class="btn btn-secondary resetbtn" id="1window" role="button" onclick="onewindow()">單視窗</p>
            <p class="btn btn-secondary resetbtn" id="2window" role="button" onclick="twowindow()">雙視窗</p>
            <p class="btn btn-secondary resetbtn" id="addExtractFactorReport" role="button" onclick="addMainBlock()">新增報告</p>
        </div>

        <div id="formGeneratorMenu" class="customMenu">
            <input placeholder="eventFactorCode"  autocomplete=on  class="form-control formFilterMenu resetbtn" list="eventFactorCode" disabled>
            <datalist id="eventFactorCode"></datalist>
            <select onchange="searchForm('formGeneratorMenu',false)" name="formFilter" class="form-control formFilterMenu" id="groupNo"></select>
            <select onchange="searchForm('formGeneratorMenu',false)" name="formFilter" class="form-control formFilterMenu" id="diseaseID"></select>
            <select onchange="searchForm('formGeneratorMenu',false)" name="formFilter" class="form-control formFilterMenu" id="procedureID"></select>
            <input placeholder="version" onchange="searchForm('formGeneratorMenu',false)" name="formFilter" autocomplete=on class="form-control formFilterMenu" list="version">
            <datalist id="version"></datalist>
            <p onclick="copyForm()" class="btn btn-secondary resetbtn">複製<p>
        </div>

        <input type='radio' id='extractedFactorPannel_1' name='extractedFactorPannel' data-windowSeq=1>
        <label for='extractedFactorPannel_1'>
            <div class="checkPannel" id="extractedFactor" data-window=1 data-windowSeq=1>
                <div class="ascriptionHeader">
                    報告萃取
                    <select class="form-select form-select-sm customSelect formDisease" aria-label="Default select example" onchange="changeFormbyDisease()" id="formDisease" data-form=0></select>
                    <select class="form-select form-select-sm customSelect procedureOfForm" onchange="procedureOfForm()" id="procedureOfForm" data-form=0></select>
                    <select class="form-select form-select-sm customSelect formVersion" onchange="changeForm()" id="formVersion" data-form=0></select>    
                    <!-- <select class="form-select form-select-sm customSelect changeSeq" onchange="changeSeq()"  data-form=0></select>-->
                </div>
                <div id="factorGroupArea0"  class="row factorGroupArea"></div>
                <button type="submit" class="btn btn-primary submit" onclick="extractedFactorSubmit(0)">Submit</button>
            </div>
        </label>
        <input type='radio' id='extractedFactorPannel_2' name='extractedFactorPannel' data-windowSeq=2>
        <label for='extractedFactorPannel_2'>
        <div class="checkPannel" id="extractedFactor2" data-windowSeq=2>
                <div class="ascriptionHeader">
                    報告萃取
                    <select class="form-select form-select-sm customSelect formDisease" aria-label="Default select example" onchange="changeFormbyDisease()" id="formDisease2" data-form=1></select>
                    <select class="form-select form-select-sm customSelect procedureOfForm" onchange="procedureOfForm()" id="procedureOfForm2" data-form=1></select>
                    <select class="form-select form-select-sm customSelect formVersion" onchange="changeForm()" id="formVersion2" data-form=1></select>
                    <!-- <select class="form-select form-select-sm customSelect changeSeq" onchange="changeSeq()"  data-form=1></select>-->
                </div>
                <div id="factorGroupArea1"  class="row factorGroupArea"></div>
                <button type="submit" class="btn btn-primary submit" onclick="extractedFactorSubmit(1)">Submit</button>
            </div>
        </label>
        <div class="checkPannel" id="formDesignPannel">
            <div class="ascriptionHeader">
                表單設計
                <button type="button" class="btn-close close" aria-label="Close" onclick="formDesignClose()"></button>
            </div>
            <div id="formTitle">
                <label class="formTitle form-label">eventFactorCode</label>
                <label class="formTitle form-label">groupNo</label>
                <label class="formTitle form-label">diseaseID</label>
                <label class="formTitle form-label">procedureID</label>
                <label class="formTitle form-label">version</label>
            </div>
            <div id="formFilter">
                <input placeholder="eventFactorCode"  autocomplete=on  class="formFilter form-control" list="eventFactorCode" disabled>
                <datalist id="eventFactorCode"></datalist>
                <select onchange="searchForm('formFilter',true)" name="formFilter" class="formFilter form-control" id="groupNo"></select>
                <select onchange="searchForm('formFilter',true)" name="formFilter" class="formFilter form-control" id="diseaseID"></select>
                <select onchange="searchForm('formFilter',true)" name="formFilter" class="formFilter form-control" id="procedureID"></select>
                <input placeholder="version" onchange="searchForm('formFilter',true)" name="formFilter" autocomplete=on class="formFilter form-control" list="version">
                <datalist id="version"></datalist>
            </div>
            <div id="designArea"  class="row">
                <table class='table table-striped'>
                    <thead>
                        <th>eventFactorID</th>
                        <th>serialNo</th>
                        <th>factorName</th>
                        <th>itemType</th>
                        <th>labeled</th>
                        <th>F_eventFactorID</th>
                        <th>isLeaf</th>
                        <th>刪除</th>
                    </thead>
                    <tbody>
                        <tr><td colspan=8><div class="addButton"><button type="button" onclick="addFactor()" class="add btn btn-outline-primary">+</button></div></td></tr>
                    </tbody>
                </table>

            </div>
            <div id="preview"  class="row">
                
            </div>
        </div>

        
        <div class="checkPannel" id="batchDefinite">
            <div class="ascriptionHeader">
                batchDefinite
                <button type="button" class="btn-close close" aria-label="Close" onclick="batchDefiniteClose()"></button>
            </div>
            <div id="event_start"   style="height:30%;background-color:#999">
                <div class="event_content"></div>
                <button type="button" class="btn btn-warning buttonAtBottom" onclick="batchDefinite('event_start')">設定</button>
            </div>
            <div id="event_end"   style="height:30%;background-color:#DDD">
                <div class="event_content"></div>
                <button type="button" class="btn btn-warning buttonAtBottom" onclick="batchDefinite('event_end')">設定</button>
            </div>
            <div id="event_setting"   style="height:30%;background-color:#AAA">
                
            </div>
            <button type="submit" class="btn btn-primary submit"  onclick="batchDefiniteSubmit()">Submit</button>
        </div>
    </div>    

    <div id="slideout">
        <input type="checkbox" id="mycheckbox">
        <label for="mycheckbox" class="feedback-label">癌登資料</label>
        <form class="form sc2">
            <table class="table table-striped table-hover" id="cancerRegistInfo" >
                <thead>
                    <tr>
                        <th>疾病</th><th>序列</th><th>日期</th><th>項目</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </form>
    </div>
    
    <div class="modal fade" id="deletelePatientDiseaseModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="InsertMessage" class="modal-body">
                    確定要刪除?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="delete" onclick="deletelePatientDisease()">刪除</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="InsertMessage" class="modal-body">
                    確定要刪除?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="delete" onclick="deleteFactor()">刪除</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addTTPModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">TTP</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="InsertMessage" class="modal-body">
                    確定要新增?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="addTTP()">確定</button>
                </div>
            </div>
        </div>
    </div>
    <div class="checkPannel" id="patientStatusCheck">
        <div class="ascriptionHeader">
            病患資料確認
            <button type="button" class="btn-close close" aria-label="Close" onclick="patientStatusCheckClose()"></button>
        </div>
        <div id="statusArea"  class="row">
              <table class="table table-striped table-hover" >
                <thead>
                    <tr>
                        <th>Disease</th><th>SeqNo</th><th>Diag</th><th>Treat</th><th>F/U</th><th>Ambiguous</th><th>AmbiguousNote</th><th>Exclude</th><th>刪除</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>
        <button type="submit" class="btn btn-primary submit" onclick="patientStatusSubmit()">Submit</button>
    </div>

    <textarea id="text" readonly>

    </textarea>
    
</body>
</html>



